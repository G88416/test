<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Comprehensive HRMS - Bophelong Community Centre</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7fa; color: #333; }
        .sidebar { background-color: #ffffff; border-right: 1px solid #dee2e6; height: 100vh; position: fixed; width: 250px; padding: 20px; overflow-y: auto; transition: width 0.3s ease; z-index: 1000; }
        .sidebar.collapsed { width: 60px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link { color: #495057; font-weight: 500; margin-bottom: 10px; padding: 10px; transition: all 0.2s; }
        .sidebar .nav-link:hover { color: #0d6efd; background-color: #f8f9fa; border-radius: 5px; }
        .sidebar .nav-link.active { color: #0d6efd; background-color: #e7f1ff; border-radius: 5px; }
        .content { margin-left: 250px; padding: 40px; transition: margin-left 0.3s ease; }
        .content.expanded { margin-left: 60px; }
        .card-metric { background-color: #ffffff; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 10px; transition: transform 0.2s; }
        .card-metric:hover { transform: translateY(-5px); }
        .table { background-color: #ffffff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; }
        .modal-content { border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        #dashboardChart { max-height: 400px; }
        .section { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .search-input { max-width: 300px; }
        .btn-toggle-sidebar { position: fixed; top: 20px; left: 260px; z-index: 1001; transition: left 0.3s ease; }
        .btn-toggle-sidebar.expanded { left: 70px; }
        #pdfViewer { height: 500px; width: 100%; border: 1px solid #ddd; }
        #previewTable { max-height: 400px; overflow-y: auto; }
        .compliance-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .checklist-item { display: flex; align-items: center; }
        .checklist-item input[type="checkbox"]:checked + label { text-decoration: line-through; }
        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .content { margin-left: 60px; }
            .btn-toggle-sidebar { left: 70px; }
            .sidebar .nav-text { display: none; }
        }

        /* Dark Mode Styles */
        .dark-mode { background-color: #121212; color: #e0e0e0; }
        .dark-mode .sidebar { background-color: #1e1e1e; border-right: 1px solid #333; }
        .dark-mode .nav-link { color: #bbb; }
        .dark-mode .nav-link:hover { color: #fff; background-color: #333; }
        .dark-mode .nav-link.active { color: #0d6efd; background-color: #333; }
        .dark-mode .content { background-color: #121212; }
        .dark-mode .card-metric { background-color: #1e1e1e; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .dark-mode .table { background-color: #1e1e1e; color: #e0e0e0; }
        .dark-mode .table-striped tbody tr:nth-of-type(odd) { background-color: #252525; }
        .dark-mode .table thead th { background-color: #333; }
        .dark-mode .modal-content { background-color: #1e1e1e; color: #e0e0e0; }
        .dark-mode .form-control { background-color: #333; color: #e0e0e0; border: 1px solid #555; }
        .dark-mode .form-control:focus { background-color: #333; color: #e0e0e0; border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); }
        .dark-mode .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .dark-mode .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
        .dark-mode #pdfViewer { border-color: #555; }
        .dark-mode .compliance-card { background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); }
    </style>
</head>
<body>
    <button class="btn btn-sm btn-primary btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="sidebar">
        <h4 class="mb-4"><i class="fas fa-users me-2"></i><span class="nav-text">HRMS System - Bophelong</span></h4>
        <ul class="nav flex-column">
            <li><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
            <li><a href="#employees" class="nav-link" onclick="showSection('employees')"><i class="fas fa-user-friends me-2"></i><span class="nav-text">Employees</span></a></li>
            <li><a href="#payroll" class="nav-link" onclick="showSection('payroll')"><i class="fas fa-money-check-alt me-2"></i><span class="nav-text">Payroll</span></a></li>
            <li><a href="#recruitment" class="nav-link" onclick="showSection('recruitment')"><i class="fas fa-briefcase me-2"></i><span class="nav-text">Recruitment</span></a></li>
            <li><a href="#performance" class="nav-link" onclick="showSection('performance')"><i class="fas fa-chart-line me-2"></i><span class="nav-text">Performance</span></a></li>
            <li><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
            <li><a href="#leaves" class="nav-link" onclick="showSection('leaves')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Leaves</span></a></li>
            <li><a href="#benefits" class="nav-link" onclick="showSection('benefits')"><i class="fas fa-gift me-2"></i><span class="nav-text">Benefits</span></a></li>
            <li><a href="#training" class="nav-link" onclick="showSection('training')"><i class="fas fa-graduation-cap me-2"></i><span class="nav-text">Training</span></a></li>
            <li><a href="#compliance" class="nav-link" onclick="showSection('compliance')"><i class="fas fa-balance-scale me-2"></i><span class="nav-text">Compliance</span></a></li>
            <li><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Reports</span></a></li>
            <li><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
            <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
        </ul>
    </div>

    <div class="content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <h2>Dashboard Overview - Bophelong Community Centre</h2>
            <div class="row mt-4">
                <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Employees</h5><h3 id="totalEmployees">0</h3></div></div>
                <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositions">0</h3></div></div>
                <div class="col-md-3"><div class="card card-metric p-3"><h5>Average Performance</h5><h3 id="avgPerformance">0/5</h3></div></div>
                <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeaves">0</h3></div></div>
                <div class="col-md-3"><div class="card card-metric p-3 compliance-card"><h5>Compliance Score</h5><h3 id="complianceScore">0%</h3></div></div>
                <div class="col-md-3"><div class="card card-metric p-3"><h5>Expiring Certs</h5><h3 id="expiringCerts">0</h3></div></div>
            </div>
            <div class="mt-4">
                <canvas id="dashboardChart"></canvas>
            </div>
        </section>

        <!-- Employees Section -->
        <section id="employees" class="section d-none">
            <h2>Employee Management</h2>
            <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap">
                <div>
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">Add Employee</button>
                    <button class="btn btn-success me-2" onclick="document.getElementById('importFile').click()">Import Employees</button>
                </div>
                <div class="d-flex">
                    <select class="form-control me-2" id="branchFilter" onchange="filterEmployees()">
                        <option value="">All Branches</option>
                    </select>
                    <input type="text" class="form-control search-input" id="employeeSearch" placeholder="Search Employees..." oninput="searchEmployees()">
                </div>
            </div>
            <table class="table table-striped">
                <thead><tr><th>ID</th><th>Name</th><th>Position</th><th>Department</th><th>Branch</th><th>Salary</th><th>Join Date</th><th>Contract Status</th><th>Cert Status</th><th>Email</th><th>Actions</th></tr></thead>
                <tbody id="employeeTable"></tbody>
            </table>
        </section>

        <!-- Payroll Section -->
        <section id="payroll" class="section d-none">
            <h2>Payroll Processing</h2>
            <form id="payrollForm">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-control" id="payEmpId">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <div class="col-md-4"><input type="number" class="form-control" placeholder="Base Salary" id="paySalary"></div>
                    <div class="col-md-4"><button type="button" class="btn btn-primary" onclick="calculatePayroll()">Calculate & Add</button></div>
                </div>
            </form>
            <table class="table mt-4">
                <thead><tr><th>Employee Name</th><th>Branch</th><th>Net Pay</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="payrollTable"></tbody>
            </table>
        </section>

        <!-- Recruitment Section -->
        <section id="recruitment" class="section d-none">
            <h2>Recruitment Management</h2>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addJobModal">Add Job Posting</button>
            <table class="table table-striped">
                <thead><tr><th>ID</th><th>Title</th><th>Description</th><th>Branch</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="jobTable"></tbody>
            </table>
        </section>

        <!-- Performance Section -->
        <section id="performance" class="section d-none">
            <h2>Performance Management</h2>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addReviewModal">Add Review</button>
            <table class="table table-striped">
                <thead><tr><th>Employee</th><th>Branch</th><th>Score</th><th>Comments</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="performanceTable"></tbody>
            </table>
        </section>

        <!-- Attendance Section -->
        <section id="attendance" class="section d-none">
            <h2>Time & Attendance</h2>
            <div class="d-flex justify-content-between mb-3">
                <select class="form-control w-auto" id="attEmpId">
                    <option value="">Select Employee</option>
                </select>
                <button class="btn btn-success ms-2" onclick="clockIn()">Clock In</button>
                <button class="btn btn-warning ms-2" onclick="clockOut()">Clock Out</button>
            </div>
            <table class="table table-striped">
                <thead><tr><th>Employee</th><th>Branch</th><th>Date</th><th>In Time</th><th>Out Time</th><th>Hours</th></tr></thead>
                <tbody id="attendanceTable"></tbody>
            </table>
        </section>

        <!-- Leaves Section -->
        <section id="leaves" class="section d-none">
            <h2>Leave Management</h2>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addLeaveModal">Apply Leave</button>
            <table class="table table-striped">
                <thead><tr><th>Employee</th><th>Branch</th><th>Start Date</th><th>End Date</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="leavesTable"></tbody>
            </table>
        </section>

        <!-- Benefits Section -->
        <section id="benefits" class="section d-none">
            <h2>Benefits Administration</h2>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addBenefitModal">Add Benefit</button>
            <table class="table table-striped">
                <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead>
                <tbody id="benefitsTable"></tbody>
            </table>
        </section>

        <!-- Training Section -->
        <section id="training" class="section d-none">
            <h2>Training & Development</h2>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addCourseModal">Add Course</button>
            <table class="table table-striped">
                <thead><tr><th>ID</th><th>Title</th><th>Description</th><th>Assigned To</th><th>Branch</th><th>Actions</th></tr></thead>
                <tbody id="trainingTable"></tbody>
            </table>
        </section>

        <!-- Compliance Section -->
        <section id="compliance" class="section d-none">
            <h2>HR Compliance Management</h2>
            <ul class="nav nav-tabs" id="complianceTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="checklists-tab" data-bs-toggle="tab" data-bs-target="#checklists" type="button" role="tab">Checklists</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">Documents</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="certifications-tab" data-bs-toggle="tab" data-bs-target="#certifications" type="button" role="tab">Certifications</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab">Audit Log</button>
                </li>
            </ul>
            <div class="tab-content" id="complianceTabContent">
                <div class="tab-pane fade show active" id="checklists" role="tabpanel">
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h5>B-BBEE & Employment Equity Checklist</h5>
                            <div class="checklist-item mb-2"><input type="checkbox" id="bbee-plan"><label for="bbee-plan">Annual B-BBEE Plan Submitted</label></div>
                            <div class="checklist-item mb-2"><input type="checkbox" id="ee-report"><label for="ee-report">Employment Equity Report Filed</label></div>
                            <div class="checklist-item mb-2"><input type="checkbox" id="diversity-training"><label for="diversity-training">Diversity Training Completed</label></div>
                        </div>
                        <div class="col-md-6">
                            <h5>OHS & POPIA Checklist</h5>
                            <div class="checklist-item mb-2"><input type="checkbox" id="ohs-audit"><label for="ohs-audit">Annual OHS Audit Conducted</label></div>
                            <div class="checklist-item mb-2"><input type="checkbox" id="popia-training"><label for="popia-training">POPIA Training for Staff</label></div>
                            <div class="checklist-item mb-2"><input type="checkbox" id="data-breach-protocol"><label for="data-breach-protocol">Data Breach Protocol Updated</label></div>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="saveComplianceChecklist()">Save Checklist</button>
                </div>
                <div class="tab-pane fade" id="documents" role="tabpanel">
                    <div class="mb-3">
                        <button class="btn btn-success" onclick="document.getElementById('complianceDocUpload').click()">Upload Compliance Document</button>
                        <input type="file" id="complianceDocUpload" style="display:none" accept=".pdf,.docx,.xlsx,.csv" onchange="handleComplianceUpload(event)">
                    </div>
                    <table class="table table-striped">
                        <thead><tr><th>Type</th><th>File Name</th><th>Upload Date</th><th>Actions</th></tr></thead>
                        <tbody id="complianceDocsTable"></tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="certifications" role="tabpanel">
                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addCertModal">Add Certification</button>
                    <table class="table table-striped">
                        <thead><tr><th>Employee</th><th>Certification Type</th><th>Issue Date</th><th>Expiry Date</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="certificationsTable"></tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="audit" role="tabpanel">
                    <table class="table table-striped">
                        <thead><tr><th>Date</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                        <tbody id="auditTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="section d-none">
            <h2>Reporting & Analytics</h2>
            <div class="row">
                <div class="col-md-4"><button class="btn btn-info w-100 mb-3" onclick="generateEmployeeReport()">Employee Report</button></div>
                <div class="col-md-4"><button class="btn btn-info w-100 mb-3" onclick="generatePayrollReport()">Payroll Report</button></div>
                <div class="col-md-4"><button class="btn btn-info w-100 mb-3" onclick="generateAttendanceReport()">Attendance Report</button></div>
                <div class="col-md-4"><button class="btn btn-warning w-100 mb-3" onclick="generateComplianceReport()">Compliance Report</button></div>
            </div>
            <div id="reportOutput" class="mt-4"></div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section d-none">
            <h2>System Settings</h2>
            <form id="settingsForm">
                <div class="mb-3"><label>Company Name</label><input type="text" class="form-control" id="companyName" placeholder="Enter company name" value="Bophelong Community Centre"></div>
                <div class="mb-3"><label>Tax Rate (%)</label><input type="number" class="form-control" id="taxRate" placeholder="Enter tax rate" value="15"></div>
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="darkMode">
                    <label class="form-check-label" for="darkMode">Enable Dark Mode</label>
                </div>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </form>
        </section>
    </div>

    <!-- Modals -->
    <!-- Add Employee Modal (enhanced) -->
    <div class="modal fade" id="addEmployeeModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add New Employee</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="employeeForm">
                        <input type="text" class="form-control mb-3" id="empName" placeholder="Name" required>
                        <input type="text" class="form-control mb-3" id="empPosition" placeholder="Position" required>
                        <input type="text" class="form-control mb-3" id="empDepartment" placeholder="Department" required>
                        <select class="form-control mb-3" id="empBranch" required>
                            <option value="">Select Branch</option>
                        </select>
                        <input type="number" class="form-control mb-3" id="empSalary" placeholder="Salary" required>
                        <input type="date" class="form-control mb-3" id="empJoinDate" required>
                        <input type="email" class="form-control mb-3" id="empEmail" placeholder="Email" required>
                        <div class="mb-3"><label>Contract File</label><input type="file" class="form-control" id="empContract" accept=".pdf,.docx"></div>
                    </form>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="addEmployee()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Edit Employee Modal (enhanced) -->
    <div class="modal fade" id="editEmployeeModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Edit Employee</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="editEmployeeForm">
                        <input type="hidden" id="editEmpIndex">
                        <input type="text" class="form-control mb-3" id="editEmpName" placeholder="Name" required>
                        <input type="text" class="form-control mb-3" id="editEmpPosition" placeholder="Position" required>
                        <input type="text" class="form-control mb-3" id="editEmpDepartment" placeholder="Department" required>
                        <select class="form-control mb-3" id="editEmpBranch" required>
                            <option value="">Select Branch</option>
                        </select>
                        <input type="number" class="form-control mb-3" id="editEmpSalary" placeholder="Salary" required>
                        <input type="date" class="form-control mb-3" id="editEmpJoinDate" required>
                        <input type="email" class="form-control mb-3" id="editEmpEmail" placeholder="Email" required>
                        <div class="mb-3"><label>Contract File</label><input type="file" class="form-control" id="editEmpContract" accept=".pdf,.docx"></div>
                    </form>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="updateEmployee()">Update</button></div>
            </div>
        </div>
    </div>

    <!-- Other modals remain the same... -->
    <!-- Add Job Modal -->
    <div class="modal fade" id="addJobModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Job Posting</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="jobTitle" placeholder="Job Title" required>
                    <textarea class="form-control mb-3" id="jobDesc" placeholder="Description" required></textarea>
                    <select class="form-control mb-3" id="jobBranch" required>
                        <option value="">Select Branch</option>
                    </select>
                    <select class="form-control" id="jobStatus">
                        <option value="Open">Open</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="addJob()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Add Review Modal -->
    <div class="modal fade" id="addReviewModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Performance Review</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <select class="form-control mb-3" id="reviewEmpId">
                        <option value="">Select Employee</option>
                    </select>
                    <input type="number" class="form-control mb-3" id="reviewScore" placeholder="Score (1-5)" min="1" max="5" required>
                    <textarea class="form-control mb-3" id="reviewComments" placeholder="Comments" required></textarea>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="addReview()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Add Leave Modal -->
    <div class="modal fade" id="addLeaveModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Apply for Leave</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <select class="form-control mb-3" id="leaveEmpId">
                        <option value="">Select Employee</option>
                    </select>
                    <input type="date" class="form-control mb-3" id="leaveStart" required>
                    <input type="date" class="form-control mb-3" id="leaveEnd" required>
                    <textarea class="form-control mb-3" id="leaveReason" placeholder="Reason" required></textarea>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="addLeave()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Add Benefit Modal -->
    <div class="modal fade" id="addBenefitModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Benefit</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="benefitName" placeholder="Benefit Name" required>
                    <textarea class="form-control mb-3" id="benefitDesc" placeholder="Description" required></textarea>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="addBenefit()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div class="modal fade" id="addCourseModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Training Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="courseTitle" placeholder="Course Title" required>
                    <textarea class="form-control mb-3" id="courseDesc" placeholder="Description" required></textarea>
                    <select class="form-control mb-3" id="courseEmpId">
                        <option value="">Assign to Employee</option>
                    </select>
                    <select class="form-control mb-3" id="courseBranch" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="addCourse()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Add Certification Modal -->
    <div class="modal fade" id="addCertModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Employee Certification</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <select class="form-control mb-3" id="certEmpId">
                        <option value="">Select Employee</option>
                    </select>
                    <input type="text" class="form-control mb-3" id="certType" placeholder="Certification Type (e.g., OHS, POPIA)" required>
                    <input type="date" class="form-control mb-3" id="certIssueDate" required>
                    <input type="date" class="form-control mb-3" id="certExpiryDate" required>
                    <div class="mb-3"><label>Certificate File</label><input type="file" class="form-control" id="certFile" accept=".pdf,.docx,.jpg"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="addCertification()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Preview Modal for Import -->
    <div class="modal fade" id="previewModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Preview Import</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmImport" onclick="confirmImportData()">Confirm Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div class="modal fade" id="docViewerModal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="docTitle">Document Viewer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="docViewer"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // PDF.js Worker Setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Data Storage (enhanced with compliance)
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let payrolls = JSON.parse(localStorage.getItem('payrolls')) || [];
        let jobs = JSON.parse(localStorage.getItem('jobs')) || [];
        let reviews = JSON.parse(localStorage.getItem('reviews')) || [];
        let attendances = JSON.parse(localStorage.getItem('attendances')) || [];
        let leaves = JSON.parse(localStorage.getItem('leaves')) || [];
        let benefits = JSON.parse(localStorage.getItem('benefits')) || [];
        let courses = JSON.parse(localStorage.getItem('courses')) || [];
        let certifications = JSON.parse(localStorage.getItem('certifications')) || [];
        let complianceDocs = JSON.parse(localStorage.getItem('complianceDocs')) || [];
        let complianceChecklist = JSON.parse(localStorage.getItem('complianceChecklist')) || {};
        let auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
        let settings = JSON.parse(localStorage.getItem('settings')) || { companyName: 'Bophelong Community Centre', taxRate: 15, darkMode: false };

        // Branches
        const branches = [
            'Bophelong Hospice',
            'Bophelong Independent School Mamelodi',
            'Bophelong Independent School Kwa-Mhlanga',
            'Bophelong Orphan Age',
            'Bophelong Mental and Disability Home',
            'Bophelong Old Age Home',
            'Charity and Faith Mission Church'
        ];

        let importData = [];
        let currentFileType = '';

        // Function to log audit
        function logAudit(action, details) {
            const logEntry = {
                date: new Date().toLocaleString(),
                user: 'Current User', // In real app, get from auth
                action,
                details
            };
            auditLog.unshift(logEntry);
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
        }

        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const toggleBtn = document.querySelector('.btn-toggle-sidebar');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            toggleBtn.classList.toggle('expanded');
        }

        // Apply Theme
        function applyTheme() {
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
                if (dashboardChart) dashboardChart.data.datasets[0].borderColor = '#4da6ff';
            } else {
                document.body.classList.remove('dark-mode');
                if (dashboardChart) dashboardChart.data.datasets[0].borderColor = '#0d6efd';
            }
            if (dashboardChart) dashboardChart.update();
        }

        // Show Section (enhanced)
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.add('d-none'));
            document.getElementById(sectionId).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`a[href="#${sectionId}"]`).classList.add('active');
            if (sectionId === 'dashboard') updateDashboard();
            else if (sectionId === 'employees') { renderEmployees(); populateBranchFilters(); populateEmployeeSelect('payEmpId'); }
            else if (sectionId === 'payroll') { renderPayrolls(); populateEmployeeSelect('payEmpId'); }
            else if (sectionId === 'recruitment') { renderJobs(); populateBranchSelect('jobBranch'); }
            else if (sectionId === 'performance') { renderReviews(); populateEmployeeSelect('reviewEmpId'); }
            else if (sectionId === 'attendance') { renderAttendances(); populateEmployeeSelect('attEmpId'); }
            else if (sectionId === 'leaves') { renderLeaves(); populateEmployeeSelect('leaveEmpId'); }
            else if (sectionId === 'benefits') renderBenefits();
            else if (sectionId === 'training') { renderCourses(); populateEmployeeSelect('courseEmpId'); populateBranchSelect('courseBranch'); }
            else if (sectionId === 'compliance') { renderCompliance(); populateEmployeeSelect('certEmpId'); }
            else if (sectionId === 'reports') generateComplianceReport(); // Auto-generate on load
            else if (sectionId === 'settings') renderSettings();
            logAudit(`Viewed ${sectionId} section`, '');
        }

        // Populate functions remain similar...

        // Employees Functions (enhanced with compliance)
        function renderEmployees(search = '', branchFilter = '') {
            const table = document.getElementById('employeeTable');
            table.innerHTML = '';
            let filtered = employees.filter(emp => 
                emp.name.toLowerCase().includes(search.toLowerCase()) &&
                (!branchFilter || emp.branch === branchFilter)
            );
            filtered.forEach((emp, index) => {
                const globalIndex = employees.indexOf(emp);
                const contractStatus = emp.contractFile ? 'Uploaded' : 'Missing';
                const certStatus = certifications.filter(c => c.empIndex === globalIndex && new Date(c.expiryDate) < new Date()).length > 0 ? 'Expiring' : 'OK';
                table.innerHTML += `<tr><td>${globalIndex + 1}</td><td>${emp.name}</td><td>${emp.position}</td><td>${emp.department}</td><td>${emp.branch || ''}</td><td>$${emp.salary}</td><td>${emp.joinDate}</td><td><span class="badge ${contractStatus === 'Uploaded' ? 'bg-success' : 'bg-danger'}">${contractStatus}</span></td><td><span class="badge ${certStatus === 'OK' ? 'bg-success' : 'bg-warning'}">${certStatus}</span></td><td>${emp.email}</td><td><button class="btn btn-sm btn-warning me-1" onclick="editEmployee(${globalIndex})">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteEmployee(${globalIndex})">Delete</button></td></tr>`;
            });
        }

        // Add Employee (enhanced)
        function addEmployee() {
            const name = document.getElementById('empName').value;
            const position = document.getElementById('empPosition').value;
            const department = document.getElementById('empDepartment').value;
            const branch = document.getElementById('empBranch').value;
            const salary = parseFloat(document.getElementById('empSalary').value);
            const joinDate = document.getElementById('empJoinDate').value;
            const email = document.getElementById('empEmail').value;
            const contractFile = document.getElementById('empContract').files[0];
            let contractFileName = '';
            if (contractFile) {
                contractFileName = contractFile.name;
                // In real app, upload to storage; here simulate
            }
            if (name && position && department && branch && salary && joinDate && email) {
                const empIndex = employees.push({ name, position, department, branch, salary, joinDate, email, contractFile: contractFileName }) - 1;
                localStorage.setItem('employees', JSON.stringify(employees));
                if (contractFileName) logAudit('Employee Contract Uploaded', `For ${name}`);
                filterEmployees();
                bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal')).hide();
                updateDashboard();
                document.getElementById('employeeForm').reset();
                populateBranchSelect('empBranch');
            }
        }

        // Similar enhancements for updateEmployee...

        // Compliance Functions
        function renderCompliance() {
            // Load checklist
            Object.keys(complianceChecklist).forEach(key => {
                document.getElementById(key).checked = complianceChecklist[key] || false;
            });

            // Render docs
            const docsTable = document.getElementById('complianceDocsTable');
            docsTable.innerHTML = '';
            complianceDocs.forEach((doc, index) => {
                docsTable.innerHTML += `<tr><td>${doc.type}</td><td>${doc.name}</td><td>${doc.date}</td><td><button class="btn btn-sm btn-info" onclick="viewDocument(${index})">View</button> <button class="btn btn-sm btn-danger" onclick="deleteComplianceDoc(${index})">Delete</button></td></tr>`;
            });

            // Render certifications
            const certTable = document.getElementById('certificationsTable');
            certTable.innerHTML = '';
            certifications.forEach((cert, index) => {
                const emp = employees[cert.empIndex] || { name: 'Deleted' };
                const now = new Date();
                const expiry = new Date(cert.expiryDate);
                const status = expiry < now ? 'Expired' : (expiry < new Date(now.getTime() + 30*24*60*60*1000) ? 'Expiring' : 'Valid');
                certTable.innerHTML += `<tr><td>${emp.name}</td><td>${cert.type}</td><td>${cert.issueDate}</td><td>${cert.expiryDate}</td><td><span class="badge ${status === 'Valid' ? 'bg-success' : status === 'Expiring' ? 'bg-warning' : 'bg-danger'}">${status}</span></td><td><button class="btn btn-sm btn-info" onclick="viewCert(${index})">View</button> <button class="btn btn-sm btn-danger" onclick="deleteCertification(${index})">Delete</button></td></tr>`;
            });

            // Render audit log
            const auditTable = document.getElementById('auditTable');
            auditTable.innerHTML = '';
            auditLog.slice(0, 50).forEach(entry => { // Last 50
                auditTable.innerHTML += `<tr><td>${entry.date}</td><td>${entry.user}</td><td>${entry.action}</td><td>${entry.details}</td></tr>`;
            });
        }

        function saveComplianceChecklist() {
            const checklist = {
                'bbee-plan': document.getElementById('bbee-plan').checked,
                'ee-report': document.getElementById('ee-report').checked,
                'diversity-training': document.getElementById('diversity-training').checked,
                'ohs-audit': document.getElementById('ohs-audit').checked,
                'popia-training': document.getElementById('popia-training').checked,
                'data-breach-protocol': document.getElementById('data-breach-protocol').checked
            };
            complianceChecklist = checklist;
            localStorage.setItem('complianceChecklist', JSON.stringify(checklist));
            updateComplianceScore();
            logAudit('Checklist Updated', '');
            alert('Checklist saved!');
        }

        function handleComplianceUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const type = prompt('Enter document type (e.g., B-BBEE Plan, POPIA Policy)');
                if (type) {
                    complianceDocs.push({
                        type,
                        name: file.name,
                        date: new Date().toLocaleDateString(),
                        // Simulate upload
                    });
                    localStorage.setItem('complianceDocs', JSON.stringify(complianceDocs));
                    renderCompliance();
                    logAudit('Compliance Document Uploaded', `${type}: ${file.name}`);
                }
            }
        }

        function viewDocument(index) {
            const doc = complianceDocs[index];
            document.getElementById('docTitle').textContent = doc.name;
            document.getElementById('docViewer').innerHTML = `<p>Viewing ${doc.name} (simulated - in real app, embed viewer)</p><iframe srcdoc="<h1>${doc.type}</h1><p>Document content here...</p>" width="100%" height="400px"></iframe>`;
            new bootstrap.Modal(document.getElementById('docViewerModal')).show();
        }

        function deleteComplianceDoc(index) {
            if (confirm('Delete document?')) {
                complianceDocs.splice(index, 1);
                localStorage.setItem('complianceDocs', JSON.stringify(complianceDocs));
                renderCompliance();
                logAudit('Compliance Document Deleted', complianceDocs[index].name);
            }
        }

        function addCertification() {
            const empIndex = document.getElementById('certEmpId').value;
            const type = document.getElementById('certType').value;
            const issueDate = document.getElementById('certIssueDate').value;
            const expiryDate = document.getElementById('certExpiryDate').value;
            const file = document.getElementById('certFile').files[0];
            let fileName = '';
            if (file) fileName = file.name;
            if (empIndex !== '' && type && issueDate && expiryDate) {
                certifications.push({ empIndex: parseInt(empIndex), type, issueDate, expiryDate, file: fileName });
                localStorage.setItem('certifications', JSON.stringify(certifications));
                renderCompliance();
                bootstrap.Modal.getInstance(document.getElementById('addCertModal')).hide();
                updateDashboard();
                logAudit('Certification Added', `${type} for employee ${employees[empIndex].name}`);
            }
        }

        function deleteCertification(index) {
            if (confirm('Delete certification?')) {
                certifications.splice(index, 1);
                localStorage.setItem('certifications', JSON.stringify(certifications));
                renderCompliance();
                updateDashboard();
                logAudit('Certification Deleted', certifications[index].type);
            }
        }

        function viewCert(index) {
            const cert = certifications[index];
            document.getElementById('docTitle').textContent = `${cert.type} Certificate`;
            document.getElementById('docViewer').innerHTML = `<p>Certificate details: ${cert.type}, Expiry: ${cert.expiryDate}</p><iframe srcdoc="<h1>${cert.type}</h1><p>Certificate content here...</p>" width="100%" height="400px"></iframe>`;
            new bootstrap.Modal(document.getElementById('docViewerModal')).show();
        }

        function updateComplianceScore() {
            const totalItems = 6;
            const checked = Object.values(complianceChecklist).filter(v => v).length;
            const score = Math.round((checked / totalItems) * 100);
            document.getElementById('complianceScore').textContent = `${score}%`;
        }

        function generateComplianceReport() {
            let output = '<h4>Compliance Report - Bophelong Community Centre</h4>';
            output += `<p>Overall Compliance Score: ${document.getElementById('complianceScore').textContent}</p>`;
            output += '<h5>Diversity & Equity</h5><ul>';
            branches.forEach(branch => {
                const branchEmps = employees.filter(e => e.branch === branch);
                const femaleCount = branchEmps.filter(e => e.gender === 'Female').length; // Assume gender field added if needed
                output += `<li>${branch}: ${femaleCount} / ${branchEmps.length} Female Employees</li>`;
            });
            output += '</ul>';
            output += '<h5>Certifications Status</h5><table class="table"><thead><tr><th>Type</th><th>Valid</th><th>Expiring</th><th>Expired</th></tr></thead><tbody>';
            // Group certs
            const certGroups = {};
            certifications.forEach(cert => {
                const now = new Date();
                const expiry = new Date(cert.expiryDate);
                const status = expiry < now ? 'Expired' : (expiry < new Date(now.getTime() + 30*24*60*60*1000) ? 'Expiring' : 'Valid');
                certGroups[cert.type] = certGroups[cert.type] || { Valid: 0, Expiring: 0, Expired: 0 };
                certGroups[cert.type][status]++;
            });
            Object.keys(certGroups).forEach(type => {
                const g = certGroups[type];
                output += `<tr><td>${type}</td><td>${g.Valid || 0}</td><td>${g.Expiring || 0}</td><td>${g.Expired || 0}</td></tr>`;
            });
            output += '</tbody></table>';
            document.getElementById('reportOutput').innerHTML = output;
        }

        // Dashboard (enhanced)
        function updateDashboard() {
            // Existing...
            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('openPositions').textContent = jobs.filter(j => j.status === 'Open').length;
            const avgScore = reviews.length > 0 ? (reviews.reduce((sum, rev) => sum + rev.score, 0) / reviews.length).toFixed(1) : 0;
            document.getElementById('avgPerformance').textContent = `${avgScore}/5`;
            document.getElementById('pendingLeaves').textContent = leaves.filter(l => l.status === 'Pending').length;

            // Compliance
            updateComplianceScore();
            const expiring = certifications.filter(c => {
                const expiry = new Date(c.expiryDate);
                return expiry < new Date(new Date().getTime() + 30*24*60*60*1000) && expiry > new Date();
            }).length;
            document.getElementById('expiringCerts').textContent = expiring;

            // Chart...
        }

        // Other functions remain similar, with logAudit calls where appropriate...

        // Initial Load
        applyTheme();
        populateBranchFilters();
        populateBranchSelect('empBranch');
        populateBranchSelect('editEmpBranch');
        populateBranchSelect('jobBranch');
        populateBranchSelect('courseBranch');
        filterEmployees();
        renderPayrolls();
        renderJobs();
        renderReviews();
        renderAttendances();
        renderLeaves();
        renderBenefits();
        renderCourses();
        renderCompliance();
        updateDashboard();
        showSection('dashboard');
    </script>
</body>
</html>
