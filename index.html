<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity And Faith Mission Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        nav {
            background-color: #34495e;
            padding: 10px;
            text-align: center;
        }
        nav button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        nav button:hover {
            background-color: #2980b9;
        }
        nav button.active {
            background-color: #e74c3c;
        }
        .content {
            display: none;
            padding: 20px;
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        input, select, button, textarea, .file-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        select[multiple] {
            height: 150px;
        }
        input[readonly] {
            background-color: #f9f9f9;
        }
        .file-input {
            border: none;
            background-color: #f9f9f9;
        }
        button[type="submit"] {
            background-color: #27ae60;
            color: white;
            border: none;
            cursor: pointer;
        }
        button[type="submit"]:hover {
            background-color: #229954;
        }
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }
        .whatsapp-btn:hover {
            background-color: #128C7E;
        }
        a.whatsapp-link {
            color: #25D366;
            text-decoration: none;
        }
        a.whatsapp-link:hover {
            text-decoration: underline;
        }
        .event-list, .tithe-list, .assignment-list, .employee-list, .leave-list, .leader-list, .pastor-list, .cell-list, .elder-list, .report-list, .whatsapp-list, .follow-up-list, .reminder-list {
            list-style: none;
            padding: 0;
        }
        .event-item, .tithe-item, .assignment-item, .employee-item, .leave-item, .leader-item, .pastor-item, .cell-item, .elder-item, .report-item, .whatsapp-item, .follow-up-item, .reminder-item {
            background-color: #f9f9f9;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .reminder-item.due {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .reminder-item.overdue {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .total {
            font-weight: bold;
            background-color: #e8f5e8;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 1em;
        }
        .bulk-upload {
            margin-bottom: 20px;
        }
        .bulk-upload input[type="file"] {
            max-width: 300px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .search-container input {
            width: 100%;
            max-width: 300px;
        }
        .leaders-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .leaders-section {
            flex: 1;
            min-width: 300px;
        }
        .events-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .events-section {
            flex: 1;
            min-width: 300px;
        }
        details {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        summary {
            padding: 10px;
            background-color: #f2f2f2;
            cursor: pointer;
            font-weight: bold;
        }
        .folder-content {
            padding: 10px;
        }
        .folder-actions {
            margin-top: 10px;
            text-align: right;
        }
        .folder-actions button {
            margin-left: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .folder-actions .print-btn {
            background-color: #f39c12;
            color: white;
        }
        .folder-actions .export-btn {
            background-color: #3498db;
            color: white;
        }
        .folder-actions .email-btn {
            background-color: #27ae60;
            color: white;
        }
        .folder-actions .minimize-btn {
            background-color: #e74c3c;
            color: white;
        }
        .transport-table input, .essentials-table input, .sunday-school-table input, .grocery-table input, .sound-media-table input, .stage-deco-table input, .guest-pastor-table input {
            width: 100px;
        }
        .budget-date {
            margin-bottom: 10px;
        }
        .budget-total {
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            background-color: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 5px;
            text-align: center;
            font-size: 1em;
            color: #27ae60;
        }
        .grand-total {
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            background-color: #d4edda;
            border: 2px solid #28a745;
            border-radius: 5px;
            text-align: center;
            font-size: 1.1em;
            color: #155724;
        }
        .generate-report-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .generate-report-btn:hover {
            background-color: #2980b9;
        }
        .report-download-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }
        .report-delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .history-icon {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            margin: 10px;
            display: inline-block;
        }
        .history-section {
            display: none;
            margin-top: 20px;
        }
        .history-section.active {
            display: block;
        }
        .history-report-item {
            background-color: #f9f9f9;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        button.delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        button.convert-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .add-item-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .add-item-form input {
            flex: 1;
            min-width: 150px;
        }
        .add-item-form button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .template-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .template-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .template-btn:hover {
            background-color: #128C7E;
        }
        .whatsapp-history {
            margin-top: 20px;
        }
        .whatsapp-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .whatsapp-item-details {
            flex: 1;
        }
        .broadcast-form {
            max-width: 600px;
        }
        .broadcast-select {
            height: 200px;
        }
        .broadcast-actions {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .broadcast-btn {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .broadcast-btn:hover {
            background-color: #d35400;
        }
        .converted {
            background-color: #d4edda;
            font-style: italic;
        }
        .analytics-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: #e8f5e8;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #27ae60;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
            z-index: 1000;
            display: none;
        }
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .bulk-send-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .bulk-send-btn:hover {
            background-color: #128C7E;
        }
        .tithe-message-form, .contributor-message-form {
            max-width: 500px;
        }
        .conference-select {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Charity And Faith Mission Management System</h1>
        <p>Welcome to your church dashboard</p>
    </header>
    
    <nav>
        <button onclick="showSection('members')" class="active">Members</button>
        <button onclick="showSection('visitors')">Visitors</button>
        <button onclick="showSection('analytics')">Analytics</button>
        <button onclick="showSection('events')">Events</button>
        <button onclick="showSection('tithe')">Tithe & Offering</button>
        <button onclick="showSection('church-admin')">Church Admin</button>
        <button onclick="showSection('whatsapp')">WhatsApp Interactions</button>
        <button onclick="showSection('vault')">Vault</button>
    </nav>
    
    <div id="members" class="content active">
        <h2>Member Directory</h2>
        <div class="bulk-upload">
            <h3>Bulk Upload Members (CSV)</h3>
            <p>CSV format: name,email,cell,address,joinDate,role,branch (joinDate optional, defaults to today)</p>
            <form id="bulkMemberForm">
                <input type="file" id="bulkCsv" accept=".csv" required>
                <button type="submit">Upload CSV</button>
            </form>
        </div>
        <div class="search-container">
            <h3>Search Members</h3>
            <input type="text" id="memberSearch" placeholder="Search by name, email, cell, address, or role..." onkeyup="searchMembers()">
        </div>
        <details id="mdf-folder">
            <summary>MDF</summary>
            <div class="folder-content">
                <form id="memberForm">
                    <input type="text" id="name" placeholder="Full Name" required>
                    <select id="branch">
                        <option value="">Select Branch</option>
                        <option value="Khutsong">Khutsong</option>
                        <option value="Mamelodi EXT5">Mamelodi EXT5</option>
                        <option value="Mahube">Mahube</option>
                        <option value="Phase 5">Phase 5</option>
                        <option value="Kwamhlanga">Kwamhlanga</option>
                        <option value="Kameel port">Kameel port</option>
                        <option value="Nelmaphius ext4">Nelmaphius ext4</option>
                        <option value="Nelmaphius ext 6">Nelmaphius ext 6</option>
                    </select>
                    <input type="email" id="email" placeholder="Email" required>
                    <input type="tel" id="cell" placeholder="Cell Number (e.g., +1234567890)" required>
                    <input type="text" id="address" placeholder="Address" required>
                    <input type="date" id="joinDate" required>
                    <select id="role">
                        <option value="Member">Member</option>
                        <option value="Volunteer">Volunteer</option>
                        <option value="Leader">Leader</option>
                    </select>
                    <button type="submit">Add Member</button>
                </form>
                <table id="memberTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Email</th>
                            <th>Cell Number</th>
                            <th>Address</th>
                            <th>Join Date</th>
                            <th>Role</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Members will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('mdf')">Print</button>
                    <button class="export-btn" onclick="exportMembers()">Export</button>
                    <button class="email-btn" onclick="emailMembers()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('mdf')">Minimize</button>
                </div>
            </div>
        </details>
    </div>

    <div id="visitors" class="content">
        <h2>Visitor Directory</h2>
        <div class="bulk-upload">
            <h3>Bulk Upload Visitors (CSV)</h3>
            <p>CSV format: name,email,cell,address,visitDate,branch,notes (visitDate optional, defaults to today)</p>
            <form id="bulkVisitorForm">
                <input type="file" id="bulkVisitorCsv" accept=".csv" required>
                <button type="submit">Upload CSV</button>
            </form>
        </div>
        <div class="search-container">
            <h3>Search Visitors</h3>
            <input type="text" id="visitorSearch" placeholder="Search by name, email, cell, address, or branch..." onkeyup="searchVisitors()">
        </div>
        <details id="visitor-directory-folder">
            <summary>Visitor Directory</summary>
            <div class="folder-content">
                <form id="visitorForm">
                    <input type="text" id="visitorName" placeholder="Full Name" required>
                    <select id="visitorBranch">
                        <option value="">Select Branch</option>
                        <option value="Khutsong">Khutsong</option>
                        <option value="Mamelodi EXT5">Mamelodi EXT5</option>
                        <option value="Mahube">Mahube</option>
                        <option value="Phase 5">Phase 5</option>
                        <option value="Kwamhlanga">Kwamhlanga</option>
                        <option value="Kameel port">Kameel port</option>
                        <option value="Nelmaphius ext4">Nelmaphius ext4</option>
                        <option value="Nelmaphius ext 6">Nelmaphius ext 6</option>
                    </select>
                    <input type="email" id="visitorEmail" placeholder="Email">
                    <input type="tel" id="visitorCell" placeholder="Cell Number (e.g., +1234567890)" required>
                    <input type="text" id="visitorAddress" placeholder="Address">
                    <input type="date" id="visitorVisitDate" required>
                    <textarea id="visitorNotes" placeholder="Notes (e.g., interests, follow-up needs)"></textarea>
                    <button type="submit">Add Visitor</button>
                </form>
                <table id="visitorTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Email</th>
                            <th>Cell Number</th>
                            <th>Address</th>
                            <th>Visit Date</th>
                            <th>Notes</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Visitors will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('visitor-directory')">Print</button>
                    <button class="export-btn" onclick="exportVisitors()">Export</button>
                    <button class="email-btn" onclick="emailVisitors()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('visitor-directory')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="follow-ups-folder">
            <summary>Visitor Follow-ups</summary>
            <div class="folder-content">
                <form id="followUpForm">
                    <select id="followUpVisitorSelect" required></select>
                    <select id="followUpStatus">
                        <option value="Contacted">Contacted</option>
                        <option value="Interested">Interested</option>
                        <option value="Joined">Joined</option>
                        <option value="Not Interested">Not Interested</option>
                    </select>
                    <input type="date" id="followUpDate">
                    <input type="date" id="followUpReminderDate" placeholder="Reminder Date">
                    <textarea id="followUpNotes" placeholder="Notes"></textarea>
                    <button type="submit">Log Follow-up</button>
                </form>
                <ul id="followUpList" class="follow-up-list">
                    <!-- Follow-ups will be added here -->
                </ul>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('follow-ups')">Print</button>
                    <button class="export-btn" onclick="exportFollowUps()">Export</button>
                    <button class="email-btn" onclick="emailFollowUps()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('follow-ups')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="follow-up-reminders-folder">
            <summary>Follow-up Reminders (Enhanced)</summary>
            <div class="folder-content">
                <p><strong>Enhanced Features:</strong> Bulk send for due reminders, priority sorting, and customizable templates.</p>
                <button class="bulk-send-btn" onclick="bulkSendDueReminders()">Bulk Send Due Reminders Today</button>
                <ul id="reminderList" class="reminder-list">
                    <!-- Reminders will be added here -->
                </ul>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('follow-up-reminders')">Print</button>
                    <button class="export-btn" onclick="exportReminders()">Export</button>
                    <button class="email-btn" onclick="emailReminders()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('follow-up-reminders')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="send-visitor-message-folder">
            <summary>Send Visitor Message</summary>
            <div class="folder-content">
                <form id="visitorWhatsAppForm">
                    <label for="visitorWhatsAppSelect">Select Visitor:</label>
                    <select id="visitorWhatsAppSelect" required></select>
                    <label for="visitorWhatsAppMessage">Message:</label>
                    <textarea id="visitorWhatsAppMessage" placeholder="Enter your message..." required></textarea>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="fillVisitorTemplate('Welcome [Name]! We\'re glad you visited us. Join us next Sunday at 9 AM. God bless!')">Welcome Message</button>
                        <button type="button" class="template-btn" onclick="fillVisitorTemplate('Hello [Name], we have a visitor follow-up class on [Date]. Interested? Reply yes!')">Follow-up Invite</button>
                        <button type="button" class="template-btn" onclick="fillVisitorTemplate('Thank you [Name] for visiting. How can we pray for you today?')">Prayer Offer</button>
                        <button type="button" class="template-btn" onclick="fillVisitorTemplate('Hi [Name], here\'s our church newsletter: [Link]. Blessings!')">Newsletter Share</button>
                    </div>
                    <button type="submit">Send via WhatsApp</button>
                </form>
            </div>
        </details>
        <button id="generateVisitorReportBtn" class="generate-report-btn">Generate Visitors Report 📊</button>
    </div>

    <div id="analytics" class="content">
        <h2>Visitors Analytics Dashboard</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalVisitors">0</div>
                <div>Total Visitors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalConverted">0</div>
                <div>Converted to Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="conversionRate">0%</div>
                <div>Conversion Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingFollowUps">0</div>
                <div>Pending Follow-ups</div>
            </div>
        </div>
        <div class="analytics-container">
            <div class="chart-container">
                <h3>Visitors Over Time</h3>
                <canvas id="visitorsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Conversion Status</h3>
                <canvas id="conversionChart"></canvas>
            </div>
        </div>
    </div>
    
    <div id="events" class="content">
        <h2>Events</h2>
        <details id="events-folder">
            <summary>Events Folder</summary>
            <div class="folder-content">
                <h3>Event Calendar</h3>
                <form id="eventForm">
                    <input type="text" id="eventTitle" placeholder="Event Title" required>
                    <input type="date" id="eventDate" required>
                    <input type="time" id="eventTime" required>
                    <textarea id="eventDesc" placeholder="Description"></textarea>
                    <button type="submit">Add Event</button>
                </form>
                <ul id="eventList" class="event-list">
                    <!-- Events will be added here -->
                </ul>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('events')">Print</button>
                    <button class="export-btn" onclick="exportEvents()">Download</button>
                    <button class="email-btn" onclick="emailEvents()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('events')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="combined-service-folder">
            <summary>Combined Service Folder</summary>
            <div class="folder-content">
                <h3>Combined Service Contribution Directory</h3>
                <div class="bulk-upload">
                    <h4>Bulk Upload Contributions (CSV)</h4>
                    <p>CSV format: member,currency,amount,date,notes</p>
                    <form id="bulkCombinedContribForm">
                        <input type="file" id="bulkCombinedContribCsv" accept=".csv" required>
                        <button type="submit">Upload CSV</button>
                    </form>
                </div>
                <form id="combinedForm">
                    <input type="text" id="combinedMember" placeholder="Member Name" required>
                    <select id="combinedCurrency">
                        <option value="ZAR">ZAR</option>
                        <option value="USD">USD</option>
                    </select>
                    <input type="number" id="combinedAmount" placeholder="Amount" step="0.01" required>
                    <input type="date" id="combinedDate" required>
                    <textarea id="combinedNotes" placeholder="Notes"></textarea>
                    <button type="submit">Add Contribution</button>
                </form>
                <ul id="combinedList" class="tithe-list">
                    <!-- Combined contributions will be added here -->
                </ul>
                <div id="combinedTotal" class="total"></div>
                <div class="budget-date">
                    <label for="combinedDateBudget">Date:</label>
                    <input type="date" id="combinedDateBudget" onchange="saveCombinedDate(this.value)">
                </div>
                <details id="combined-transport-folder">
                    <summary>Transport Budget</summary>
                    <div class="folder-content">
                        <h4>Transport budget</h4>
                        <table id="combinedTransportTable" class="transport-table">
                            <thead>
                                <tr>
                                    <th>Branch</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Mahube</td>
                                    <td><input type="number" step="0.01" id="combinedMahubeAmount" onchange="saveCombinedTransportAmount('mahube', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 4</td>
                                    <td><input type="number" step="0.01" id="combinedNelmaphiusExt4Amount" onchange="saveCombinedTransportAmount('nelmaphiusExt4', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 6</td>
                                    <td><input type="number" step="0.01" id="combinedNelmaphiusExt6Amount" onchange="saveCombinedTransportAmount('nelmaphiusExt6', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Phase 5</td>
                                    <td><input type="number" step="0.01" id="combinedPhase5Amount" onchange="saveCombinedTransportAmount('phase5', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Mamelodi Ext5</td>
                                    <td><input type="number" step="0.01" id="combinedMamelodiExt5Amount" onchange="saveCombinedTransportAmount('mamelodiExt5', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Kwamhlanga/kameel poort</td>
                                    <td><input type="number" step="0.01" id="combinedKwamhlangaKameelAmount" onchange="saveCombinedTransportAmount('kwamhlangaKameel', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="combinedTransportTotal" class="budget-total">Total Transport Budget: 0.00</div>
                    </div>
                </details>
                <details id="combined-conference-essentials-folder">
                    <summary>Conference Essentials</summary>
                    <div class="folder-content">
                        <h4>Conference Essentials</h4>
                        <table id="combinedConferenceEssentialsTable" class="essentials-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Water Bottles</td>
                                    <td><input type="number" step="0.01" id="combinedWaterBottlesAmount" onchange="saveCombinedConferenceEssentialsAmount('waterBottles', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Juices</td>
                                    <td><input type="number" step="0.01" id="combinedJuicesAmount" onchange="saveCombinedConferenceEssentialsAmount('juices', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Sweets</td>
                                    <td><input type="number" step="0.01" id="combinedSweetsAmount" onchange="saveCombinedConferenceEssentialsAmount('sweets', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Toilet Paper</td>
                                    <td><input type="number" step="0.01" id="combinedToiletPaperAmount" onchange="saveCombinedConferenceEssentialsAmount('toiletPaper', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Drumsticks</td>
                                    <td><input type="number" step="0.01" id="combinedDrumsticksAmount" onchange="saveCombinedConferenceEssentialsAmount('drumsticks', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="combinedConferenceEssentialsTotal" class="budget-total">Total Conference Essentials: 0.00</div>
                    </div>
                </details>
                <details id="combined-sunday-school-folder">
                    <summary>Sunday School Essentials</summary>
                    <div class="folder-content">
                        <h4>Sunday School Essentials</h4>
                        <table id="combinedSundaySchoolTable" class="sunday-school-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jumping Castle</td>
                                    <td><input type="number" step="0.01" id="combinedJumpingCastleAmount" onchange="saveCombinedSundaySchoolAmount('jumpingCastle', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Snacks</td>
                                    <td><input type="number" step="0.01" id="combinedSnacksAmount" onchange="saveCombinedSundaySchoolAmount('snacks', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>First Aid</td>
                                    <td><input type="number" step="0.01" id="combinedFirstAidAmount" onchange="saveCombinedSundaySchoolAmount('firstAid', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Security</td>
                                    <td><input type="number" step="0.01" id="combinedSecurityAmount" onchange="saveCombinedSundaySchoolAmount('security', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="combinedSundaySchoolTotal" class="budget-total">Total Sunday School Essentials: 0.00</div>
                    </div>
                </details>
                <details id="combined-grocery-folder">
                    <summary>Grocery</summary>
                    <div class="folder-content">
                        <h4>Grocery</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Grocery Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkCombinedGroceryForm">
                                <input type="file" id="bulkCombinedGroceryCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addCombinedGroceryForm" class="add-item-form">
                            <input type="text" id="combinedGroceryItemName" placeholder="Item Name" required>
                            <input type="number" id="combinedGroceryItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="combinedGroceryTable" class="grocery-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="combinedGroceryTotal" class="budget-total">Total Grocery: 0.00</div>
                    </div>
                </details>
                <details id="combined-sound-media-folder">
                    <summary>Sound and Media</summary>
                    <div class="folder-content">
                        <h4>Sound and Media</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Sound and Media Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkCombinedSoundMediaForm">
                                <input type="file" id="bulkCombinedSoundMediaCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addCombinedSoundMediaForm" class="add-item-form">
                            <input type="text" id="combinedSoundMediaItemName" placeholder="Item Name" required>
                            <input type="number" id="combinedSoundMediaItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="combinedSoundMediaTable" class="sound-media-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="combinedSoundMediaTotal" class="budget-total">Total Sound and Media: 0.00</div>
                    </div>
                </details>
                <details id="combined-stage-deco-folder">
                    <summary>Stage and Deco</summary>
                    <div class="folder-content">
                        <h4>Stage and Deco</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Stage and Deco Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkCombinedStageDecoForm">
                                <input type="file" id="bulkCombinedStageDecoCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addCombinedStageDecoForm" class="add-item-form">
                            <input type="text" id="combinedStageDecoItemName" placeholder="Item Name" required>
                            <input type="number" id="combinedStageDecoItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="combinedStageDecoTable" class="stage-deco-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="combinedStageDecoTotal" class="budget-total">Total Stage and Deco: 0.00</div>
                    </div>
                </details>
                <details id="combined-guest-pastor-folder">
                    <summary>Guest Pastor</summary>
                    <div class="folder-content">
                        <h4>Guest Pastor</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Guest Pastor Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkCombinedGuestPastorForm">
                                <input type="file" id="bulkCombinedGuestPastorCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addCombinedGuestPastorForm" class="add-item-form">
                            <input type="text" id="combinedGuestPastorItemName" placeholder="Item Name" required>
                            <input type="number" id="combinedGuestPastorItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="combinedGuestPastorTable" class="guest-pastor-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="combinedGuestPastorTotal" class="budget-total">Total Guest Pastor: 0.00</div>
                    </div>
                </details>
                <div id="combinedGrandTotal" class="grand-total">Grand Total: 0.00</div>
                <button id="combinedGenerateReportBtn" class="generate-report-btn">Generate Report 📊</button>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('combined-service')">Print</button>
                    <button class="export-btn" onclick="exportCombinedBudget()">Download</button>
                    <button class="email-btn" onclick="emailCombinedBudget()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('combined-service')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="easter-conference-folder">
            <summary>Easter Conference Folder</summary>
            <div class="folder-content">
                <h3>Easter Conference Contribution Directory</h3>
                <div class="bulk-upload">
                    <h4>Bulk Upload Contributions (CSV)</h4>
                    <p>CSV format: member,currency,amount,date,notes</p>
                    <form id="bulkEasterContribForm">
                        <input type="file" id="bulkEasterContribCsv" accept=".csv" required>
                        <button type="submit">Upload CSV</button>
                    </form>
                </div>
                <form id="easterForm">
                    <input type="text" id="easterMember" placeholder="Member Name" required>
                    <select id="easterCurrency">
                        <option value="ZAR">ZAR</option>
                        <option value="USD">USD</option>
                    </select>
                    <input type="number" id="easterAmount" placeholder="Amount" step="0.01" required>
                    <input type="date" id="easterDate" required>
                    <textarea id="easterNotes" placeholder="Notes"></textarea>
                    <button type="submit">Add Contribution</button>
                </form>
                <ul id="easterList" class="tithe-list">
                    <!-- Easter contributions will be added here -->
                </ul>
                <div id="easterTotal" class="total"></div>
                <div class="budget-date">
                    <label for="easterDateBudget">Date:</label>
                    <input type="date" id="easterDateBudget" onchange="saveEasterDate(this.value)">
                </div>
                <details id="easter-transport-folder">
                    <summary>Transport Budget</summary>
                    <div class="folder-content">
                        <h4>Transport budget</h4>
                        <table id="easterTransportTable" class="transport-table">
                            <thead>
                                <tr>
                                    <th>Branch</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Mahube</td>
                                    <td><input type="number" step="0.01" id="easterMahubeAmount" onchange="saveEasterTransportAmount('mahube', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 4</td>
                                    <td><input type="number" step="0.01" id="easterNelmaphiusExt4Amount" onchange="saveEasterTransportAmount('nelmaphiusExt4', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 6</td>
                                    <td><input type="number" step="0.01" id="easterNelmaphiusExt6Amount" onchange="saveEasterTransportAmount('nelmaphiusExt6', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Phase 5</td>
                                    <td><input type="number" step="0.01" id="easterPhase5Amount" onchange="saveEasterTransportAmount('phase5', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Mamelodi Ext5</td>
                                    <td><input type="number" step="0.01" id="easterMamelodiExt5Amount" onchange="saveEasterTransportAmount('mamelodiExt5', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Kwamhlanga/kameel poort</td>
                                    <td><input type="number" step="0.01" id="easterKwamhlangaKameelAmount" onchange="saveEasterTransportAmount('kwamhlangaKameel', this.value); updateEasterAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="easterTransportTotal" class="budget-total">Total Transport Budget: 0.00</div>
                    </div>
                </details>
                <details id="easter-conference-essentials-folder">
                    <summary>Conference Essentials</summary>
                    <div class="folder-content">
                        <h4>Conference Essentials</h4>
                        <table id="easterConferenceEssentialsTable" class="essentials-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Water Bottles</td>
                                    <td><input type="number" step="0.01" id="easterWaterBottlesAmount" onchange="saveEasterConferenceEssentialsAmount('waterBottles', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Juices</td>
                                    <td><input type="number" step="0.01" id="easterJuicesAmount" onchange="saveEasterConferenceEssentialsAmount('juices', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Sweets</td>
                                    <td><input type="number" step="0.01" id="easterSweetsAmount" onchange="saveEasterConferenceEssentialsAmount('sweets', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Toilet Paper</td>
                                    <td><input type="number" step="0.01" id="easterToiletPaperAmount" onchange="saveEasterConferenceEssentialsAmount('toiletPaper', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Drumsticks</td>
                                    <td><input type="number" step="0.01" id="easterDrumsticksAmount" onchange="saveEasterConferenceEssentialsAmount('drumsticks', this.value); updateEasterAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="easterConferenceEssentialsTotal" class="budget-total">Total Conference Essentials: 0.00</div>
                    </div>
                </details>
                <details id="easter-sunday-school-folder">
                    <summary>Sunday School Essentials</summary>
                    <div class="folder-content">
                        <h4>Sunday School Essentials</h4>
                        <table id="easterSundaySchoolTable" class="sunday-school-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jumping Castle</td>
                                    <td><input type="number" step="0.01" id="easterJumpingCastleAmount" onchange="saveEasterSundaySchoolAmount('jumpingCastle', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Snacks</td>
                                    <td><input type="number" step="0.01" id="easterSnacksAmount" onchange="saveEasterSundaySchoolAmount('snacks', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>First Aid</td>
                                    <td><input type="number" step="0.01" id="easterFirstAidAmount" onchange="saveEasterSundaySchoolAmount('firstAid', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Security</td>
                                    <td><input type="number" step="0.01" id="easterSecurityAmount" onchange="saveEasterSundaySchoolAmount('security', this.value); updateEasterAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="easterSundaySchoolTotal" class="budget-total">Total Sunday School Essentials: 0.00</div>
                    </div>
                </details>
                <details id="easter-grocery-folder">
                    <summary>Grocery</summary>
                    <div class="folder-content">
                        <h4>Grocery</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Grocery Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkEasterGroceryForm">
                                <input type="file" id="bulkEasterGroceryCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addEasterGroceryForm" class="add-item-form">
                            <input type="text" id="easterGroceryItemName" placeholder="Item Name" required>
                            <input type="number" id="easterGroceryItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="easterGroceryTable" class="grocery-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="easterGroceryTotal" class="budget-total">Total Grocery: 0.00</div>
                    </div>
                </details>
                <details id="easter-sound-media-folder">
                    <summary>Sound and Media</summary>
                    <div class="folder-content">
                        <h4>Sound and Media</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Sound and Media Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkEasterSoundMediaForm">
                                <input type="file" id="bulkEasterSoundMediaCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addEasterSoundMediaForm" class="add-item-form">
                            <input type="text" id="easterSoundMediaItemName" placeholder="Item Name" required>
                            <input type="number" id="easterSoundMediaItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="easterSoundMediaTable" class="sound-media-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="easterSoundMediaTotal" class="budget-total">Total Sound and Media: 0.00</div>
                    </div>
                </details>
                <details id="easter-stage-deco-folder">
                    <summary>Stage and Deco</summary>
                    <div class="folder-content">
                        <h4>Stage and Deco</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Stage and Deco Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkEasterStageDecoForm">
                                <input type="file" id="bulkEasterStageDecoCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addEasterStageDecoForm" class="add-item-form">
                            <input type="text" id="easterStageDecoItemName" placeholder="Item Name" required>
                            <input type="number" id="easterStageDecoItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="easterStageDecoTable" class="stage-deco-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="easterStageDecoTotal" class="budget-total">Total Stage and Deco: 0.00</div>
                    </div>
                </details>
                <details id="easter-guest-pastor-folder">
                    <summary>Guest Pastor</summary>
                    <div class="folder-content">
                        <h4>Guest Pastor</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Guest Pastor Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkEasterGuestPastorForm">
                                <input type="file" id="bulkEasterGuestPastorCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addEasterGuestPastorForm" class="add-item-form">
                            <input type="text" id="easterGuestPastorItemName" placeholder="Item Name" required>
                            <input type="number" id="easterGuestPastorItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="easterGuestPastorTable" class="guest-pastor-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="easterGuestPastorTotal" class="budget-total">Total Guest Pastor: 0.00</div>
                    </div>
                </details>
                <div id="easterGrandTotal" class="grand-total">Grand Total: 0.00</div>
                <button id="easterGenerateReportBtn" class="generate-report-btn">Generate Report 📊</button>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('easter-conference')">Print</button>
                    <button class="export-btn" onclick="exportEasterBudget()">Download</button>
                    <button class="email-btn" onclick="emailEasterBudget()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('easter-conference')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="september-conference-folder">
            <summary>September conference folder</summary>
            <div class="folder-content">
                <h3>September Conference Contribution Directory</h3>
                <div class="bulk-upload">
                    <h4>Bulk Upload Contributions (CSV)</h4>
                    <p>CSV format: member,currency,amount,date,notes</p>
                    <form id="bulkSeptemberContribForm">
                        <input type="file" id="bulkSeptemberContribCsv" accept=".csv" required>
                        <button type="submit">Upload CSV</button>
                    </form>
                </div>
                <form id="septemberForm">
                    <input type="text" id="septemberMember" placeholder="Member Name" required>
                    <select id="septemberCurrency">
                        <option value="ZAR">ZAR</option>
                        <option value="USD">USD</option>
                    </select>
                    <input type="number" id="septemberAmount" placeholder="Amount" step="0.01" required>
                    <input type="date" id="septemberDate" required>
                    <textarea id="septemberNotes" placeholder="Notes"></textarea>
                    <button type="submit">Add Contribution</button>
                </form>
                <ul id="septemberList" class="tithe-list">
                    <!-- September contributions will be added here -->
                </ul>
                <div id="septemberTotal" class="total"></div>
                <div class="budget-date">
                    <label for="septemberDateBudget">Date:</label>
                    <input type="date" id="septemberDateBudget" onchange="saveSeptemberDate(this.value)">
                </div>
                <details id="september-transport-folder">
                    <summary>Transport Budget</summary>
                    <div class="folder-content">
                        <h4>Transport budget</h4>
                        <table id="septemberTransportTable" class="transport-table">
                            <thead>
                                <tr>
                                    <th>Branch</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Mahube</td>
                                    <td><input type="number" step="0.01" id="septemberMahubeAmount" onchange="saveSeptemberTransportAmount('mahube', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 4</td>
                                    <td><input type="number" step="0.01" id="septemberNelmaphiusExt4Amount" onchange="saveSeptemberTransportAmount('nelmaphiusExt4', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 6</td>
                                    <td><input type="number" step="0.01" id="septemberNelmaphiusExt6Amount" onchange="saveSeptemberTransportAmount('nelmaphiusExt6', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Phase 5</td>
                                    <td><input type="number" step="0.01" id="septemberPhase5Amount" onchange="saveSeptemberTransportAmount('phase5', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Mamelodi Ext5</td>
                                    <td><input type="number" step="0.01" id="septemberMamelodiExt5Amount" onchange="saveSeptemberTransportAmount('mamelodiExt5', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Kwamhlanga/kameel poort</td>
                                    <td><input type="number" step="0.01" id="septemberKwamhlangaKameelAmount" onchange="saveSeptemberTransportAmount('kwamhlangaKameel', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="septemberTransportTotal" class="budget-total">Total Transport Budget: 0.00</div>
                    </div>
                </details>
                <details id="september-conference-essentials-folder">
                    <summary>Conference Essentials</summary>
                    <div class="folder-content">
                        <h4>Conference Essentials</h4>
                        <table id="septemberConferenceEssentialsTable" class="essentials-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Water Bottles</td>
                                    <td><input type="number" step="0.01" id="septemberWaterBottlesAmount" onchange="saveSeptemberConferenceEssentialsAmount('waterBottles', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Juices</td>
                                    <td><input type="number" step="0.01" id="septemberJuicesAmount" onchange="saveSeptemberConferenceEssentialsAmount('juices', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Sweets</td>
                                    <td><input type="number" step="0.01" id="septemberSweetsAmount" onchange="saveSeptemberConferenceEssentialsAmount('sweets', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Toilet Paper</td>
                                    <td><input type="number" step="0.01" id="septemberToiletPaperAmount" onchange="saveSeptemberConferenceEssentialsAmount('toiletPaper', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Drumsticks</td>
                                    <td><input type="number" step="0.01" id="septemberDrumsticksAmount" onchange="saveSeptemberConferenceEssentialsAmount('drumsticks', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="septemberConferenceEssentialsTotal" class="budget-total">Total Conference Essentials: 0.00</div>
                    </div>
                </details>
                <details id="september-sunday-school-folder">
                    <summary>Sunday School Essentials</summary>
                    <div class="folder-content">
                        <h4>Sunday School Essentials</h4>
                        <table id="septemberSundaySchoolTable" class="sunday-school-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jumping Castle</td>
                                    <td><input type="number" step="0.01" id="septemberJumpingCastleAmount" onchange="saveSeptemberSundaySchoolAmount('jumpingCastle', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Snacks</td>
                                    <td><input type="number" step="0.01" id="septemberSnacksAmount" onchange="saveSeptemberSundaySchoolAmount('snacks', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>First Aid</td>
                                    <td><input type="number" step="0.01" id="septemberFirstAidAmount" onchange="saveSeptemberSundaySchoolAmount('firstAid', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Security</td>
                                    <td><input type="number" step="0.01" id="septemberSecurityAmount" onchange="saveSeptemberSundaySchoolAmount('security', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="septemberSundaySchoolTotal" class="budget-total">Total Sunday School Essentials: 0.00</div>
                    </div>
                </details>
                <details id="september-grocery-folder">
                    <summary>Grocery</summary>
                    <div class="folder-content">
                        <h4>Grocery</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Grocery Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkGroceryForm">
                                <input type="file" id="bulkGroceryCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addGroceryForm" class="add-item-form">
                            <input type="text" id="groceryItemName" placeholder="Item Name" required>
                            <input type="number" id="groceryItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="septemberGroceryTable" class="grocery-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="septemberGroceryTotal" class="budget-total">Total Grocery: 0.00</div>
                    </div>
                </details>
                <details id="september-sound-media-folder">
                    <summary>Sound and Media</summary>
                    <div class="folder-content">
                        <h4>Sound and Media</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Sound and Media Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkSoundMediaForm">
                                <input type="file" id="bulkSoundMediaCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addSoundMediaForm" class="add-item-form">
                            <input type="text" id="soundMediaItemName" placeholder="Item Name" required>
                            <input type="number" id="soundMediaItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="septemberSoundMediaTable" class="sound-media-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="septemberSoundMediaTotal" class="budget-total">Total Sound and Media: 0.00</div>
                    </div>
                </details>
                <details id="september-stage-deco-folder">
                    <summary>Stage and Deco</summary>
                    <div class="folder-content">
                        <h4>Stage and Deco</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Stage and Deco Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkStageDecoForm">
                                <input type="file" id="bulkStageDecoCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addStageDecoForm" class="add-item-form">
                            <input type="text" id="stageDecoItemName" placeholder="Item Name" required>
                            <input type="number" id="stageDecoItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="septemberStageDecoTable" class="stage-deco-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="septemberStageDecoTotal" class="budget-total">Total Stage and Deco: 0.00</div>
                    </div>
                </details>
                <details id="september-guest-pastor-folder">
                    <summary>Guest Pastor</summary>
                    <div class="folder-content">
                        <h4>Guest Pastor</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Guest Pastor Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkGuestPastorForm">
                                <input type="file" id="bulkGuestPastorCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addGuestPastorForm" class="add-item-form">
                            <input type="text" id="guestPastorItemName" placeholder="Item Name" required>
                            <input type="number" id="guestPastorItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="septemberGuestPastorTable" class="guest-pastor-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="septemberGuestPastorTotal" class="budget-total">Total Guest Pastor: 0.00</div>
                    </div>
                </details>
                <div id="septemberGrandTotal" class="grand-total">Grand Total: 0.00</div>
                <button id="septemberGenerateReportBtn" class="generate-report-btn">Generate Report 📊</button>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('september-conference')">Print</button>
                    <button class="export-btn" onclick="exportSeptemberBudget()">Download</button>
                    <button class="email-btn" onclick="emailSeptemberBudget()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('september-conference')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="send-contributor-message-folder">
            <summary>Send Conference Contributor Message</summary>
            <div class="folder-content">
                <form id="contributorWhatsAppForm" class="contributor-message-form">
                    <div class="conference-select">
                        <label for="conferenceSelect">Select Conference:</label>
                        <select id="conferenceSelect" onchange="populateContributorSelect()">
                            <option value="easter">Easter Conference</option>
                            <option value="september">September Conference</option>
                            <option value="combined">Combined Service</option>
                        </select>
                    </div>
                    <label for="contributorSelect">Select Contributor:</label>
                    <select id="contributorSelect" required></select>
                    <label for="contributorWhatsAppMessage">Message:</label>
                    <textarea id="contributorWhatsAppMessage" placeholder="Enter your message..." required></textarea>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="fillContributorTemplate('Thank you [Name] for your contribution of [Amount] to [Conference]. Your support blesses us!')">Thank You Note</button>
                        <button type="button" class="template-btn" onclick="fillContributorTemplate('Hello [Name], your [Amount] contribution to [Conference] is appreciated. Join us next event!')">Appreciation</button>
                        <button type="button" class="template-btn" onclick="fillContributorTemplate('Reminder [Name]: Additional contributions for [Conference] welcome. God bless!')">Reminder</button>
                    </div>
                    <button type="submit">Send via WhatsApp</button>
                </form>
            </div>
        </details>
    </div>

    <div id="tithe" class="content">
       <details id="tithe-directory-folder">
    <summary>Tithe and Offering Directory</summary>
    <div class="folder-content">
        <div class="bulk-upload">
            <h3>Bulk Upload Tithes (CSV)</h3>
            <p>CSV format: member,currency,amount,date,type,paymentMethod (paymentMethod optional, e.g., Cash, Credit Card, Bank Transfer)</p>
            <form id="bulkTitheForm">
                <input type="file" id="bulkTitheCsv" accept=".csv" required>
                <button type="submit">Upload CSV</button>
            </form>
        </div>
        <form id="titheForm">
            <input type="text" id="memberName" placeholder="Member Name" required>
            <select id="titheCurrency">
                <option value="ZAR">ZAR</option>
                <option value="USD">USD</option>
            </select>
            <input type="number" id="amount" placeholder="Amount" step="0.01" required>
            <input type="date" id="titheDate" required>
            <select id="titheType">
                <option value="Tithe">Tithe</option>
                <option value="Offering">Offering</option>
            </select>
            <select id="paymentMethod">  <!-- New field for payment options -->
                <option value="">Select Payment Method</option>
                <option value="Cash">Cash</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Mobile Payment">Mobile Payment (e.g., Zelle, M-Pesa)</option>
                <option value="Other">Other</option>
            </select>
            <button type="submit">Add Tithe</button>
        </form>
        <ul id="titheList" class="tithe-list">
            <!-- Tithes will be added here -->
        </ul>
        <div id="titheTotal" class="total"></div>
        <button id="generateTitheReportBtn" class="generate-report-btn">Generate Tithe Report 📊</button>
        <div class="folder-actions">
            <button class="print-btn" onclick="printFolder('tithe-directory')">Print</button>
            <button class="export-btn" onclick="exportTithes()">Export</button>
            <button class="email-btn" onclick="emailTithes()">Email</button>
            <button class="minimize-btn" onclick="toggleFolder('tithe-directory')">Minimize</button>
        </div>
    </div>
</details>
    </div>

    <div id="church-admin" class="content">
        <h2>Church Admin</h2>
        <details id="leaders-folder">
            <summary>Ministry Leaders</summary>
            <div class="folder-content">
                <form id="leaderForm">
                    <input type="text" id="leaderName" placeholder="Name" required>
                    <input type="text" id="ministry" placeholder="Ministry" required>
                    <input type="email" id="leaderEmail" placeholder="Email" required>
                    <input type="tel" id="leaderCell" placeholder="Cell Number" required>
                    <button type="submit">Add Leader</button>
                </form>
                <table id="leaderTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Ministry</th>
                            <th>Email</th>
                            <th>Cell</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Leaders will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('leaders')">Print</button>
                    <button class="export-btn" onclick="exportLeaders()">Export</button>
                    <button class="email-btn" onclick="emailLeaders()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('leaders')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="elders-folder">
            <summary>Elders</summary>
            <div class="folder-content">
                <form id="elderForm">
                    <input type="text" id="elderName" placeholder="Name" required>
                    <input type="email" id="elderEmail" placeholder="Email" required>
                    <input type="tel" id="elderCell" placeholder="Cell Number" required>
                    <button type="submit">Add Elder</button>
                </form>
                <table id="elderTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Cell</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Elders will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('elders')">Print</button>
                    <button class="export-btn" onclick="exportElders()">Export</button>
                    <button class="email-btn" onclick="emailElders()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('elders')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="cell-leaders-folder">
            <summary>Cell Leaders</summary>
            <div class="folder-content">
                <form id="cellLeaderForm">
                    <input type="text" id="cellLeaderName" placeholder="Name" required>
                    <select id="cellLeaderBranch">
                        <option value="">Select Branch</option>
                        <option value="Khutsong">Khutsong</option>
                        <option value="Mamelodi EXT5">Mamelodi EXT5</option>
                        <option value="Mahube">Mahube</option>
                        <option value="Phase 5">Phase 5</option>
                        <option value="Kwamhlanga">Kwamhlanga</option>
                        <option value="Kameel port">Kameel port</option>
                        <option value="Nelmaphius ext4">Nelmaphius ext4</option>
                        <option value="Nelmaphius ext 6">Nelmaphius ext 6</option>
                    </select>
                    <input type="email" id="cellLeaderEmail" placeholder="Email" required>
                    <input type="tel" id="cellLeaderCell" placeholder="Cell Number" required>
                    <button type="submit">Add Cell Leader</button>
                </form>
                <table id="cellLeaderTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Email</th>
                            <th>Cell</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Cell Leaders will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('cell-leaders')">Print</button>
                    <button class="export-btn" onclick="exportCellLeaders()">Export</button>
                    <button class="email-btn" onclick="emailCellLeaders()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('cell-leaders')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="branch-coordination-folder">
            <summary>Branch/Coordination</summary>
            <div class="folder-content">
                <form id="branchCoordForm">
                    <input type="text" id="branchCoordName" placeholder="Name" required>
                    <select id="branchCoordBranch">
                        <option value="">Select Branch</option>
                        <option value="Khutsong">Khutsong</option>
                        <option value="Mamelodi EXT5">Mamelodi EXT5</option>
                        <option value="Mahube">Mahube</option>
                        <option value="Phase 5">Phase 5</option>
                        <option value="Kwamhlanga">Kwamhlanga</option>
                        <option value="Kameel port">Kameel port</option>
                        <option value="Nelmaphius ext4">Nelmaphius ext4</option>
                        <option value="Nelmaphius ext 6">Nelmaphius ext 6</option>
                    </select>
                    <input type="email" id="branchCoordEmail" placeholder="Email" required>
                    <input type="tel" id="branchCoordCell" placeholder="Cell Number" required>
                    <textarea id="branchCoordNotes" placeholder="Coordination Notes"></textarea>
                    <button type="submit">Add Branch Coordinator</button>
                </form>
                <table id="branchCoordTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Email</th>
                            <th>Cell</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Branch Coordinators will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('branch-coordination')">Print</button>
                    <button class="export-btn" onclick="exportBranchCoords()">Export</button>
                    <button class="email-btn" onclick="emailBranchCoords()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('branch-coordination')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="pastors-folder">
            <summary>Pastors</summary>
            <div class="folder-content">
                <form id="pastorForm">
                    <input type="text" id="pastorName" placeholder="Name" required>
                    <select id="pastorBranch">
                        <option value="">Select Branch</option>
                        <option value="Khutsong">Khutsong</option>
                        <option value="Mamelodi EXT5">Mamelodi EXT5</option>
                        <option value="Mahube">Mahube</option>
                        <option value="Phase 5">Phase 5</option>
                        <option value="Kwamhlanga">Kwamhlanga</option>
                        <option value="Kameel port">Kameel port</option>
                        <option value="Nelmaphius ext4">Nelmaphius ext4</option>
                        <option value="Nelmaphius ext 6">Nelmaphius ext 6</option>
                    </select>
                    <input type="email" id="pastorEmail" placeholder="Email" required>
                    <input type="tel" id="pastorCell" placeholder="Cell Number" required>
                    <textarea id="pastorNotes" placeholder="Notes"></textarea>
                    <button type="submit">Add Pastor</button>
                </form>
                <table id="pastorTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Email</th>
                            <th>Cell Number</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Pastors will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('pastors')">Print</button>
                    <button class="export-btn" onclick="exportPastors()">Export</button>
                    <button class="email-btn" onclick="emailPastors()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('pastors')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="employees-management-folder">
            <summary>Employees</summary>
            <div class="folder-content">
                <form id="employeeForm">
                    <input type="text" id="empName" placeholder="Name" required>
                    <input type="email" id="empEmail" placeholder="Email" required>
                    <input type="text" id="empPosition" placeholder="Position" required>
                    <input type="date" id="empHireDate" required>
                    <input type="file" id="empCV" class="file-input" accept=".pdf,.doc,.docx">
                    <button type="submit">Add Employee</button>
                </form>
                <table id="employeeTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Position</th>
                            <th>Hire Date</th>
                            <th>CV File</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Employees will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('employees-management')">Print</button>
                    <button class="export-btn" onclick="exportEmployees()">Export</button>
                    <button class="email-btn" onclick="emailEmployees()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('employees-management')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="leave-requests-folder">
            <summary>Leave Requests</summary>
            <div class="folder-content">
                <h3>Leave Requests</h3>
                <form id="leaveForm">
                    <select id="empSelectForLeave" required></select>
                    <input type="date" id="leaveStart" required>
                    <input type="date" id="leaveEnd" required>
                    <select id="leaveType">
                        <option value="Annual">Annual Leave</option>
                        <option value="Sick">Sick Leave</option>
                        <option value="Maternity">Maternity Leave</option>
                    </select>
                    <textarea id="leaveReason" placeholder="Reason"></textarea>
                    <button type="submit">Submit Leave Request</button>
                </form>
                <ul id="leaveList" class="leave-list">
                    <!-- Leaves will be added here -->
                </ul>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('leave-requests')">Print</button>
                    <button class="export-btn" onclick="exportLeaves()">Export</button>
                    <button class="email-btn" onclick="emailLeaves()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('leave-requests')">Minimize</button>
                </div>
            </div>
        </details>
    </div>

    <div id="whatsapp" class="content">
        <h2>WhatsApp Interactions</h2>
        <details id="whatsapp-folder">
            <summary>Send Individual Messages</summary>
            <div class="folder-content">
                <form id="whatsappForm">
                    <label for="whatsappMemberSelect">Select Member:</label>
                    <select id="whatsappMemberSelect" required></select>
                    <label for="whatsappMessage">Message:</label>
                    <textarea id="whatsappMessage" placeholder="Enter your message..." required></textarea>
                    <button type="submit">Send via WhatsApp</button>
                </form>
                <div class="template-buttons">
                    <button type="button" class="template-btn" onclick="fillTemplate('Dear [Name], join us for Sunday service at 9 AM. God bless!')">Service Reminder</button>
                    <button type="button" class="template-btn" onclick="fillTemplate('Hello [Name], you are invited to the Easter Conference on [Date]. RSVP soon!')">Event Invite</button>
                    <button type="button" class="template-btn" onclick="fillTemplate('Thank you [Name] for your tithe. Your support is appreciated!')">Thank You Note</button>
                    <button type="button" class="template-btn" onclick="fillTemplate('Prayer request: [Details]. Let us pray together.')">Prayer Request</button>
                </div>
            </div>
        </details>
        <details id="whatsapp-broadcast-folder">
            <summary>Group Broadcasts</summary>
            <div class="folder-content">
                <form id="broadcastForm" class="broadcast-form">
                    <label for="broadcastMembers">Select Members (Hold Ctrl/Cmd to select multiple):</label>
                    <select id="broadcastMembers" class="broadcast-select" multiple required></select>
                    <label for="broadcastMessage">Broadcast Message:</label>
                    <textarea id="broadcastMessage" placeholder="Enter your broadcast message..." required></textarea>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="fillBroadcastTemplate('Join us for Sunday service at 9 AM. God bless!')">Service Reminder</button>
                        <button type="button" class="template-btn" onclick="fillBroadcastTemplate('You are all invited to the Easter Conference on [Date]. RSVP soon!')">Event Invite</button>
                        <button type="button" class="template-btn" onclick="fillBroadcastTemplate('Thank you for your continued support and tithes. Blessings!')">Thank You Note</button>
                        <button type="button" class="template-btn" onclick="fillBroadcastTemplate('Let us unite in prayer for [Details].')">Prayer Request</button>
                    </div>
                    <div class="broadcast-actions">
                        <button type="button" class="broadcast-btn" onclick="selectAllMembers()">Select All</button>
                        <button type="submit">Send Broadcast</button>
                    </div>
                    <p><small>Note: This will open WhatsApp links sequentially with a short delay. Ensure you have WhatsApp open.</small></p>
                </form>
            </div>
        </details>
        <details id="whatsapp-history-folder">
            <summary>Interaction History</summary>
            <div class="folder-content">
                <ul id="whatsappList" class="whatsapp-list whatsapp-history">
                    <!-- WhatsApp interactions will be added here -->
                </ul>
            </div>
        </details>
        <div class="folder-actions">
            <button class="print-btn" onclick="printFolder('whatsapp')">Print History</button>
            <button class="export-btn" onclick="exportWhatsAppInteractions()">Export History</button>
            <button class="email-btn" onclick="emailWhatsAppInteractions()">Email History</button>
            <button class="minimize-btn" onclick="toggleFolder('whatsapp-history')">Minimize History</button>
        </div>
    </div>

    <div id="vault" class="content">
        <h2>Vault - Reports Archive</h2>
        <details id="general-reports-folder">
            <summary>General Reports</summary>
            <div class="folder-content">
                <ul id="reportsList" class="report-list">
                    <!-- Reports will be added here -->
                </ul>
            </div>
        </details>
        <details id="tithe-vault-folder">
            <summary>Tithe/Offering Reports</summary>
            <div class="folder-content">
                <ul id="titheReportsList" class="report-list">
                    <!-- Tithe Reports will be added here -->
                </ul>
            </div>
        </details>
        <details id="visitors-vault-folder">
            <summary>Visitors Reports</summary>
            <div class="folder-content">
                <ul id="visitorReportsList" class="report-list">
                    <!-- Visitor Reports will be added here -->
                </ul>
            </div>
        </details>
        <button class="history-icon" onclick="toggleHistory()">📜 History</button>
        <div id="historySection" class="history-section">
            <ul id="historyList">
                <!-- History will be added here -->
            </ul>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // IndexedDB Setup
        const DB_NAME = 'ChurchManagementDB';
        const DB_VERSION = 5; // Incremented for new stores
        let db;

        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = function(event) {
            console.error('Database error: ' + event.target.errorCode);
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            loadAllData();
        };

        request.onupgradeneeded = function(event) {
            db = event.target.result;

            // Create object stores for each data type
            if (!db.objectStoreNames.contains('members')) {
                db.createObjectStore('members', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('visitors')) {
                db.createObjectStore('visitors', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('visitorFollowUps')) {
                db.createObjectStore('visitorFollowUps', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('visitorReminders')) {
                db.createObjectStore('visitorReminders', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('visitorReports')) {
                db.createObjectStore('visitorReports', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('events')) {
                db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('easterContributions')) {
                db.createObjectStore('easterContributions', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('septemberContributions')) {
                db.createObjectStore('septemberContributions', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('combinedContributions')) {
                db.createObjectStore('combinedContributions', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('tithes')) {
                db.createObjectStore('tithes', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('leaders')) {
                db.createObjectStore('leaders', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('elders')) {
                db.createObjectStore('elders', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('cellLeaders')) {
                db.createObjectStore('cellLeaders', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('branchCoordinators')) {
                db.createObjectStore('branchCoordinators', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('pastors')) {
                db.createObjectStore('pastors', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('employees')) {
                db.createObjectStore('employees', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('leaves')) {
                db.createObjectStore('leaves', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('reports')) {
                db.createObjectStore('reports', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('titheReports')) {
                db.createObjectStore('titheReports', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('historyReports')) {
                db.createObjectStore('historyReports', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('whatsappInteractions')) {
                db.createObjectStore('whatsappInteractions', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('transportBudget')) {
                db.createObjectStore('transportBudget', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('sundayEssentials')) {
                db.createObjectStore('sundayEssentials', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('sundaySchoolEssentials')) {
                db.createObjectStore('sundaySchoolEssentials', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('combinedDate')) {
                db.createObjectStore('combinedDate', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('easterTransportBudget')) {
                db.createObjectStore('easterTransportBudget', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('easterConferenceEssentials')) {
                db.createObjectStore('easterConferenceEssentials', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('easterSundaySchoolEssentials')) {
                db.createObjectStore('easterSundaySchoolEssentials', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('easterGrocery')) {
                db.createObjectStore('easterGrocery', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('easterSoundMedia')) {
                db.createObjectStore('easterSoundMedia', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('easterStageDeco')) {
                db.createObjectStore('easterStageDeco', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('easterGuestPastor')) {
                db.createObjectStore('easterGuestPastor', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('easterDate')) {
                db.createObjectStore('easterDate', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('septemberTransportBudget')) {
                db.createObjectStore('septemberTransportBudget', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('septemberConferenceEssentials')) {
                db.createObjectStore('septemberConferenceEssentials', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('septemberSundaySchoolEssentials')) {
                db.createObjectStore('septemberSundaySchoolEssentials', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('septemberGrocery')) {
                db.createObjectStore('septemberGrocery', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('septemberSoundMedia')) {
                db.createObjectStore('septemberSoundMedia', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('septemberStageDeco')) {
                db.createObjectStore('septemberStageDeco', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('septemberGuestPastor')) {
                db.createObjectStore('septemberGuestPastor', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('septemberDate')) {
                db.createObjectStore('septemberDate', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('combinedTransportBudget')) {
                db.createObjectStore('combinedTransportBudget', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('combinedConferenceEssentials')) {
                db.createObjectStore('combinedConferenceEssentials', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('combinedSundaySchoolEssentials')) {
                db.createObjectStore('combinedSundaySchoolEssentials', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('combinedGrocery')) {
                db.createObjectStore('combinedGrocery', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('combinedSoundMedia')) {
                db.createObjectStore('combinedSoundMedia', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('combinedStageDeco')) {
                db.createObjectStore('combinedStageDeco', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('combinedGuestPastor')) {
                db.createObjectStore('combinedGuestPastor', { keyPath: 'id', autoIncrement: true });
            }
        };

        // Generic functions for IndexedDB operations
        function addData(storeName, data) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.add(data);
            request.onsuccess = function() {
                loadData(storeName);
            };
        }

        function getAllData(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        function updateData(storeName, key, data) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put({ ...data, id: key });
            request.onsuccess = function() {
                loadData(storeName);
            };
        }

        function deleteData(storeName, id) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            store.delete(id);
            loadData(storeName);
        }

        async function loadData(storeName) {
            try {
                const data = await getAllData(storeName);
                window[`${storeName}`] = data;
                // Call specific render function if exists
                if (typeof window[`render${storeName.charAt(0).toUpperCase() + storeName.slice(1)}`] === 'function') {
                    window[`render${storeName.charAt(0).toUpperCase() + storeName.slice(1)}`]();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadAllData() {
            const stores = ['members', 'visitors', 'visitorFollowUps', 'visitorReminders', 'visitorReports', 'events', 'easterContributions', 'septemberContributions', 'combinedContributions', 'tithes', 'leaders', 'elders', 'cellLeaders', 'branchCoordinators', 'pastors', 'employees', 'leaves', 'reports', 'titheReports', 'historyReports', 'whatsappInteractions', 'easterGrocery', 'easterSoundMedia', 'easterStageDeco', 'easterGuestPastor', 'septemberGrocery', 'septemberSoundMedia', 'septemberStageDeco', 'septemberGuestPastor', 'combinedGrocery', 'combinedSoundMedia', 'combinedStageDeco', 'combinedGuestPastor'];
            for (const store of stores) {
                await loadData(store);
            }
            // Load budget objects
            const budgetStores = ['transportBudget', 'sundayEssentials', 'sundaySchoolEssentials', 'combinedDate', 'easterTransportBudget', 'easterConferenceEssentials', 'easterSundaySchoolEssentials', 'easterDate', 'septemberTransportBudget', 'septemberConferenceEssentials', 'septemberSundaySchoolEssentials', 'septemberDate', 'combinedTransportBudget', 'combinedConferenceEssentials', 'combinedSundaySchoolEssentials'];
            for (const store of budgetStores) {
                try {
                    const data = await getAllData(store);
                    window[store.replace(/([A-Z])/g, ' $1').toLowerCase().replace(/\b\w/g, l => l.toUpperCase())] = data.reduce((acc, item) => ({ ...acc, [item.key]: item.value || item }), {});
                } catch (error) {
                    console.error('Error loading budget data:', error);
                }
            }
            // Initial renders
            renderMembers();
            renderVisitors();
            renderVisitorFollowUps();
            renderVisitorReminders();
            renderVisitorReports();
            renderEvents();
            renderEasterContributions();
            renderSeptemberContributions();
            renderCombinedContributions();
            renderTithes();
            renderLeaders();
            renderElders();
            renderCellLeaders();
            renderBranchCoordinators();
            renderPastors();
            renderEmployees();
            renderLeaves();
            renderTitheReports();
            renderReports();
            renderHistory();
            renderWhatsAppInteractions();
            populateWhatsAppSelect();
            populateBroadcastSelect();
            populateVisitorWhatsAppSelect();
            populateFollowUpVisitorSelect();
            populateTitheMemberSelect();
            populateContributorSelect();
            updateAllTotals();
            updateEasterAllTotals();
            updateSeptemberAllTotals();
            updateCombinedAllTotals();
            updateAnalytics();
            checkReminders();
            setInterval(checkReminders, 60000); // Check every minute
        }

        // Data storage (now loaded from DB)
        let members = [];
        let visitors = [];
        let visitorFollowUps = [];
        let visitorReminders = [];
        let visitorReports = [];
        let events = [];
        let easterContributions = [];
        let septemberContributions = [];
        let combinedContributions = [];
        let tithes = [];
        let leaders = [];
        let elders = [];
        let cellLeaders = [];
        let branchCoordinators = [];
        let pastors = [];
        let employees = [];
        let leaves = [];
        let reports = [];
        let titheReports = [];
        let historyReports = [];
        let whatsappInteractions = [];
        let transportBudget = {};
        let sundayEssentials = {};
        let sundaySchoolEssentials = {};
        let combinedDate = '';
        let easterTransportBudget = {};
        let easterConferenceEssentials = {};
        let easterSundaySchoolEssentials = {};
        let easterGrocery = [];
        let easterSoundMedia = [];
        let easterStageDeco = [];
        let easterGuestPastor = [];
        let easterDate = '';
        let septemberTransportBudget = {};
        let septemberConferenceEssentials = {};
        let septemberSundaySchoolEssentials = {};
        let septemberGrocery = [];
        let septemberSoundMedia = [];
        let septemberStageDeco = [];
        let septemberGuestPastor = [];
        let septemberDate = '';
        let combinedTransportBudget = {};
        let combinedConferenceEssentials = {};
        let combinedSundaySchoolEssentials = {};
        let combinedGrocery = [];
        let combinedSoundMedia = [];
        let combinedStageDeco = [];
        let combinedGuestPastor = [];

        // Utility functions
        function showSection(sectionId) {
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if (sectionId === 'analytics') {
                updateAnalytics();
            }
        }

        function formatPhone(phone) {
            // Format for WhatsApp: remove non-digits except leading +, assume international
            return phone.replace(/[\s\-\(\)]/g, '').replace(/^0/, '+');
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').map(line => line.trim()).filter(line => line);
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i] || '';
                    return obj;
                }, {});
            });
        }

        function downloadCSV(data, filename, headers) {
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header] || '').join(','))
            ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function emailData(subject, body) {
            const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailto, '_blank');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // WhatsApp specific functions
        function populateWhatsAppSelect() {
            const select = document.getElementById('whatsappMemberSelect');
            select.innerHTML = '<option value="">Select a member</option>';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.cell;
                option.textContent = `${member.name} - ${member.cell}`;
                select.appendChild(option);
            });
        }

        function populateVisitorWhatsAppSelect() {
            const select = document.getElementById('visitorWhatsAppSelect');
            select.innerHTML = '<option value="">Select a visitor</option>';
            visitors.forEach(visitor => {
                if (!visitor.convertedDate) { // Only non-converted
                    const option = document.createElement('option');
                    option.value = visitor.cell;
                    option.textContent = `${visitor.name} - ${visitor.cell}`;
                    select.appendChild(option);
                }
            });
        }

        function populateTitheMemberSelect() {
            const select = document.getElementById('titheMemberSelect');
            select.innerHTML = '<option value="">Select a tither</option>';
            // Filter members who have tithes
            const tithers = members.filter(member => tithes.some(t => t.member === member.name));
            tithers.forEach(member => {
                const recentTithe = tithes.filter(t => t.member === member.name).slice(-1)[0];
                const option = document.createElement('option');
                option.value = member.cell;
                option.textContent = `${member.name} - ${member.cell} (Last Tithe: ${recentTithe ? recentTithe.amount : 'N/A'})`;
                select.appendChild(option);
            });
        }

        function populateContributorSelect() {
            const conference = document.getElementById('conferenceSelect').value;
            const select = document.getElementById('contributorSelect');
            select.innerHTML = '<option value="">Select a contributor</option>';
            let contributions = [];
            if (conference === 'easter') contributions = easterContributions;
            else if (conference === 'september') contributions = septemberContributions;
            else if (conference === 'combined') contributions = combinedContributions;
            contributions.forEach(contrib => {
                const member = members.find(m => m.name === contrib.member);
                if (member && member.cell) {
                    const option = document.createElement('option');
                    option.value = member.cell;
                    option.textContent = `${contrib.member} - ${member.cell} (Amount: ${contrib.amount})`;
                    option.dataset.amount = contrib.amount;
                    option.dataset.conference = conference;
                    select.appendChild(option);
                }
            });
        }

        function populateFollowUpVisitorSelect() {
            const select = document.getElementById('followUpVisitorSelect');
            select.innerHTML = '<option value="">Select a visitor</option>';
            visitors.forEach(visitor => {
                const option = document.createElement('option');
                option.value = visitor.id;
                option.textContent = `${visitor.name} - ${visitor.cell} ${visitor.convertedDate ? '(Converted)' : ''}`;
                select.appendChild(option);
            });
        }

        function populateBroadcastSelect() {
            const select = document.getElementById('broadcastMembers');
            select.innerHTML = '';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.cell;
                option.textContent = `${member.name} - ${member.cell}`;
                select.appendChild(option);
            });
        }

        function selectAllMembers() {
            const select = document.getElementById('broadcastMembers');
            for (let option of select.options) {
                option.selected = true;
            }
        }

        function fillTemplate(template) {
            const messageTextarea = document.getElementById('whatsappMessage');
            const selectedOption = document.getElementById('whatsappMemberSelect').selectedOptions[0];
            let personalized = template.replace(/\[Name\]/g, selectedOption ? selectedOption.textContent.split(' - ')[0] : '[Name]');
            messageTextarea.value = personalized;
        }

        function fillVisitorTemplate(template) {
            const messageTextarea = document.getElementById('visitorWhatsAppMessage');
            const selectedOption = document.getElementById('visitorWhatsAppSelect').selectedOptions[0];
            let personalized = template.replace(/\[Name\]/g, selectedOption ? selectedOption.textContent.split(' - ')[0] : '[Name]');
            messageTextarea.value = personalized;
        }

        function fillTitheTemplate(template) {
            const messageTextarea = document.getElementById('titheWhatsAppMessage');
            const selectedOption = document.getElementById('titheMemberSelect').selectedOptions[0];
            const name = selectedOption ? selectedOption.textContent.split(' - ')[0] : '[Name]';
            const recentTithe = tithes.filter(t => t.member === name).slice(-1)[0];
            let personalized = template.replace(/\[Name\]/g, name).replace(/\[Amount\]/g, recentTithe ? recentTithe.amount : 'your contribution');
            messageTextarea.value = personalized;
        }

        function fillContributorTemplate(template) {
            const messageTextarea = document.getElementById('contributorWhatsAppMessage');
            const selectedOption = document.getElementById('contributorSelect').selectedOptions[0];
            const name = selectedOption ? selectedOption.textContent.split(' - ')[0] : '[Name]';
            const amount = selectedOption ? selectedOption.dataset.amount : '[Amount]';
            const conference = selectedOption ? selectedOption.dataset.conference.charAt(0).toUpperCase() + selectedOption.dataset.conference.slice(1) : '[Conference]';
            let personalized = template.replace(/\[Name\]/g, name).replace(/\[Amount\]/g, amount).replace(/\[Conference\]/g, conference);
            messageTextarea.value = personalized;
        }

        function fillBroadcastTemplate(template) {
            const messageTextarea = document.getElementById('broadcastMessage');
            messageTextarea.value = template.replace(/\[Name\]/g, 'Dear Member');
        }

        function sendWhatsAppMessage(phone, message) {
            const formattedPhone = formatPhone(phone);
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${formattedPhone.replace('+', '')}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        function sendBroadcast(phones, message) {
            let delay = 0;
            phones.forEach(phone => {
                setTimeout(() => {
                    sendWhatsAppMessage(phone, message);
                }, delay);
                delay += 1000; // 1 second delay between opens
            });
        }

        function renderWhatsAppInteractions() {
            const list = document.getElementById('whatsappList');
            list.innerHTML = '';
            whatsappInteractions.sort((a, b) => new Date(b.date) - new Date(a.date)); // Latest first
            whatsappInteractions.forEach(interaction => {
                const li = document.createElement('li');
                li.classList.add('whatsapp-item');
                let name = 'Unknown', typeLabel = '';
                if (interaction.type === 'broadcast') {
                    li.innerHTML = `
                        <div class="whatsapp-item-details">
                            <strong>Broadcast to ${interaction.phones.length} members</strong><br>
                            <small>${interaction.date}</small><br>
                            <em>${interaction.message.substring(0, 50)}...</em>
                        </div>
                        <button class="delete-btn" onclick="deleteWhatsAppInteraction(${interaction.id})">Delete</button>
                    `;
                } else if (interaction.type === 'individual-visitor') {
                    const visitor = visitors.find(v => v.cell === interaction.phone) || { name: 'Unknown' };
                    name = visitor.name;
                    typeLabel = 'Visitor';
                    li.innerHTML = `
                        <div class="whatsapp-item-details">
                            <strong>To ${typeLabel}: ${name}</strong><br>
                            <small>${interaction.date}</small><br>
                            <em>${interaction.message.substring(0, 50)}...</em>
                        </div>
                        <button class="delete-btn" onclick="deleteWhatsAppInteraction(${interaction.id})">Delete</button>
                    `;
                } else if (interaction.type === 'tithe-message') {
                    const member = members.find(m => m.cell === interaction.phone) || { name: 'Unknown' };
                    name = member.name;
                    typeLabel = 'Tither';
                    li.innerHTML = `
                        <div class="whatsapp-item-details">
                            <strong>To ${typeLabel}: ${name}</strong><br>
                            <small>${interaction.date}</small><br>
                            <em>${interaction.message.substring(0, 50)}...</em>
                        </div>
                        <button class="delete-btn" onclick="deleteWhatsAppInteraction(${interaction.id})">Delete</button>
                    `;
                } else if (interaction.type === 'contributor-message') {
                    const member = members.find(m => m.cell === interaction.phone) || { name: 'Unknown' };
                    name = member.name;
                    typeLabel = 'Contributor';
                    li.innerHTML = `
                        <div class="whatsapp-item-details">
                            <strong>To ${typeLabel}: ${name}</strong><br>
                            <small>${interaction.date}</small><br>
                            <em>${interaction.message.substring(0, 50)}...</em>
                        </div>
                        <button class="delete-btn" onclick="deleteWhatsAppInteraction(${interaction.id})">Delete</button>
                    `;
                } else {
                    const member = members.find(m => m.cell === interaction.phone) || { name: 'Unknown' };
                    name = member.name;
                    typeLabel = 'Member';
                    li.innerHTML = `
                        <div class="whatsapp-item-details">
                            <strong>To ${typeLabel}: ${name}</strong><br>
                            <small>${interaction.date}</small><br>
                            <em>${interaction.message.substring(0, 50)}...</em>
                        </div>
                        <button class="delete-btn" onclick="deleteWhatsAppInteraction(${interaction.id})">Delete</button>
                    `;
                }
                list.appendChild(li);
            });
        }

        function deleteWhatsAppInteraction(id) {
            if (confirm('Delete this interaction?')) {
                deleteData('whatsappInteractions', id);
            }
        }

        function exportWhatsAppInteractions() {
            const headers = ['type', 'memberName', 'phone', 'message', 'date'];
            const exportData = whatsappInteractions.map(inter => {
                let memberName = '', phone = '';
                if (inter.type === 'broadcast') {
                    memberName = `${inter.phones.length} members`;
                    phone = inter.phones.join(',');
                } else {
                    let entity = members.find(m => m.cell === inter.phone) || visitors.find(v => v.cell === inter.phone) || { name: 'Unknown' };
                    memberName = entity.name;
                    phone = inter.phone;
                }
                return {
                    type: inter.type || 'individual',
                    memberName,
                    phone,
                    message: inter.message,
                    date: inter.date
                };
            });
            downloadCSV(exportData, 'whatsapp_interactions.csv', headers);
        }

        function emailWhatsAppInteractions() {
            const body = whatsappInteractions.map(inter => {
                let details = '';
                if (inter.type === 'broadcast') {
                    details = `Broadcast to ${inter.phones.length} members (${inter.phones.join(', ')})\n`;
                } else {
                    let entity = members.find(m => m.cell === inter.phone) || visitors.find(v => v.cell === inter.phone) || { name: 'Unknown' };
                    details = `To: ${entity.name} (${inter.phone})\n`;
                }
                return `${details}Date: ${inter.date}\nMessage: ${inter.message}\n\n`;
            }).join('');
            emailData('WhatsApp Interactions History', body);
        }

        // Visitor specific functions
        function convertToMember(visitorId) {
            if (confirm('Convert this visitor to member?')) {
                const visitor = visitors.find(v => v.id === visitorId);
                if (visitor) {
                    const memberData = {
                        name: visitor.name,
                        branch: visitor.branch,
                        email: visitor.email,
                        cell: visitor.cell,
                        address: visitor.address,
                        joinDate: new Date().toISOString().split('T')[0],
                        role: 'Member'
                    };
                    addData('members', memberData);
                    // Update visitor with converted date
                    visitor.convertedDate = new Date().toISOString().split('T')[0];
                    updateData('visitors', visitorId, visitor);
                    renderVisitors();
                    populateVisitorWhatsAppSelect();
                    alert('Visitor converted to member successfully!');
                }
            }
        }

        function renderVisitors() {
            const tbody = document.getElementById('visitorTable').querySelector('tbody');
            tbody.innerHTML = '';
            visitors.forEach(visitor => {
                const tr = document.createElement('tr');
                if (visitor.convertedDate) tr.classList.add('converted');
                const status = visitorFollowUps.filter(f => f.visitorId === visitor.id).slice(-1)[0]?.status || 'New';
                tr.innerHTML = `
                    <td>${visitor.name}</td>
                    <td>${visitor.branch}</td>
                    <td>${visitor.email || ''}</td>
                    <td>${visitor.cell}</td>
                    <td>${visitor.address || ''}</td>
                    <td>${visitor.visitDate}</td>
                    <td>${visitor.notes || ''}</td>
                    <td>${status} ${visitor.convertedDate ? `(Converted: ${visitor.convertedDate})` : ''}</td>
                    <td>
                        ${!visitor.convertedDate ? `<button class="convert-btn" onclick="convertToMember(${visitor.id})">Convert</button>` : ''}
                        <button class="delete-btn" onclick="deleteVisitor(${visitor.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            populateVisitorWhatsAppSelect();
            populateFollowUpVisitorSelect();
        }

        function deleteVisitor(id) {
            if (confirm('Delete this visitor?')) {
                deleteData('visitors', id);
            }
        }

        function searchVisitors() {
            const input = document.getElementById('visitorSearch').value.toLowerCase();
            const table = document.getElementById('visitorTable');
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(input) ? '' : 'none';
            });
        }

        function renderVisitorFollowUps() {
            const list = document.getElementById('followUpList');
            list.innerHTML = '';
            visitorFollowUps.sort((a, b) => new Date(b.date) - new Date(a.date));
            visitorFollowUps.forEach(followUp => {
                const visitor = visitors.find(v => v.id === followUp.visitorId);
                const li = document.createElement('li');
                li.classList.add('follow-up-item');
                li.innerHTML = `
                    <strong>${visitor ? visitor.name : 'Unknown'}</strong>: ${followUp.status} on ${followUp.date} - ${followUp.notes}
                    <button class="delete-btn" onclick="deleteFollowUp(${followUp.id})">Delete</button>
                `;
                list.appendChild(li);
            });
        }

        function deleteFollowUp(id) {
            if (confirm('Delete this follow-up?')) {
                deleteData('visitorFollowUps', id);
            }
        }

        function exportFollowUps() {
            const headers = ['visitorId', 'status', 'date', 'notes'];
            downloadCSV(visitorFollowUps, 'visitor_follow_ups.csv', headers);
        }

        function emailFollowUps() {
            const body = visitorFollowUps.map(f => {
                const visitor = visitors.find(v => v.id === f.visitorId) || { name: 'Unknown' };
                return `${visitor.name}: ${f.status} on ${f.date} - ${f.notes}\n`;
            }).join('\n');
            emailData('Visitor Follow-ups', body);
        }

        // Enhanced Follow-up Reminders functions
        function renderVisitorReminders() {
            const list = document.getElementById('reminderList');
            list.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            visitorReminders.sort((a, b) => {
                const dateA = new Date(a.reminderDate);
                const dateB = new Date(b.reminderDate);
                if (dateA < new Date()) return -1; // Overdue first
                if (dateB < new Date()) return 1;
                if (dateA.toISOString().split('T')[0] === today) return -1; // Due today next
                if (dateB.toISOString().split('T')[0] === today) return 1;
                return dateA - dateB; // Then by date
            });
            visitorReminders.forEach(reminder => {
                const visitor = visitors.find(v => v.id === reminder.visitorId);
                const followUp = visitorFollowUps.find(f => f.id === reminder.followUpId);
                const li = document.createElement('li');
                li.classList.add('reminder-item');
                const reminderDate = new Date(reminder.reminderDate);
                const isDue = reminderDate.toISOString().split('T')[0] === today;
                const isOverdue = reminderDate < new Date();
                if (isOverdue) li.classList.add('overdue');
                else if (isDue) li.classList.add('due');
                li.innerHTML = `
                    <strong>${visitor ? visitor.name : 'Unknown'}</strong> - Priority: ${isOverdue ? 'High (Overdue)' : isDue ? 'Medium (Today)' : 'Low'}<br>
                    Reminder: ${followUp ? followUp.status : 'N/A'} (${reminder.notes || ''})<br>
                    <small>Due: ${reminder.reminderDate} ${isDue ? '(Today!)' : isOverdue ? '(Overdue)' : ''}</small>
                    <button class="whatsapp-btn" onclick="sendReminderMessage(${reminder.id})">Send WhatsApp</button>
                    <button class="delete-btn" onclick="deleteReminder(${reminder.id})">Delete</button>
                `;
                list.appendChild(li);
            });
        }

        function bulkSendDueReminders() {
            const today = new Date().toISOString().split('T')[0];
            const dueReminders = visitorReminders.filter(r => new Date(r.reminderDate).toISOString().split('T')[0] === today);
            if (dueReminders.length === 0) {
                showNotification('No due reminders today.');
                return;
            }
            if (confirm(`Send reminders to ${dueReminders.length} visitors?`)) {
                dueReminders.forEach(reminder => {
                    sendReminderMessage(reminder.id);
                });
                showNotification(`${dueReminders.length} reminders sent!`);
            }
        }

        function sendReminderMessage(reminderId) {
            const reminder = visitorReminders.find(r => r.id === reminderId);
            const visitor = visitors.find(v => v.id === reminder.visitorId);
            if (visitor && visitor.cell) {
                const message = `Follow-up Reminder: Hi ${visitor.name}, regarding your visit - ${reminder.notes || 'we\'d love to connect'}. Join us Sunday! God bless!`;
                sendWhatsAppMessage(visitor.cell, message);
                // Log as interaction
                const interaction = {
                    type: 'individual-visitor',
                    phone: visitor.cell,
                    message: message,
                    date: new Date().toISOString().split('T')[0]
                };
                addData('whatsappInteractions', interaction);
                showNotification(`Reminder sent to ${visitor.name}`);
            }
        }

        function deleteReminder(id) {
            if (confirm('Delete this reminder?')) {
                deleteData('visitorReminders', id);
            }
        }

        function exportReminders() {
            const headers = ['visitorId', 'followUpId', 'reminderDate', 'notes'];
            downloadCSV(visitorReminders, 'visitor_reminders.csv', headers);
        }

        function emailReminders() {
            const body = visitorReminders.map(r => {
                const visitor = visitors.find(v => v.id === r.visitorId) || { name: 'Unknown' };
                return `${visitor.name}: Reminder on ${r.reminderDate} - ${r.notes || ''}\n`;
            }).join('\n');
            emailData('Visitor Reminders', body);
        }

        function checkReminders() {
            const today = new Date().toISOString().split('T')[0];
            const dueReminders = visitorReminders.filter(r => new Date(r.reminderDate).toISOString().split('T')[0] === today);
            if (dueReminders.length > 0) {
                showNotification(`${dueReminders.length} follow-up reminder(s) due today! Use bulk send.`);
            }
        }

        // Visitor Report functions
        function generateVisitorReport() {
            const totalVisitors = visitors.length;
            const converted = visitors.filter(v => v.convertedDate).length;
            const conversionRate = totalVisitors > 0 ? ((converted / totalVisitors) * 100).toFixed(2) : 0;
            const csvContent = `Visitors Report\nTotal Visitors: ${totalVisitors}\nConverted: ${converted}\nConversion Rate: ${conversionRate}%\n\nName,Branch,Email,Cell,Address,Visit Date,Converted Date,Notes\n${visitors.map(v => `${v.name},${v.branch},${v.email || ''},${v.cell},${v.address || ''},${v.visitDate},${v.convertedDate || ''},${v.notes || ''}`).join('\n')}`;
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Visitors_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            const report = {
                name: `Visitors Report ${new Date().toLocaleDateString()}`,
                date: new Date().toISOString(),
                content: csvContent
            };
            addData('visitorReports', report);
            addToHistory(report);
        }

        function renderVisitorReports() {
            const list = document.getElementById('visitorReportsList');
            list.innerHTML = '';
            visitorReports.forEach((report, index) => {
                const li = document.createElement('li');
                li.classList.add('report-item');
                li.innerHTML = `
                    <strong>${report.name}</strong> - ${new Date(report.date).toLocaleDateString()}<br>
                    <button class="report-download-btn" onclick="downloadVisitorReport(${index})">Download</button>
                    <button class="report-delete-btn" onclick="deleteVisitorReport(${index})">Delete</button>
                `;
                list.appendChild(li);
            });
        }

        function downloadVisitorReport(index) {
            const report = visitorReports[index];
            const blob = new Blob([report.content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function deleteVisitorReport(index) {
            if (confirm('Delete this report?')) {
                deleteData('visitorReports', visitorReports[index].id);
            }
        }

        // Analytics functions
        let visitorsChart, conversionChart;

        function updateAnalytics() {
            // Update stats
            const totalVisitors = visitors.length;
            const totalConverted = visitors.filter(v => v.convertedDate).length;
            const conversionRate = totalVisitors > 0 ? ((totalConverted / totalVisitors) * 100).toFixed(2) : 0;
            const pendingFollowUps = visitorFollowUps.filter(f => !visitors.find(v => v.id === f.visitorId)?.convertedDate).length;

            document.getElementById('totalVisitors').textContent = totalVisitors;
            document.getElementById('totalConverted').textContent = totalConverted;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
            document.getElementById('pendingFollowUps').textContent = pendingFollowUps;

            // Prepare data for charts
            const monthlyVisitors = {};
            visitors.forEach(v => {
                const month = new Date(v.visitDate).toISOString().slice(0, 7); // YYYY-MM
                monthlyVisitors[month] = (monthlyVisitors[month] || 0) + 1;
            });
            const months = Object.keys(monthlyVisitors).sort();
            const visitorsData = months.map(m => monthlyVisitors[m]);

            const statusData = {
                new: visitors.filter(v => !v.convertedDate && !visitorFollowUps.some(f => f.visitorId === v.id)).length,
                inProgress: visitors.filter(v => !v.convertedDate && visitorFollowUps.some(f => f.visitorId === v.id)).length,
                converted: totalConverted
            };

            // Visitors over time chart
            const ctx1 = document.getElementById('visitorsChart').getContext('2d');
            if (visitorsChart) visitorsChart.destroy();
            visitorsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Visitors',
                        data: visitorsData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Conversion status pie chart
            const ctx2 = document.getElementById('conversionChart').getContext('2d');
            if (conversionChart) conversionChart.destroy();
            conversionChart = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: ['New', 'In Progress', 'Converted'],
                    datasets: [{
                        data: [statusData.new, statusData.inProgress, statusData.converted],
                        backgroundColor: ['#e74c3c', '#f39c12', '#27ae60']
                    }]
                },
                options: { responsive: true }
            });
        }

        // Event listeners for visitors
        document.getElementById('visitorForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const visitor = {
                name: document.getElementById('visitorName').value,
                branch: document.getElementById('visitorBranch').value,
                email: document.getElementById('visitorEmail').value,
                cell: document.getElementById('visitorCell').value,
                address: document.getElementById('visitorAddress').value,
                visitDate: document.getElementById('visitorVisitDate').value || today,
                notes: document.getElementById('visitorNotes').value,
                convertedDate: null
            };
            addData('visitors', visitor);
            e.target.reset();
            document.getElementById('visitorVisitDate').value = today;
            updateAnalytics();
        });

        document.getElementById('followUpForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const followUp = {
                visitorId: parseInt(document.getElementById('followUpVisitorSelect').value),
                status: document.getElementById('followUpStatus').value,
                date: document.getElementById('followUpDate').value || today,
                notes: document.getElementById('followUpNotes').value,
                reminderDate: document.getElementById('followUpReminderDate').value
            };
            const addRequest = addData('visitorFollowUps', followUp);
            addRequest.onsuccess = function() {
                if (followUp.reminderDate) {
                    const reminder = {
                        visitorId: followUp.visitorId,
                        followUpId: followUp.id, // id is auto-incremented after add
                        reminderDate: followUp.reminderDate,
                        notes: `Follow up: ${followUp.status} - ${followUp.notes}`
                    };
                    addData('visitorReminders', reminder);
                }
            };
            e.target.reset();
            document.getElementById('followUpDate').value = today;
            updateAnalytics();
        });

        document.getElementById('visitorWhatsAppForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const phone = document.getElementById('visitorWhatsAppSelect').value;
            const message = document.getElementById('visitorWhatsAppMessage').value;
            if (!phone || !message) {
                alert('Please select a visitor and enter a message.');
                return;
            }
            sendWhatsAppMessage(phone, message);
            const interaction = {
                type: 'individual-visitor',
                phone: phone,
                message: message,
                date: new Date().toISOString().split('T')[0]
            };
            addData('whatsappInteractions', interaction);
            e.target.reset();
            document.getElementById('visitorWhatsAppSelect').selectedIndex = 0;
        });

        document.getElementById('contributorWhatsAppForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const phone = document.getElementById('contributorSelect').value;
            const message = document.getElementById('contributorWhatsAppMessage').value;
            if (!phone || !message) {
                alert('Please select a contributor and enter a message.');
                return;
            }
            sendWhatsAppMessage(phone, message);
            const interaction = {
                type: 'contributor-message',
                phone: phone,
                message: message,
                date: new Date().toISOString().split('T')[0]
            };
            addData('whatsappInteractions', interaction);
            e.target.reset();
            document.getElementById('contributorSelect').selectedIndex = 0;
        });

        document.getElementById('titheWhatsAppForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const phone = document.getElementById('titheMemberSelect').value;
            const message = document.getElementById('titheWhatsAppMessage').value;
            if (!phone || !message) {
                alert('Please select a tither and enter a message.');
                return;
            }
            sendWhatsAppMessage(phone, message);
            const interaction = {
                type: 'tithe-message',
                phone: phone,
                message: message,
                date: new Date().toISOString().split('T')[0]
            };
            addData('whatsappInteractions', interaction);
            e.target.reset();
            document.getElementById('titheMemberSelect').selectedIndex = 0;
        });

        document.getElementById('generateVisitorReportBtn').addEventListener('click', generateVisitorReport);

        // Bulk upload for visitors
        document.getElementById('bulkVisitorForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkVisitorCsv').files[0];
            if (!file) return alert('Please select a CSV file.');
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const csvData = parseCSV(event.target.result);
                    const today = new Date().toISOString().split('T')[0];
                    const newVisitors = csvData
                        .filter(row => row.name && row.cell)
                        .map(row => ({
                            name: row.name.trim(),
                            branch: row.branch || '',
                            email: row.email || '',
                            cell: row.cell,
                            address: row.address || '',
                            visitDate: row.visitDate || today,
                            notes: row.notes || '',
                            convertedDate: null
                        }));
                    newVisitors.forEach(visitor => addData('visitors', visitor));
                    alert(`${newVisitors.length} visitors added.`);
                    e.target.reset();
                    updateAnalytics();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        // Bulk upload for tithes
       document.getElementById('bulkTitheForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const file = document.getElementById('bulkTitheCsv').files[0];
    if (!file) return alert('Please select a CSV file.');
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const csvData = parseCSV(event.target.result);
            const today = new Date().toISOString().split('T')[0];
            const newTithes = csvData
                .filter(row => row.member && !isNaN(parseFloat(row.amount)))
                .map(row => ({
                    member: row.member.trim(),
                    currency: row.currency || 'ZAR',
                    amount: parseFloat(row.amount),
                    date: row.date || today,
                    type: row.type || 'Tithe',
                    paymentMethod: row.paymentmethod || 'Unknown'  // New field (case-insensitive)
                }));
            newTithes.forEach(tithe => addData('tithes', tithe));
            alert(`${newTithes.length} tithes added.`);
            e.target.reset();
            populateTitheMemberSelect();
        } catch (error) {
            alert('Error parsing CSV: ' + error.message);
        }
    };
    reader.readAsText(file);
});
        document.getElementById('titheForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const today = new Date().toISOString().split('T')[0];
    const tithe = {
        member: document.getElementById('memberName').value,
        currency: document.getElementById('titheCurrency').value,
        amount: parseFloat(document.getElementById('amount').value),
        date: document.getElementById('titheDate').value || today,
        type: document.getElementById('titheType').value,
        paymentMethod: document.getElementById('paymentMethod').value || 'Unknown'  // New field
    };
    addData('tithes', tithe);
    e.target.reset();
    document.getElementById('titheDate').value = today;
    populateTitheMemberSelect();
});

        document.getElementById('generateTitheReportBtn').addEventListener('click', generateTitheReport);

        // Combined Service renders and functions (similar to easter/september)
        function renderCombinedContributions() {
            const list = document.getElementById('combinedList');
            list.innerHTML = '';
            combinedContributions.forEach(contrib => {
                const li = document.createElement('li');
                li.classList.add('tithe-item');
                li.innerHTML = `
                    <strong>${contrib.member}</strong> - ${contrib.currency} ${contrib.amount} on ${contrib.date} - ${contrib.notes || ''}
                    <button class="delete-btn" onclick="deleteCombinedContribution(${contrib.id})">Delete</button>
                `;
                list.appendChild(li);
            });
            updateCombinedTotal();
        }

        function deleteCombinedContribution(id) {
            if (confirm('Delete this contribution?')) {
                deleteData('combinedContributions', id);
            }
        }

        function updateCombinedTotal() {
            const total = combinedContributions.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
            document.getElementById('combinedTotal').textContent = `Total: ${total.toFixed(2)}`;
        }

        // Bulk upload for combined
        document.getElementById('bulkCombinedContribForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkCombinedContribCsv').files[0];
            if (!file) return alert('Please select a CSV file.');
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const csvData = parseCSV(event.target.result);
                    const today = new Date().toISOString().split('T')[0];
                    const newContribs = csvData
                        .filter(row => row.member && !isNaN(parseFloat(row.amount)))
                        .map(row => ({
                            member: row.member.trim(),
                            currency: row.currency || 'ZAR',
                            amount: parseFloat(row.amount),
                            date: row.date || today,
                            notes: row.notes || ''
                        }));
                    newContribs.forEach(contrib => addData('combinedContributions', contrib));
                    alert(`${newContribs.length} contributions added.`);
                    e.target.reset();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('combinedForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const contrib = {
                member: document.getElementById('combinedMember').value,
                currency: document.getElementById('combinedCurrency').value,
                amount: parseFloat(document.getElementById('combinedAmount').value),
                date: document.getElementById('combinedDate').value || today,
                notes: document.getElementById('combinedNotes').value
            };
            addData('combinedContributions', contrib);
            e.target.reset();
            document.getElementById('combinedDate').value = today;
        });

        // Placeholder for other combined functions like saveCombinedTransportAmount, updateCombinedAllTotals, etc.
        // Assume they are implemented similarly to easter and september.

        // Branch Coordinator renders
        function renderBranchCoordinators() {
            const tbody = document.getElementById('branchCoordTable').querySelector('tbody');
            tbody.innerHTML = '';
            branchCoordinators.forEach(coord => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${coord.name}</td>
                    <td>${coord.branch}</td>
                    <td>${coord.email}</td>
                    <td>${coord.cell}</td>
                    <td>${coord.notes || ''}</td>
                    <td><button class="delete-btn" onclick="deleteBranchCoord(${coord.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteBranchCoord(id) {
            if (confirm('Delete this coordinator?')) {
                deleteData('branchCoordinators', id);
            }
        }

        function exportBranchCoords() {
            const headers = ['name', 'branch', 'email', 'cell', 'notes'];
            downloadCSV(branchCoordinators, 'branch_coordinators.csv', headers);
        }

        function emailBranchCoords() {
            const body = branchCoordinators.map(c => `${c.name} - ${c.branch} | ${c.email} | ${c.cell} | Notes: ${c.notes || 'N/A'}`).join('\n');
            emailData('Branch Coordinators', body);
        }

        document.getElementById('branchCoordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const coord = {
                name: document.getElementById('branchCoordName').value,
                branch: document.getElementById('branchCoordBranch').value,
                email: document.getElementById('branchCoordEmail').value,
                cell: document.getElementById('branchCoordCell').value,
                notes: document.getElementById('branchCoordNotes').value
            };
            addData('branchCoordinators', coord);
            e.target.reset();
        });

        // Folder toggle function
        function toggleFolder(folderId) {
            const details = document.getElementById(folderId + '-folder');
            if (details) {
                details.open = !details.open;
            }
        }

        // Export and email for visitors
        function exportVisitors() {
            const headers = ['name', 'branch', 'email', 'cell', 'address', 'visitDate', 'notes', 'convertedDate'];
            downloadCSV(visitors, 'visitors.csv', headers);
        }

        function emailVisitors() {
            const body = visitors.map(v => `${v.name} - ${v.branch} | ${v.email || 'N/A'} | ${v.cell} | Visit: ${v.visitDate} | Converted: ${v.convertedDate || 'No'}`).join('\n');
            emailData('Visitors Export', body);
        }

        // Other exports and emails...
        function exportLeaders() {
            const headers = ['name', 'ministry', 'email', 'cell'];
            downloadCSV(leaders, 'leaders.csv', headers);
        }

        // Implement printFolder as window.print()
        function printFolder(folderId) {
            window.print();
        }

        // History functions
        function addToHistory(report) {
            addData('historyReports', report);
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            section.classList.toggle('active');
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            historyReports.forEach(report => {
                const li = document.createElement('li');
                li.classList.add('history-report-item');
                li.textContent = `${report.name} - ${new Date(report.date).toLocaleDateString()}`;
                list.appendChild(li);
            });
        }

        // Placeholder renders
        function renderMembers() {
            // Implement as needed
        }

        function renderEvents() {
            // Implement as needed
        }

        function renderTithes() {
    const list = document.getElementById('titheList');
    list.innerHTML = '';
    tithes.forEach(tithe => {
        const li = document.createElement('li');
        li.classList.add('tithe-item');
        li.innerHTML = `
            <strong>${tithe.member}</strong> - ${tithe.currency} ${tithe.amount} on ${tithe.date} (${tithe.type}) via ${tithe.paymentMethod} 
            <button class="delete-btn" onclick="deleteTithe(${tithe.id})">Delete</button>
        `;
        list.appendChild(li);
    });
    const total = tithes.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
    document.getElementById('titheTotal').textContent = `Total: ${total.toFixed(2)}`;
}
        }

        function renderTitheReports() {
            // Implement as needed
        }

        function renderReports() {
            // Implement as needed
        }

        // Budget functions (unchanged)
        // ... (saveTransportAmount, updateAllTotals, etc.)

        // Generate tithe report (unchanged)
       function generateTitheReport() {
    const total = tithes.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
    const csvContent = `Tithe and Offering Report\nTotal: ${total.toFixed(2)}\n\nMember,Currency,Amount,Date,Type,PaymentMethod\n${tithes.map(t => `${t.member},${t.currency},${t.amount},${t.date},${t.type},${t.paymentMethod}`).join('\n')}`;
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Tithe_Report_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    const report = {
        name: `Tithe Report ${new Date().toLocaleDateString()}`,
        date: new Date().toISOString(),
        content: csvContent
    };
    addData('titheReports', report);
    addToHistory(report);
}

        // Search members placeholder
        function searchMembers() {
            // Implement as needed
        }

        // Broadcast form listener
        document.getElementById('broadcastForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedOptions = document.getElementById('broadcastMembers').selectedOptions;
            const phones = Array.from(selectedOptions).map(opt => opt.value);
            const message = document.getElementById('broadcastMessage').value;
            if (phones.length === 0 || !message) {
                alert('Please select members and enter a message.');
                return;
            }
            sendBroadcast(phones, message);
            const interaction = {
                type: 'broadcast',
                phones: phones,
                message: message,
                date: new Date().toISOString().split('T')[0]
            };
            addData('whatsappInteractions', interaction);
            e.target.reset();
        });

        // Individual WhatsApp form listener
        document.getElementById('whatsappForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const phone = document.getElementById('whatsappMemberSelect').value;
            const message = document.getElementById('whatsappMessage').value;
            if (!phone || !message) {
                alert('Please select a member and enter a message.');
                return;
            }
            sendWhatsAppMessage(phone, message);
            const interaction = {
                type: 'individual',
                phone: phone,
                message: message,
                date: new Date().toISOString().split('T')[0]
            };
            addData('whatsappInteractions', interaction);
            e.target.reset();
            document.getElementById('whatsappMemberSelect').selectedIndex = 0;
        });
    </script>
</body>

</html>
