<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity And Faith Mission Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        nav {
            background-color: #34495e;
            padding: 10px;
            text-align: center;
        }
        nav button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        nav button:hover {
            background-color: #2980b9;
        }
        nav button.active {
            background-color: #e74c3c;
        }
        .content {
            display: none;
            padding: 20px;
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        input, select, button, textarea, .file-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        select[multiple] {
            height: 150px;
        }
        input[readonly] {
            background-color: #f9f9f9;
        }
        .file-input {
            border: none;
            background-color: #f9f9f9;
        }
        button[type="submit"] {
            background-color: #27ae60;
            color: white;
            border: none;
            cursor: pointer;
        }
        button[type="submit"]:hover {
            background-color: #229954;
        }
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }
        .whatsapp-btn:hover {
            background-color: #128C7E;
        }
        a.whatsapp-link {
            color: #25D366;
            text-decoration: none;
        }
        a.whatsapp-link:hover {
            text-decoration: underline;
        }
        .event-list, .tithe-list, .assignment-list, .employee-list, .leave-list, .leader-list, .pastor-list, .cell-list, .elder-list, .report-list, .whatsapp-list, .follow-up-list, .reminder-list {
            list-style: none;
            padding: 0;
        }
        .event-item, .tithe-item, .assignment-item, .employee-item, .leave-item, .leader-item, .pastor-item, .cell-item, .elder-item, .report-item, .whatsapp-item, .follow-up-item, .reminder-item {
            background-color: #f9f9f9;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .reminder-item.due {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .reminder-item.overdue {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .total {
            font-weight: bold;
            background-color: #e8f5e8;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 1em;
        }
        .bulk-upload {
            margin-bottom: 20px;
        }
        .bulk-upload input[type="file"] {
            max-width: 300px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .search-container input {
            width: 100%;
            max-width: 300px;
        }
        .leaders-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .leaders-section {
            flex: 1;
            min-width: 300px;
        }
        .events-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .events-section {
            flex: 1;
            min-width: 300px;
        }
        details {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        summary {
            padding: 10px;
            background-color: #f2f2f2;
            cursor: pointer;
            font-weight: bold;
        }
        .folder-content {
            padding: 10px;
        }
        .folder-actions {
            margin-top: 10px;
            text-align: right;
        }
        .folder-actions button {
            margin-left: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .folder-actions .print-btn {
            background-color: #f39c12;
            color: white;
        }
        .folder-actions .export-btn {
            background-color: #3498db;
            color: white;
        }
        .folder-actions .email-btn {
            background-color: #27ae60;
            color: white;
        }
        .folder-actions .minimize-btn {
            background-color: #e74c3c;
            color: white;
        }
        .transport-table input, .essentials-table input, .sunday-school-table input, .grocery-table input, .sound-media-table input, .stage-deco-table input, .guest-pastor-table input {
            width: 100px;
        }
        .budget-date {
            margin-bottom: 10px;
        }
        .budget-total {
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            background-color: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 5px;
            text-align: center;
            font-size: 1em;
            color: #27ae60;
        }
        .grand-total {
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            background-color: #d4edda;
            border: 2px solid #28a745;
            border-radius: 5px;
            text-align: center;
            font-size: 1.1em;
            color: #155724;
        }
        .generate-report-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .generate-report-btn:hover {
            background-color: #2980b9;
        }
        .report-download-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }
        .report-delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .history-icon {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            margin: 10px;
            display: inline-block;
        }
        .history-section {
            display: none;
            margin-top: 20px;
        }
        .history-section.active {
            display: block;
        }
        .history-report-item {
            background-color: #f9f9f9;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        button.delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        button.convert-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .add-item-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .add-item-form input {
            flex: 1;
            min-width: 150px;
        }
        .add-item-form button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .template-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .template-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .template-btn:hover {
            background-color: #128C7E;
        }
        .whatsapp-history {
            margin-top: 20px;
        }
        .whatsapp-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .whatsapp-item-details {
            flex: 1;
        }
        .broadcast-form {
            max-width: 600px;
        }
        .broadcast-select {
            height: 200px;
        }
        .broadcast-actions {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .broadcast-btn {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .broadcast-btn:hover {
            background-color: #d35400;
        }
        .converted {
            background-color: #d4edda;
            font-style: italic;
        }
        .analytics-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: #e8f5e8;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #27ae60;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
            z-index: 1000;
            display: none;
        }
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .bulk-send-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .bulk-send-btn:hover {
            background-color: #128C7E;
        }
        .tithe-message-form, .contributor-message-form {
            max-width: 500px;
        }
        .conference-select {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Charity And Faith Mission Management System</h1>
        <p>Welcome to your church dashboard</p>
    </header>
    
    <nav>
        <button onclick="showSection('members', this)" class="active">Members</button>
        <button onclick="showSection('visitors', this)">Visitors</button>
        <button onclick="showSection('analytics', this)">Analytics</button>
        <button onclick="showSection('events', this)">Events</button>
        <button onclick="showSection('tithe', this)">Tithe & Offering</button>
        <button onclick="showSection('church-admin', this)">Church Admin</button>
        <button onclick="showSection('whatsapp', this)">WhatsApp Interactions</button>
        <button onclick="showSection('vault', this)">Vault</button>
    </nav>
    
    <div id="members" class="content active">
        <h2>Member Directory</h2>
        <div class="bulk-upload">
            <h3>Bulk Upload Members (CSV)</h3>
            <p>CSV format: name,email,cell,address,joinDate,role,branch (joinDate optional, defaults to today)</p>
            <form id="bulkMemberForm">
                <input type="file" id="bulkCsv" accept=".csv" required>
                <button type="submit">Upload CSV</button>
            </form>
        </div>
        <div class="search-container">
            <h3>Search Members</h3>
            <input type="text" id="memberSearch" placeholder="Search by name, email, cell, address, or role..." >
        </div>
        <details id="mdf-folder">
            <summary>MDF</summary>
            <div class="folder-content">
                <form id="memberForm">
                    <input type="text" id="name" placeholder="Full Name" required>
                    <select id="branch">
                        <option value="">Select Branch</option>
                        <option value="Khutsong">Khutsong</option>
                        <option value="Mamelodi EXT5">Mamelodi EXT5</option>
                        <option value="Mahube">Mahube</option>
                        <option value="Phase 5">Phase 5</option>
                        <option value="Kwamhlanga">Kwamhlanga</option>
                        <option value="Kameel Port">Kameel Port</option>
                        <option value="Nelmaphius ext4">Nelmaphius ext4</option>
                        <option value="Nelmaphius ext 6">Nelmaphius ext 6</option>
                    </select>
                    <input type="email" id="email" placeholder="Email" required>
                    <input type="tel" id="cell" placeholder="Cell Number (e.g., +1234567890)" required>
                    <input type="text" id="address" placeholder="Address" required>
                    <input type="date" id="joinDate" required>
                    <select id="role">
                        <option value="Member">Member</option>
                        <option value="Volunteer">Volunteer</option>
                        <option value="Leader">Leader</option>
                    </select>
                    <button type="submit">Add Member</button>
                </form>
                <table id="memberTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Email</th>
                            <th>Cell Number</th>
                            <th>Address</th>
                            <th>Join Date</th>
                            <th>Role</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Members will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('mdf')">Print</button>
                    <button class="export-btn" onclick="exportMembers()">Export</button>
                    <button class="email-btn" onclick="emailMembers()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('mdf')">Minimize</button>
                </div>
            </div>
        </details>
    </div>

    <div id="visitors" class="content">
        <h2>Visitor Directory</h2>
        <div class="bulk-upload">
            <h3>Bulk Upload Visitors (CSV)</h3>
            <p>CSV format: name,email,cell,address,visitDate,branch,notes (visitDate optional, defaults to today)</p>
            <form id="bulkVisitorForm">
                <input type="file" id="bulkVisitorCsv" accept=".csv" required>
                <button type="submit">Upload CSV</button>
            </form>
        </div>
        <div class="search-container">
            <h3>Search Visitors</h3>
            <input type="text" id="visitorSearch" placeholder="Search by name, email, cell, address, or branch..." >
        </div>
        <details id="visitor-directory-folder">
            <summary>Visitor Directory</summary>
            <div class="folder-content">
                <form id="visitorForm">
                    <input type="text" id="visitorName" placeholder="Full Name" required>
                    <select id="visitorBranch">
                        <option value="">Select Branch</option>
                        <option value="Khutsong">Khutsong</option>
                        <option value="Mamelodi EXT5">Mamelodi EXT5</option>
                        <option value="Mahube">Mahube</option>
                        <option value="Phase 5">Phase 5</option>
                        <option value="Kwamhlanga">Kwamhlanga</option>
                        <option value="Kameel Port">Kameel Port</option>
                        <option value="Nelmaphius ext4">Nelmaphius ext4</option>
                        <option value="Nelmaphius ext 6">Nelmaphius ext 6</option>
                    </select>
                    <input type="email" id="visitorEmail" placeholder="Email">
                    <input type="tel" id="visitorCell" placeholder="Cell Number (e.g., +1234567890)" required>
                    <input type="text" id="visitorAddress" placeholder="Address">
                    <input type="date" id="visitorVisitDate" required>
                    <textarea id="visitorNotes" placeholder="Notes (e.g., interests, follow-up needs)"></textarea>
                    <button type="submit">Add Visitor</button>
                </form>
                <table id="visitorTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Email</th>
                            <th>Cell Number</th>
                            <th>Address</th>
                            <th>Visit Date</th>
                            <th>Notes</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Visitors will be added here -->
                    </tbody>
                </table>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('visitor-directory')">Print</button>
                    <button class="export-btn" onclick="exportVisitors()">Export</button>
                    <button class="email-btn" onclick="emailVisitors()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('visitor-directory')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="follow-ups-folder">
            <summary>Visitor Follow-ups</summary>
            <div class="folder-content">
                <form id="followUpForm">
                    <select id="followUpVisitorSelect" required></select>
                    <select id="followUpStatus">
                        <option value="Contacted">Contacted</option>
                        <option value="Interested">Interested</option>
                        <option value="Joined">Joined</option>
                        <option value="Not Interested">Not Interested</option>
                    </select>
                    <input type="date" id="followUpDate">
                    <input type="date" id="followUpReminderDate" placeholder="Reminder Date">
                    <textarea id="followUpNotes" placeholder="Notes"></textarea>
                    <button type="submit">Log Follow-up</button>
                </form>
                <ul id="followUpList" class="follow-up-list">
                    <!-- Follow-ups will be added here -->
                </ul>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('follow-ups')">Print</button>
                    <button class="export-btn" onclick="exportFollowUps()">Export</button>
                    <button class="email-btn" onclick="emailFollowUps()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('follow-ups')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="follow-up-reminders-folder">
            <summary>Follow-up Reminders (Enhanced)</summary>
            <div class="folder-content">
                <p><strong>Enhanced Features:</strong> Bulk send for due reminders, priority sorting, and customizable templates.</p>
                <button class="bulk-send-btn" onclick="bulkSendDueReminders()">Bulk Send Due Reminders Today</button>
                <ul id="reminderList" class="reminder-list">
                    <!-- Reminders will be added here -->
                </ul>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('follow-up-reminders')">Print</button>
                    <button class="export-btn" onclick="exportReminders()">Export</button>
                    <button class="email-btn" onclick="emailReminders()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('follow-up-reminders')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="send-visitor-message-folder">
            <summary>Send Visitor Message</summary>
            <div class="folder-content">
                <form id="visitorWhatsAppForm" class="tithe-message-form">
                    <label for="visitorWhatsAppSelect">Select Visitor:</label>
                    <select id="visitorWhatsAppSelect" required></select>
                    <label for="visitorWhatsAppMessage">Message:</label>
                    <textarea id="visitorWhatsAppMessage" placeholder="Enter your message..." required></textarea>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="fillVisitorTemplate('Welcome [Name]! We\'re glad you visited us. Join us next Sunday at 9 AM. God bless!')">Welcome Message</button>
                        <button type="button" class="template-btn" onclick="fillVisitorTemplate('Hello [Name], we have a visitor follow-up class on [Date]. Interested? Reply yes!')">Follow-up Invite</button>
                        <button type="button" class="template-btn" onclick="fillVisitorTemplate('Thank you [Name] for visiting. How can we pray for you today?')">Prayer Offer</button>
                        <button type="button" class="template-btn" onclick="fillVisitorTemplate('Hi [Name], here\'s our church newsletter: [Link]. Blessings!')">Newsletter Share</button>
                    </div>
                    <button type="submit">Send via WhatsApp</button>
                </form>
            </div>
        </details>
        <button id="generateVisitorReportBtn" class="generate-report-btn">Generate Visitors Report ðŸ“Š</button>
    </div>

    <div id="analytics" class="content">
        <h2>Visitors Analytics Dashboard</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalVisitors">0</div>
                <div>Total Visitors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalConverted">0</div>
                <div>Converted to Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="conversionRate">0%</div>
                <div>Conversion Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingFollowUps">0</div>
                <div>Pending Follow-ups</div>
            </div>
        </div>
        <div class="analytics-container">
            <div class="chart-container">
                <h3>Visitors Over Time</h3>
                <canvas id="visitorsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Conversion Status</h3>
                <canvas id="conversionChart"></canvas>
            </div>
        </div>
    </div>
    
    <div id="events" class="content">
        <h2>Events</h2>
        <details id="events-folder">
            <summary>Events Folder</summary>
            <div class="folder-content">
                <h3>Event Calendar</h3>
                <form id="eventForm">
                    <input type="text" id="eventTitle" placeholder="Event Title" required>
                    <input type="date" id="eventDate" required>
                    <input type="time" id="eventTime" required>
                    <textarea id="eventDesc" placeholder="Description"></textarea>
                    <button type="submit">Add Event</button>
                </form>
                <ul id="eventList" class="event-list">
                    <!-- Events will be added here -->
                </ul>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('events')">Print</button>
                    <button class="export-btn" onclick="exportEvents()">Download</button>
                    <button class="email-btn" onclick="emailEvents()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('events')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="combined-service-folder">
            <summary>Combined Service Folder</summary>
            <div class="folder-content">
                <h3>Combined Service Contribution Directory</h3>
                <div class="bulk-upload">
                    <h4>Bulk Upload Contributions (CSV)</h4>
                    <p>CSV format: member,currency,amount,date,notes</p>
                    <form id="bulkCombinedContribForm">
                        <input type="file" id="bulkCombinedContribCsv" accept=".csv" required>
                        <button type="submit">Upload CSV</button>
                    </form>
                </div>
                <form id="combinedForm">
                    <input type="text" id="combinedMember" placeholder="Member Name" required>
                    <select id="combinedCurrency">
                        <option value="ZAR">ZAR</option>
                        <option value="USD">USD</option>
                    </select>
                    <input type="number" id="combinedAmount" placeholder="Amount" step="0.01" required>
                    <input type="date" id="combinedDate" required>
                    <textarea id="combinedNotes" placeholder="Notes"></textarea>
                    <button type="submit">Add Contribution</button>
                </form>
                <ul id="combinedList" class="tithe-list">
                    <!-- Combined contributions will be added here -->
                </ul>
                <div id="combinedTotal" class="total"></div>
                <div class="budget-date">
                    <label for="combinedDateBudget">Date:</label>
                    <input type="date" id="combinedDateBudget" onchange="saveCombinedDate(this.value)">
                </div>
                <details id="combined-transport-folder">
                    <summary>Transport Budget</summary>
                    <div class="folder-content">
                        <h4>Transport budget</h4>
                        <table id="combinedTransportTable" class="transport-table">
                            <thead>
                                <tr>
                                    <th>Branch</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Mahube</td>
                                    <td><input type="number" step="0.01" id="combinedMahubeAmount" onchange="saveCombinedTransportAmount('mahube', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 4</td>
                                    <td><input type="number" step="0.01" id="combinedNelmaphiusExt4Amount" onchange="saveCombinedTransportAmount('nelmaphiusExt4', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 6</td>
                                    <td><input type="number" step="0.01" id="combinedNelmaphiusExt6Amount" onchange="saveCombinedTransportAmount('nelmaphiusExt6', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Phase 5</td>
                                    <td><input type="number" step="0.01" id="combinedPhase5Amount" onchange="saveCombinedTransportAmount('phase5', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Mamelodi Ext5</td>
                                    <td><input type="number" step="0.01" id="combinedMamelodiExt5Amount" onchange="saveCombinedTransportAmount('mamelodiExt5', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Kwamhlanga/Kameel Port</td>
                                    <td><input type="number" step="0.01" id="combinedKwamhlangaKameelAmount" onchange="saveCombinedTransportAmount('kwamhlangaKameel', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="combinedTransportTotal" class="budget-total">Total Transport Budget: 0.00</div>
                    </div>
                </details>
                <details id="combined-conference-essentials-folder">
                    <summary>Conference Essentials</summary>
                    <div class="folder-content">
                        <h4>Conference Essentials</h4>
                        <table id="combinedConferenceEssentialsTable" class="essentials-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Water Bottles</td>
                                    <td><input type="number" step="0.01" id="combinedWaterBottlesAmount" onchange="saveCombinedConferenceEssentialsAmount('waterBottles', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Juices</td>
                                    <td><input type="number" step="0.01" id="combinedJuicesAmount" onchange="saveCombinedConferenceEssentialsAmount('juices', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Sweets</td>
                                    <td><input type="number" step="0.01" id="combinedSweetsAmount" onchange="saveCombinedConferenceEssentialsAmount('sweets', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Toilet Paper</td>
                                    <td><input type="number" step="0.01" id="combinedToiletPaperAmount" onchange="saveCombinedConferenceEssentialsAmount('toiletPaper', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Drumsticks</td>
                                    <td><input type="number" step="0.01" id="combinedDrumsticksAmount" onchange="saveCombinedConferenceEssentialsAmount('drumsticks', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="combinedConferenceEssentialsTotal" class="budget-total">Total Conference Essentials: 0.00</div>
                    </div>
                </details>
                <details id="combined-sunday-school-folder">
                    <summary>Sunday School Essentials</summary>
                    <div class="folder-content">
                        <h4>Sunday School Essentials</h4>
                        <table id="combinedSundaySchoolTable" class="sunday-school-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jumping Castle</td>
                                    <td><input type="number" step="0.01" id="combinedJumpingCastleAmount" onchange="saveCombinedSundaySchoolAmount('jumpingCastle', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Snacks</td>
                                    <td><input type="number" step="0.01" id="combinedSnacksAmount" onchange="saveCombinedSundaySchoolAmount('snacks', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>First Aid</td>
                                    <td><input type="number" step="0.01" id="combinedFirstAidAmount" onchange="saveCombinedSundaySchoolAmount('firstAid', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Security</td>
                                    <td><input type="number" step="0.01" id="combinedSecurityAmount" onchange="saveCombinedSundaySchoolAmount('security', this.value); updateCombinedAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="combinedSundaySchoolTotal" class="budget-total">Total Sunday School Essentials: 0.00</div>
                    </div>
                </details>
                <details id="combined-grocery-folder">
                    <summary>Grocery</summary>
                    <div class="folder-content">
                        <h4>Grocery</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Grocery Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkCombinedGroceryForm">
                                <input type="file" id="bulkCombinedGroceryCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addCombinedGroceryForm" class="add-item-form">
                            <input type="text" id="combinedGroceryItemName" placeholder="Item Name" required>
                            <input type="number" id="combinedGroceryItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="combinedGroceryTable" class="grocery-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="combinedGroceryTotal" class="budget-total">Total Grocery: 0.00</div>
                    </div>
                </details>
                <details id="combined-sound-media-folder">
                    <summary>Sound and Media</summary>
                    <div class="folder-content">
                        <h4>Sound and Media</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Sound and Media Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkCombinedSoundMediaForm">
                                <input type="file" id="bulkCombinedSoundMediaCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addCombinedSoundMediaForm" class="add-item-form">
                            <input type="text" id="combinedSoundMediaItemName" placeholder="Item Name" required>
                            <input type="number" id="combinedSoundMediaItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="combinedSoundMediaTable" class="sound-media-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="combinedSoundMediaTotal" class="budget-total">Total Sound and Media: 0.00</div>
                    </div>
                </details>
                <details id="combined-stage-deco-folder">
                    <summary>Stage and Deco</summary>
                    <div class="folder-content">
                        <h4>Stage and Deco</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Stage and Deco Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkCombinedStageDecoForm">
                                <input type="file" id="bulkCombinedStageDecoCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addCombinedStageDecoForm" class="add-item-form">
                            <input type="text" id="combinedStageDecoItemName" placeholder="Item Name" required>
                            <input type="number" id="combinedStageDecoItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="combinedStageDecoTable" class="stage-deco-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="combinedStageDecoTotal" class="budget-total">Total Stage and Deco: 0.00</div>
                    </div>
                </details>
                <details id="combined-guest-pastor-folder">
                    <summary>Guest Pastor</summary>
                    <div class="folder-content">
                        <h4>Guest Pastor</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Guest Pastor Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkCombinedGuestPastorForm">
                                <input type="file" id="bulkCombinedGuestPastorCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addCombinedGuestPastorForm" class="add-item-form">
                            <input type="text" id="combinedGuestPastorItemName" placeholder="Item Name" required>
                            <input type="number" id="combinedGuestPastorItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="combinedGuestPastorTable" class="guest-pastor-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="combinedGuestPastorTotal" class="budget-total">Total Guest Pastor: 0.00</div>
                    </div>
                </details>
                <div id="combinedGrandTotal" class="grand-total">Grand Total: 0.00</div>
                <button id="combinedGenerateReportBtn" class="generate-report-btn">Generate Report ðŸ“Š</button>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('combined-service')">Print</button>
                    <button class="export-btn" onclick="exportCombinedBudget()">Download</button>
                    <button class="email-btn" onclick="emailCombinedBudget()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('combined-service')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="easter-conference-folder">
            <summary>Easter Conference Folder</summary>
            <div class="folder-content">
                <h3>Easter Conference Contribution Directory</h3>
                <div class="bulk-upload">
                    <h4>Bulk Upload Contributions (CSV)</h4>
                    <p>CSV format: member,currency,amount,date,notes</p>
                    <form id="bulkEasterContribForm">
                        <input type="file" id="bulkEasterContribCsv" accept=".csv" required>
                        <button type="submit">Upload CSV</button>
                    </form>
                </div>
                <form id="easterForm">
                    <input type="text" id="easterMember" placeholder="Member Name" required>
                    <select id="easterCurrency">
                        <option value="ZAR">ZAR</option>
                        <option value="USD">USD</option>
                    </select>
                    <input type="number" id="easterAmount" placeholder="Amount" step="0.01" required>
                    <input type="date" id="easterDate" required>
                    <textarea id="easterNotes" placeholder="Notes"></textarea>
                    <button type="submit">Add Contribution</button>
                </form>
                <ul id="easterList" class="tithe-list">
                    <!-- Easter contributions will be added here -->
                </ul>
                <div id="easterTotal" class="total"></div>
                <div class="budget-date">
                    <label for="easterDateBudget">Date:</label>
                    <input type="date" id="easterDateBudget" onchange="saveEasterDate(this.value)">
                </div>
                <details id="easter-transport-folder">
                    <summary>Transport Budget</summary>
                    <div class="folder-content">
                        <h4>Transport budget</h4>
                        <table id="easterTransportTable" class="transport-table">
                            <thead>
                                <tr>
                                    <th>Branch</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Mahube</td>
                                    <td><input type="number" step="0.01" id="easterMahubeAmount" onchange="saveEasterTransportAmount('mahube', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 4</td>
                                    <td><input type="number" step="0.01" id="easterNelmaphiusExt4Amount" onchange="saveEasterTransportAmount('nelmaphiusExt4', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 6</td>
                                    <td><input type="number" step="0.01" id="easterNelmaphiusExt6Amount" onchange="saveEasterTransportAmount('nelmaphiusExt6', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Phase 5</td>
                                    <td><input type="number" step="0.01" id="easterPhase5Amount" onchange="saveEasterTransportAmount('phase5', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Mamelodi Ext5</td>
                                    <td><input type="number" step="0.01" id="easterMamelodiExt5Amount" onchange="saveEasterTransportAmount('mamelodiExt5', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Kwamhlanga/Kameel Port</td>
                                    <td><input type="number" step="0.01" id="easterKwamhlangaKameelAmount" onchange="saveEasterTransportAmount('kwamhlangaKameel', this.value); updateEasterAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="easterTransportTotal" class="budget-total">Total Transport Budget: 0.00</div>
                    </div>
                </details>
                <details id="easter-conference-essentials-folder">
                    <summary>Conference Essentials</summary>
                    <div class="folder-content">
                        <h4>Conference Essentials</h4>
                        <table id="easterConferenceEssentialsTable" class="essentials-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Water Bottles</td>
                                    <td><input type="number" step="0.01" id="easterWaterBottlesAmount" onchange="saveEasterConferenceEssentialsAmount('waterBottles', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Juices</td>
                                    <td><input type="number" step="0.01" id="easterJuicesAmount" onchange="saveEasterConferenceEssentialsAmount('juices', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Sweets</td>
                                    <td><input type="number" step="0.01" id="easterSweetsAmount" onchange="saveEasterConferenceEssentialsAmount('sweets', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Toilet Paper</td>
                                    <td><input type="number" step="0.01" id="easterToiletPaperAmount" onchange="saveEasterConferenceEssentialsAmount('toiletPaper', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Drumsticks</td>
                                    <td><input type="number" step="0.01" id="easterDrumsticksAmount" onchange="saveEasterConferenceEssentialsAmount('drumsticks', this.value); updateEasterAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="easterConferenceEssentialsTotal" class="budget-total">Total Conference Essentials: 0.00</div>
                    </div>
                </details>
                <details id="easter-sunday-school-folder">
                    <summary>Sunday School Essentials</summary>
                    <div class="folder-content">
                        <h4>Sunday School Essentials</h4>
                        <table id="easterSundaySchoolTable" class="sunday-school-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jumping Castle</td>
                                    <td><input type="number" step="0.01" id="easterJumpingCastleAmount" onchange="saveEasterSundaySchoolAmount('jumpingCastle', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Snacks</td>
                                    <td><input type="number" step="0.01" id="easterSnacksAmount" onchange="saveEasterSundaySchoolAmount('snacks', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>First Aid</td>
                                    <td><input type="number" step="0.01" id="easterFirstAidAmount" onchange="saveEasterSundaySchoolAmount('firstAid', this.value); updateEasterAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Security</td>
                                    <td><input type="number" step="0.01" id="easterSecurityAmount" onchange="saveEasterSundaySchoolAmount('security', this.value); updateEasterAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="easterSundaySchoolTotal" class="budget-total">Total Sunday School Essentials: 0.00</div>
                    </div>
                </details>
                <details id="easter-grocery-folder">
                    <summary>Grocery</summary>
                    <div class="folder-content">
                        <h4>Grocery</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Grocery Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkEasterGroceryForm">
                                <input type="file" id="bulkEasterGroceryCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addEasterGroceryForm" class="add-item-form">
                            <input type="text" id="easterGroceryItemName" placeholder="Item Name" required>
                            <input type="number" id="easterGroceryItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="easterGroceryTable" class="grocery-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="easterGroceryTotal" class="budget-total">Total Grocery: 0.00</div>
                    </div>
                </details>
                <details id="easter-sound-media-folder">
                    <summary>Sound and Media</summary>
                    <div class="folder-content">
                        <h4>Sound and Media</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Sound and Media Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkEasterSoundMediaForm">
                                <input type="file" id="bulkEasterSoundMediaCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addEasterSoundMediaForm" class="add-item-form">
                            <input type="text" id="easterSoundMediaItemName" placeholder="Item Name" required>
                            <input type="number" id="easterSoundMediaItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="easterSoundMediaTable" class="sound-media-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="easterSoundMediaTotal" class="budget-total">Total Sound and Media: 0.00</div>
                    </div>
                </details>
                <details id="easter-stage-deco-folder">
                    <summary>Stage and Deco</summary>
                    <div class="folder-content">
                        <h4>Stage and Deco</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Stage and Deco Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkEasterStageDecoForm">
                                <input type="file" id="bulkEasterStageDecoCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addEasterStageDecoForm" class="add-item-form">
                            <input type="text" id="easterStageDecoItemName" placeholder="Item Name" required>
                            <input type="number" id="easterStageDecoItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="easterStageDecoTable" class="stage-deco-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="easterStageDecoTotal" class="budget-total">Total Stage and Deco: 0.00</div>
                    </div>
                </details>
                <details id="easter-guest-pastor-folder">
                    <summary>Guest Pastor</summary>
                    <div class="folder-content">
                        <h4>Guest Pastor</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Guest Pastor Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkEasterGuestPastorForm">
                                <input type="file" id="bulkEasterGuestPastorCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addEasterGuestPastorForm" class="add-item-form">
                            <input type="text" id="easterGuestPastorItemName" placeholder="Item Name" required>
                            <input type="number" id="easterGuestPastorItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="easterGuestPastorTable" class="guest-pastor-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="easterGuestPastorTotal" class="budget-total">Total Guest Pastor: 0.00</div>
                    </div>
                </details>
                <div id="easterGrandTotal" class="grand-total">Grand Total: 0.00</div>
                <button id="easterGenerateReportBtn" class="generate-report-btn">Generate Report ðŸ“Š</button>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('easter-conference')">Print</button>
                    <button class="export-btn" onclick="exportEasterBudget()">Download</button>
                    <button class="email-btn" onclick="emailEasterBudget()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('easter-conference')">Minimize</button>
                </div>
            </div>
        </details>
        <details id="september-conference-folder">
            <summary>September Conference Folder</summary>
            <div class="folder-content">
                <h3>September Conference Contribution Directory</h3>
                <div class="bulk-upload">
                    <h4>Bulk Upload Contributions (CSV)</h4>
                    <p>CSV format: member,currency,amount,date,notes</p>
                    <form id="bulkSeptemberContribForm">
                        <input type="file" id="bulkSeptemberContribCsv" accept=".csv" required>
                        <button type="submit">Upload CSV</button>
                    </form>
                </div>
                <form id="septemberForm">
                    <input type="text" id="septemberMember" placeholder="Member Name" required>
                    <select id="septemberCurrency">
                        <option value="ZAR">ZAR</option>
                        <option value="USD">USD</option>
                    </select>
                    <input type="number" id="septemberAmount" placeholder="Amount" step="0.01" required>
                    <input type="date" id="septemberDate" required>
                    <textarea id="septemberNotes" placeholder="Notes"></textarea>
                    <button type="submit">Add Contribution</button>
                </form>
                <ul id="septemberList" class="tithe-list">
                    <!-- September contributions will be added here -->
                </ul>
                <div id="septemberTotal" class="total"></div>
                <div class="budget-date">
                    <label for="septemberDateBudget">Date:</label>
                    <input type="date" id="septemberDateBudget" onchange="saveSeptemberDate(this.value)">
                </div>
                <details id="september-transport-folder">
                    <summary>Transport Budget</summary>
                    <div class="folder-content">
                        <h4>Transport budget</h4>
                        <table id="septemberTransportTable" class="transport-table">
                            <thead>
                                <tr>
                                    <th>Branch</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Mahube</td>
                                    <td><input type="number" step="0.01" id="septemberMahubeAmount" onchange="saveSeptemberTransportAmount('mahube', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 4</td>
                                    <td><input type="number" step="0.01" id="septemberNelmaphiusExt4Amount" onchange="saveSeptemberTransportAmount('nelmaphiusExt4', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Nelmaphius ext 6</td>
                                    <td><input type="number" step="0.01" id="septemberNelmaphiusExt6Amount" onchange="saveSeptemberTransportAmount('nelmaphiusExt6', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Phase 5</td>
                                    <td><input type="number" step="0.01" id="septemberPhase5Amount" onchange="saveSeptemberTransportAmount('phase5', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Mamelodi Ext5</td>
                                    <td><input type="number" step="0.01" id="septemberMamelodiExt5Amount" onchange="saveSeptemberTransportAmount('mamelodiExt5', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Kwamhlanga/Kameel Port</td>
                                    <td><input type="number" step="0.01" id="septemberKwamhlangaKameelAmount" onchange="saveSeptemberTransportAmount('kwamhlangaKameel', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="septemberTransportTotal" class="budget-total">Total Transport Budget: 0.00</div>
                    </div>
                </details>
                <details id="september-conference-essentials-folder">
                    <summary>Conference Essentials</summary>
                    <div class="folder-content">
                        <h4>Conference Essentials</h4>
                        <table id="septemberConferenceEssentialsTable" class="essentials-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Water Bottles</td>
                                    <td><input type="number" step="0.01" id="septemberWaterBottlesAmount" onchange="saveSeptemberConferenceEssentialsAmount('waterBottles', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Juices</td>
                                    <td><input type="number" step="0.01" id="septemberJuicesAmount" onchange="saveSeptemberConferenceEssentialsAmount('juices', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Sweets</td>
                                    <td><input type="number" step="0.01" id="septemberSweetsAmount" onchange="saveSeptemberConferenceEssentialsAmount('sweets', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Toilet Paper</td>
                                    <td><input type="number" step="0.01" id="septemberToiletPaperAmount" onchange="saveSeptemberConferenceEssentialsAmount('toiletPaper', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Drumsticks</td>
                                    <td><input type="number" step="0.01" id="septemberDrumsticksAmount" onchange="saveSeptemberConferenceEssentialsAmount('drumsticks', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="septemberConferenceEssentialsTotal" class="budget-total">Total Conference Essentials: 0.00</div>
                    </div>
                </details>
                <details id="september-sunday-school-folder">
                    <summary>Sunday School Essentials</summary>
                    <div class="folder-content">
                        <h4>Sunday School Essentials</h4>
                        <table id="septemberSundaySchoolTable" class="sunday-school-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jumping Castle</td>
                                    <td><input type="number" step="0.01" id="septemberJumpingCastleAmount" onchange="saveSeptemberSundaySchoolAmount('jumpingCastle', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Snacks</td>
                                    <td><input type="number" step="0.01" id="septemberSnacksAmount" onchange="saveSeptemberSundaySchoolAmount('snacks', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>First Aid</td>
                                    <td><input type="number" step="0.01" id="septemberFirstAidAmount" onchange="saveSeptemberSundaySchoolAmount('firstAid', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                                <tr>
                                    <td>Security</td>
                                    <td><input type="number" step="0.01" id="septemberSecurityAmount" onchange="saveSeptemberSundaySchoolAmount('security', this.value); updateSeptemberAllTotals();"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="septemberSundaySchoolTotal" class="budget-total">Total Sunday School Essentials: 0.00</div>
                    </div>
                </details>
                <details id="september-grocery-folder">
                    <summary>Grocery</summary>
                    <div class="folder-content">
                        <h4>Grocery</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Grocery Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkSeptemberGroceryForm">
                                <input type="file" id="bulkSeptemberGroceryCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addSeptemberGroceryForm" class="add-item-form">
                            <input type="text" id="septemberGroceryItemName" placeholder="Item Name" required>
                            <input type="number" id="septemberGroceryItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="septemberGroceryTable" class="grocery-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="septemberGroceryTotal" class="budget-total">Total Grocery: 0.00</div>
                    </div>
                </details>
                <details id="september-sound-media-folder">
                    <summary>Sound and Media</summary>
                    <div class="folder-content">
                        <h4>Sound and Media</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Sound and Media Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkSeptemberSoundMediaForm">
                                <input type="file" id="bulkSeptemberSoundMediaCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addSeptemberSoundMediaForm" class="add-item-form">
                            <input type="text" id="septemberSoundMediaItemName" placeholder="Item Name" required>
                            <input type="number" id="septemberSoundMediaItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="septemberSoundMediaTable" class="sound-media-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="septemberSoundMediaTotal" class="budget-total">Total Sound and Media: 0.00</div>
                    </div>
                </details>
                <details id="september-stage-deco-folder">
                    <summary>Stage and Deco</summary>
                    <div class="folder-content">
                        <h4>Stage and Deco</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Stage and Deco Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkSeptemberStageDecoForm">
                                <input type="file" id="bulkSeptemberStageDecoCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addSeptemberStageDecoForm" class="add-item-form">
                            <input type="text" id="septemberStageDecoItemName" placeholder="Item Name" required>
                            <input type="number" id="septemberStageDecoItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="septemberStageDecoTable" class="stage-deco-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="septemberStageDecoTotal" class="budget-total">Total Stage and Deco: 0.00</div>
                    </div>
                </details>
                <details id="september-guest-pastor-folder">
                    <summary>Guest Pastor</summary>
                    <div class="folder-content">
                        <h4>Guest Pastor</h4>
                        <div class="bulk-upload">
                            <h5>Bulk Upload Guest Pastor Items (CSV)</h5>
                            <p>CSV format: item,amount</p>
                            <form id="bulkSeptemberGuestPastorForm">
                                <input type="file" id="bulkSeptemberGuestPastorCsv" accept=".csv" required>
                                <button type="submit">Upload CSV</button>
                            </form>
                        </div>
                        <form id="addSeptemberGuestPastorForm" class="add-item-form">
                            <input type="text" id="septemberGuestPastorItemName" placeholder="Item Name" required>
                            <input type="number" id="septemberGuestPastorItemAmount" placeholder="Amount" step="0.01" required>
                            <button type="submit">Add Item</button>
                        </form>
                        <table id="septemberGuestPastorTable" class="guest-pastor-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic items will be added here -->
                            </tbody>
                        </table>
                        <div id="septemberGuestPastorTotal" class="budget-total">Total Guest Pastor: 0.00</div>
                    </div>
                </details>
                <div id="septemberGrandTotal" class="grand-total">Grand Total: 0.00</div>
                <button id="septemberGenerateReportBtn" class="generate-report-btn">Generate Report ðŸ“Š</button>
                <div class="folder-actions">
                    <button class="print-btn" onclick="printFolder('september-conference')">Print</button>
                    <button class="export-btn" onclick="exportSeptemberBudget()">Download</button>
                    <button class="email-btn" onclick="emailSeptemberBudget()">Email</button>
                    <button class="minimize-btn" onclick="toggleFolder('september-conference')">Minimize</button>
                </div>
            </div>
        </details>
    </div>

    <div id="tithe" class="content">
        <h2>Tithe & Offering</h2>
        <div class="bulk-upload">
            <h3>Bulk Upload Tithes (CSV)</h3>
            <p>CSV format: member,currency,amount,date,type (type optional, defaults to Tithe)</p>
            <form id="bulkTitheForm">
                <input type="file" id="bulkTitheCsv" accept=".csv" required>
                <button type="submit">Upload CSV</button>
            </form>
        </div>
        <form id="titheForm">
            <input type="text" id="memberName" placeholder="Member Name" required>
            <select id="titheCurrency">
                <option value="ZAR">ZAR</option>
                <option value="USD">USD</option>
            </select>
            <input type="number" id="amount" placeholder="Amount" step="0.01" required>
            <input type="date" id="titheDate">
            <select id="titheType">
                <option value="Tithe">Tithe</option>
                <option value="Offering">Offering</option>
            </select>
            <button type="submit">Add Tithe</button>
        </form>
        <ul id="titheList" class="tithe-list">
            <!-- Tithes will be added here -->
        </ul>
        <div id="titheTotal" class="total"></div>
        <button id="generateTitheReportBtn" class="generate-report-btn">Generate Tithe Report ðŸ“Š</button>
        <details id="send-tithe-message-folder">
            <summary>Send Tithe Message</summary>
            <div class="folder-content">
                <form id="titheWhatsAppForm" class="tithe-message-form">
                    <label for="titheMemberSelect">Select Tither:</label>
                    <select id="titheMemberSelect" required></select>
                    <label for="titheWhatsAppMessage">Message:</label>
                    <textarea id="titheWhatsAppMessage" placeholder="Enter your message..." required></textarea>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="fillTitheTemplate('Thank you [Name] for your faithful [Amount]. God bless your giving!')">Thank You Message</button>
                        <button type="button" class="template-btn" onclick="fillTitheTemplate('Hi [Name], your recent [Amount] contribution is appreciated. Keep sowing!')">Appreciation</button>
                        <button type="button" class="template-btn" onclick="fillTitheTemplate('Dear [Name], remember Malachi 3:10 on your [Amount] tithe. Blessings!')">Scripture Reminder</button>
                    </div>
                    <button type="submit">Send via WhatsApp</button>
                </form>
            </div>
        </details>
    </div>

    <div id="church-admin" class="content">
        <h2>Church Admin</h2>
        <!-- Placeholder for admin sections: Leaders, Elders, etc. -->
        <details id="leaders-folder">
            <summary>Leaders</summary>
            <div class="folder-content">
                <!-- Form and table for leaders -->
            </div>
        </details>
        <!-- Similar for other admin sections -->
    </div>

    <div id="whatsapp" class="content">
        <h2>WhatsApp Interactions</h2>
        <details id="broadcast-folder">
            <summary>Broadcast Message</summary>
            <div class="folder-content">
                <form id="broadcastForm" class="broadcast-form">
                    <select id="broadcastMembers" multiple class="broadcast-select"></select>
                    <button type="button" onclick="selectAllMembers()">Select All</button>
                    <textarea id="broadcastMessage" placeholder="Broadcast message..." required></textarea>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="fillBroadcastTemplate('Dear [Name], join us for Sunday service at 9 AM! God bless.')">Sunday Invite</button>
                        <button type="button" class="template-btn" onclick="fillBroadcastTemplate('Prayer meeting tonight at 7 PM. See you there!')">Prayer Meeting</button>
                    </div>
                    <button type="submit" class="broadcast-btn">Send Broadcast</button>
                </form>
            </div>
        </details>
        <details id="individual-message-folder">
            <summary>Individual Message</summary>
            <div class="folder-content">
                <form id="whatsappForm">
                    <select id="whatsappMemberSelect" required></select>
                    <textarea id="whatsappMessage" placeholder="Enter your message..." required></textarea>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="fillTemplate('Hi [Name], how are you? Let\'s connect soon.')">General Check-in</button>
                    </div>
                    <button type="submit">Send via WhatsApp</button>
                </form>
            </div>
        </details>
        <details id="send-contributor-message-folder">
            <summary>Send Contributor Message</summary>
            <div class="folder-content">
                <form id="contributorWhatsAppForm" class="contributor-message-form">
                    <label for="conferenceSelect">Conference:</label>
                    <select id="conferenceSelect" class="conference-select" onchange="populateContributorSelect()">
                        <option value="easter">Easter</option>
                        <option value="september">September</option>
                        <option value="combined">Combined</option>
                    </select>
                    <label for="contributorSelect">Select Contributor:</label>
                    <select id="contributorSelect" required></select>
                    <label for="contributorWhatsAppMessage">Message:</label>
                    <textarea id="contributorWhatsAppMessage" placeholder="Enter your message..." required></textarea>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="fillContributorTemplate('Thank you [Name] for your [Amount] to the [Conference]! Blessings.')">Thank You</button>
                        <button type="button" class="template-btn" onclick="fillContributorTemplate('Hi [Name], update on [Conference]: Your [Amount] is making an impact!')">Update</button>
                    </div>
                    <button type="submit">Send via WhatsApp</button>
                </form>
            </div>
        </details>
        <h3>Interaction History</h3>
        <ul id="whatsappList" class="whatsapp-list">
            <!-- WhatsApp interactions will be added here -->
        </ul>
        <div class="folder-actions">
            <button class="export-btn" onclick="exportWhatsAppInteractions()">Export</button>
            <button class="email-btn" onclick="emailWhatsAppInteractions()">Email</button>
        </div>
    </div>

    <div id="vault" class="content">
        <h2>Vault (Reports History)</h2>
        <button class="history-icon" onclick="toggleHistory()">ðŸ“œ</button>
        <div id="historySection" class="history-section">
            <ul id="historyList">
                <!-- History reports will be added here -->
            </ul>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Enhanced and Optimized JavaScript
        var db;
        const request = indexedDB.open('ChurchDB', 1);
        request.onerror = () => console.error('Database failed to open');
        request.onsuccess = () => {
            db = request.result;
            loadAllData();
        };
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            // Create all object stores
            const listStores = ['members', 'visitors', 'visitorFollowUps', 'visitorReminders', 'visitorReports', 'events', 'easterContributions', 'septemberContributions', 'combinedContributions', 'tithes', 'leaders', 'elders', 'cellLeaders', 'branchCoordinators', 'pastors', 'employees', 'leaves', 'reports', 'titheReports', 'historyReports', 'whatsappInteractions', 'easterGrocery', 'easterSoundMedia', 'easterStageDeco', 'easterGuestPastor', 'septemberGrocery', 'septemberSoundMedia', 'septemberStageDeco', 'septemberGuestPastor', 'combinedGrocery', 'combinedSoundMedia', 'combinedStageDeco', 'combinedGuestPastor'];
            listStores.forEach(storeName => {
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                }
            });
            const budgetStores = ['combinedDate', 'easterDate', 'septemberDate', 'combinedTransportBudget', 'combinedConferenceEssentials', 'combinedSundaySchoolEssentials', 'easterTransportBudget', 'easterConferenceEssentials', 'easterSundaySchoolEssentials', 'septemberTransportBudget', 'septemberConferenceEssentials', 'septemberSundaySchoolEssentials'];
            budgetStores.forEach(storeName => {
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName, { keyPath: 'id' });
                }
            });
        };

        // Global cache for totals (memoization)
        const totalsCache = new Map();

        // Debounce utility
        function debounce(fn, delay = 300) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        // Optimized loadData with change detection
        async function loadData(storeName) {
            try {
                const data = await getAllData(storeName);
                const prevData = window[storeName] || [];
                window[storeName] = data;
                if (JSON.stringify(data) !== JSON.stringify(prevData)) {
                    const renderFunc = window[`render${storeName.charAt(0).toUpperCase() + storeName.slice(1)}`];
                    if (renderFunc && typeof renderFunc === 'function') renderFunc();
                }
            } catch (error) {
                console.error(`Error loading ${storeName}:`, error);
            }
        }

        // Optimized loadAllData (parallel)
        async function loadAllData() {
            const stores = ['members', 'visitors', 'visitorFollowUps', 'visitorReminders', 'visitorReports', 'events', 'easterContributions', 'septemberContributions', 'combinedContributions', 'tithes', 'leaders', 'elders', 'cellLeaders', 'branchCoordinators', 'pastors', 'employees', 'leaves', 'reports', 'titheReports', 'historyReports', 'whatsappInteractions', 'easterGrocery', 'easterSoundMedia', 'easterStageDeco', 'easterGuestPastor', 'septemberGrocery', 'septemberSoundMedia', 'septemberStageDeco', 'septemberGuestPastor', 'combinedGrocery', 'combinedSoundMedia', 'combinedStageDeco', 'combinedGuestPastor'];
            await Promise.allSettled(stores.map(store => loadData(store)));
            // Load budget objects similarly
            const budgetStores = ['combinedDate', 'easterDate', 'septemberDate', 'combinedTransportBudget', 'combinedConferenceEssentials', 'combinedSundaySchoolEssentials', 'easterTransportBudget', 'easterConferenceEssentials', 'easterSundaySchoolEssentials', 'septemberTransportBudget', 'septemberConferenceEssentials', 'septemberSundaySchoolEssentials'];
            await Promise.allSettled(budgetStores.map(async (store) => {
                try {
                    const data = await getAllData(store);
                    if (data.length > 0) {
                        const item = data[0];
                        delete item.id;
                        if (store === 'easterDate') {
                            easterDate = item.date || '';
                        } else if (store === 'septemberDate') {
                            septemberDate = item.date || '';
                        } else if (store === 'combinedDate') {
                            combinedDate = item.date || '';
                        } else if (store === 'easterTransportBudget') {
                            easterTransportBudget = item;
                        } else if (store === 'easterConferenceEssentials') {
                            easterConferenceEssentials = item;
                        } else if (store === 'easterSundaySchoolEssentials') {
                            easterSundaySchoolEssentials = item;
                        } else if (store === 'septemberTransportBudget') {
                            septemberTransportBudget = item;
                        } else if (store === 'septemberConferenceEssentials') {
                            septemberConferenceEssentials = item;
                        } else if (store === 'septemberSundaySchoolEssentials') {
                            septemberSundaySchoolEssentials = item;
                        } else if (store === 'combinedTransportBudget') {
                            combinedTransportBudget = item;
                        } else if (store === 'combinedConferenceEssentials') {
                            combinedConferenceEssentials = item;
                        } else if (store === 'combinedSundaySchoolEssentials') {
                            combinedSundaySchoolEssentials = item;
                        }
                    }
                } catch (error) {
                    console.error('Error loading budget data:', error);
                }
            }));
            // Initial renders and updates
            renderMembers();
            renderVisitors();
            renderVisitorFollowUps();
            renderVisitorReminders();
            renderVisitorReports();
            renderEvents();
            renderEasterContributions();
            renderSeptemberContributions();
            renderCombinedContributions();
            renderTithes();
            renderLeaders();
            renderElders();
            renderCellLeaders();
            renderBranchCoordinators();
            renderPastors();
            renderEmployees();
            renderLeaves();
            renderTitheReports();
            renderReports();
            renderHistory();
            renderWhatsAppInteractions();
            populateWhatsAppSelect();
            populateBroadcastSelect();
            populateVisitorWhatsAppSelect();
            populateFollowUpVisitorSelect();
            populateTitheMemberSelect();
            populateContributorSelect();
            updateEasterAllTotals();
            updateSeptemberAllTotals();
            updateCombinedAllTotals();
            updateAnalytics();
            checkReminders();
            setInterval(checkReminders, 60000);
        }

        // Memoized total calculator
        function calculateTotal(data, key = 'amount') {
            const cacheKey = `${data.length}_${key}`;
            if (totalsCache.has(cacheKey)) return totalsCache.get(cacheKey);
            const total = data.reduce((sum, item) => sum + parseFloat(item[key] || 0), 0);
            totalsCache.set(cacheKey, total);
            return total;
        }

        // Generic functions for IndexedDB operations (with batch add)
        function addData(storeName, data) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.add(data);
            request.onsuccess = () => loadData(storeName);
            return request;
        }

        function batchAdd(storeName, items) {
            const tx = db.transaction([storeName], 'readwrite');
            const store = tx.objectStore(storeName);
            items.forEach(item => store.add(item));
            return new Promise((resolve, reject) => {
                tx.oncomplete = resolve;
                tx.onerror = reject;
            });
        }

        function getAllData(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function updateData(storeName, key, data) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put({ ...data, id: key });
            request.onsuccess = () => loadData(storeName);
        }

        function deleteData(storeName, id) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            store.delete(id);
            loadData(storeName);
        }

        // Data storage variables (loaded from DB)
        var members = [], visitors = [], visitorFollowUps = [], visitorReminders = [], visitorReports = [], events = [], easterContributions = [], septemberContributions = [], combinedContributions = [], tithes = [], leaders = [], elders = [], cellLeaders = [], branchCoordinators = [], pastors = [], employees = [], leaves = [], reports = [], titheReports = [], historyReports = [], whatsappInteractions = [];
        var easterTransportBudget = {}, easterConferenceEssentials = {}, easterSundaySchoolEssentials = {}, easterGrocery = [], easterSoundMedia = [], easterStageDeco = [], easterGuestPastor = [], easterDate = '', septemberTransportBudget = {}, septemberConferenceEssentials = {}, septemberSundaySchoolEssentials = {}, septemberGrocery = [], septemberSoundMedia = [], septemberStageDeco = [], septemberGuestPastor = [], septemberDate = '', combinedTransportBudget = {}, combinedConferenceEssentials = {}, combinedSundaySchoolEssentials = {}, combinedGrocery = [], combinedSoundMedia = [], combinedStageDeco = [], combinedGuestPastor = [], combinedDate = '';

        // Utility functions
        function showSection(sectionId, button) {
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            if (sectionId === 'analytics') updateAnalytics();
        }

        function formatPhone(phone) {
            return phone.replace(/[\s\-\(\)]/g, '').replace(/^0/, '+');
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').map(line => line.trim()).filter(line => line);
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i] || '';
                    return obj;
                }, {});
            });
        }

        function downloadCSV(data, filename, headers) {
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header] || '').join(','))
            ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function emailData(subject, body) {
            const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailto, '_blank');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => notification.classList.remove('show'), 5000);
        }

        // September Conference Functions
        function renderSeptemberContributions() {
            const list = document.getElementById('septemberList');
            if (!list) return;
            const fragment = document.createDocumentFragment();
            septemberContributions.forEach(contrib => {
                const li = document.createElement('li');
                li.classList.add('tithe-item');
                li.innerHTML = `<strong>${contrib.member}</strong> - ${contrib.currency} ${contrib.amount} on ${contrib.date} - ${contrib.notes || ''}`;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
            const total = calculateTotal(septemberContributions);
            document.getElementById('septemberTotal').textContent = `Total: ${total.toFixed(2)}`;
        }

        document.getElementById('septemberForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const contrib = {
                member: document.getElementById('septemberMember').value,
                currency: document.getElementById('septemberCurrency').value,
                amount: parseFloat(document.getElementById('septemberAmount').value),
                date: document.getElementById('septemberDate').value || today,
                notes: document.getElementById('septemberNotes').value
            };
            addData('septemberContributions', contrib);
            e.target.reset();
            document.getElementById('septemberDate').value = today;
            renderSeptemberContributions();
            showNotification('September contribution added!');
        });

        document.getElementById('bulkSeptemberContribForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkSeptemberContribCsv').files[0];
            if (!file) return alert('Please select a CSV file.');
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvData = parseCSV(event.target.result);
                    const today = new Date().toISOString().split('T')[0];
                    const newContribs = csvData.filter(row => row.member && row.amount).map(row => ({
                        member: row.member.trim(),
                        currency: row.currency || 'ZAR',
                        amount: parseFloat(row.amount),
                        date: row.date || today,
                        notes: row.notes || ''
                    }));
                    await batchAdd('septemberContributions', newContribs);
                    showNotification(`${newContribs.length} September contributions added.`);
                    e.target.reset();
                    renderSeptemberContributions();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function saveSeptemberTransportAmount(branch, amount) {
            if (!septemberTransportBudget[branch]) septemberTransportBudget[branch] = 0;
            septemberTransportBudget[branch] = parseFloat(amount) || 0;
            updateData('septemberTransportBudget', 'septemberTransportBudget', septemberTransportBudget);
            updateSeptemberAllTotals();
        }

        function saveSeptemberConferenceEssentialsAmount(item, amount) {
            if (!septemberConferenceEssentials[item]) septemberConferenceEssentials[item] = 0;
            septemberConferenceEssentials[item] = parseFloat(amount) || 0;
            updateData('septemberConferenceEssentials', 'septemberConferenceEssentials', septemberConferenceEssentials);
            updateSeptemberAllTotals();
        }

        function saveSeptemberSundaySchoolAmount(item, amount) {
            if (!septemberSundaySchoolEssentials[item]) septemberSundaySchoolEssentials[item] = 0;
            septemberSundaySchoolEssentials[item] = parseFloat(amount) || 0;
            updateData('septemberSundaySchoolEssentials', 'septemberSundaySchoolEssentials', septemberSundaySchoolEssentials);
            updateSeptemberAllTotals();
        }

        function saveSeptemberDate(date) {
            septemberDate = date;
            updateData('septemberDate', 'septemberDate', { date });
        }

        function updateSeptemberAllTotals() {
            const transportTotal = Object.values(septemberTransportBudget).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('septemberTransportTotal').textContent = `Total Transport Budget: ${transportTotal.toFixed(2)}`;
            const confEssTotal = Object.values(septemberConferenceEssentials).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('septemberConferenceEssentialsTotal').textContent = `Total Conference Essentials: ${confEssTotal.toFixed(2)}`;
            const sundaySchoolTotal = Object.values(septemberSundaySchoolEssentials).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('septemberSundaySchoolTotal').textContent = `Total Sunday School Essentials: ${sundaySchoolTotal.toFixed(2)}`;
            const groceryTotal = calculateTotal(septemberGrocery);
            document.getElementById('septemberGroceryTotal').textContent = `Total Grocery: ${groceryTotal.toFixed(2)}`;
            const soundMediaTotal = calculateTotal(septemberSoundMedia);
            document.getElementById('septemberSoundMediaTotal').textContent = `Total Sound and Media: ${soundMediaTotal.toFixed(2)}`;
            const stageDecoTotal = calculateTotal(septemberStageDeco);
            document.getElementById('septemberStageDecoTotal').textContent = `Total Stage and Deco: ${stageDecoTotal.toFixed(2)}`;
            const guestPastorTotal = calculateTotal(septemberGuestPastor);
            document.getElementById('septemberGuestPastorTotal').textContent = `Total Guest Pastor: ${guestPastorTotal.toFixed(2)}`;
            const contribTotal = calculateTotal(septemberContributions);
            document.getElementById('septemberTotal').textContent = `Total Contributions: ${contribTotal.toFixed(2)}`;
            const grandTotal = transportTotal + confEssTotal + sundaySchoolTotal + groceryTotal + soundMediaTotal + stageDecoTotal + guestPastorTotal + contribTotal;
            document.getElementById('septemberGrandTotal').textContent = `Grand Total: ${grandTotal.toFixed(2)}`;
        }

        // Render September Grocery
        function renderSeptemberGrocery() {
            const tbody = document.getElementById('septemberGroceryTable').querySelector('tbody');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            septemberGrocery.forEach((item) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.amount}</td>
                    <td><button class="delete-btn" onclick="deleteSeptemberGrocery(${item.id})">Delete</button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function deleteSeptemberGrocery(id) {
            deleteData('septemberGrocery', id);
        }

        document.getElementById('addSeptemberGroceryForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const item = {
                name: document.getElementById('septemberGroceryItemName').value,
                amount: parseFloat(document.getElementById('septemberGroceryItemAmount').value)
            };
            addData('septemberGrocery', item);
            e.target.reset();
            renderSeptemberGrocery();
            updateSeptemberAllTotals();
        });

        document.getElementById('bulkSeptemberGroceryForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkSeptemberGroceryCsv').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = parseCSV(event.target.result);
                const newItems = csvData.map(row => ({
                    name: row.item,
                    amount: parseFloat(row.amount)
                }));
                await batchAdd('septemberGrocery', newItems);
                renderSeptemberGrocery();
                updateSeptemberAllTotals();
            };
            reader.readAsText(file);
        });

        // Similar implementations for September Sound Media, Stage Deco, Guest Pastor
        function renderSeptemberSoundMedia() {
            const tbody = document.getElementById('septemberSoundMediaTable').querySelector('tbody');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            septemberSoundMedia.forEach((item) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.amount}</td>
                    <td><button class="delete-btn" onclick="deleteSeptemberSoundMedia(${item.id})">Delete</button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function deleteSeptemberSoundMedia(id) {
            deleteData('septemberSoundMedia', id);
        }

        document.getElementById('addSeptemberSoundMediaForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const item = {
                name: document.getElementById('septemberSoundMediaItemName').value,
                amount: parseFloat(document.getElementById('septemberSoundMediaItemAmount').value)
            };
            addData('septemberSoundMedia', item);
            e.target.reset();
            renderSeptemberSoundMedia();
            updateSeptemberAllTotals();
        });

        document.getElementById('bulkSeptemberSoundMediaForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkSeptemberSoundMediaCsv').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = parseCSV(event.target.result);
                const newItems = csvData.map(row => ({
                    name: row.item,
                    amount: parseFloat(row.amount)
                }));
                await batchAdd('septemberSoundMedia', newItems);
                renderSeptemberSoundMedia();
                updateSeptemberAllTotals();
            };
            reader.readAsText(file);
        });

        function renderSeptemberStageDeco() {
            const tbody = document.getElementById('septemberStageDecoTable').querySelector('tbody');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            septemberStageDeco.forEach((item) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.amount}</td>
                    <td><button class="delete-btn" onclick="deleteSeptemberStageDeco(${item.id})">Delete</button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function deleteSeptemberStageDeco(id) {
            deleteData('septemberStageDeco', id);
        }

        document.getElementById('addSeptemberStageDecoForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const item = {
                name: document.getElementById('septemberStageDecoItemName').value,
                amount: parseFloat(document.getElementById('septemberStageDecoItemAmount').value)
            };
            addData('septemberStageDeco', item);
            e.target.reset();
            renderSeptemberStageDeco();
            updateSeptemberAllTotals();
        });

        document.getElementById('bulkSeptemberStageDecoForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkSeptemberStageDecoCsv').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = parseCSV(event.target.result);
                const newItems = csvData.map(row => ({
                    name: row.item,
                    amount: parseFloat(row.amount)
                }));
                await batchAdd('septemberStageDeco', newItems);
                renderSeptemberStageDeco();
                updateSeptemberAllTotals();
            };
            reader.readAsText(file);
        });

        function renderSeptemberGuestPastor() {
            const tbody = document.getElementById('septemberGuestPastorTable').querySelector('tbody');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            septemberGuestPastor.forEach((item) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.amount}</td>
                    <td><button class="delete-btn" onclick="deleteSeptemberGuestPastor(${item.id})">Delete</button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function deleteSeptemberGuestPastor(id) {
            deleteData('septemberGuestPastor', id);
        }

        document.getElementById('addSeptemberGuestPastorForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const item = {
                name: document.getElementById('septemberGuestPastorItemName').value,
                amount: parseFloat(document.getElementById('septemberGuestPastorItemAmount').value)
            };
            addData('septemberGuestPastor', item);
            e.target.reset();
            renderSeptemberGuestPastor();
            updateSeptemberAllTotals();
        });

        document.getElementById('bulkSeptemberGuestPastorForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkSeptemberGuestPastorCsv').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = parseCSV(event.target.result);
                const newItems = csvData.map(row => ({
                    name: row.item,
                    amount: parseFloat(row.amount)
                }));
                await batchAdd('septemberGuestPastor', newItems);
                renderSeptemberGuestPastor();
                updateSeptemberAllTotals();
            };
            reader.readAsText(file);
        });

        // Generate September report
        document.getElementById('septemberGenerateReportBtn')?.addEventListener('click', generateSeptemberReport);

        function generateSeptemberReport() {
            const transportTotal = Object.values(septemberTransportBudget).reduce((sum, val) => sum + val, 0);
            const reportData = {
                date: septemberDate,
                transport: septemberTransportBudget,
                essentials: septemberConferenceEssentials,
                sundaySchool: septemberSundaySchoolEssentials,
                grocery: septemberGrocery,
                soundMedia: septemberSoundMedia,
                stageDeco: septemberStageDeco,
                guestPastor: septemberGuestPastor,
                contributions: septemberContributions,
                total: calculateTotal(septemberContributions) + transportTotal + Object.values(septemberConferenceEssentials).reduce((sum, val) => sum + val, 0) + Object.values(septemberSundaySchoolEssentials).reduce((sum, val) => sum + val, 0) + calculateTotal(septemberGrocery) + calculateTotal(septemberSoundMedia) + calculateTotal(septemberStageDeco) + calculateTotal(septemberGuestPastor)
            };
            let csvContent = `September Conference Report\nDate: ${reportData.date}\nGrand Total: ${reportData.total.toFixed(2)}\n\nContributions:\n`;
            csvContent += reportData.contributions.map(c => `${c.member},${c.currency},${c.amount},${c.date},${c.notes || ''}`).join('\n') + '\n\n';
            csvContent += `Transport:\n${Object.entries(reportData.transport).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Conference Essentials:\n${Object.entries(reportData.essentials).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Sunday School:\n${Object.entries(reportData.sundaySchool).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Grocery:\n${reportData.grocery.map(g => `${g.name},${g.amount}`).join('\n')}\n\n`;
            csvContent += `Sound and Media:\n${reportData.soundMedia.map(s => `${s.name},${s.amount}`).join('\n')}\n\n`;
            csvContent += `Stage and Deco:\n${reportData.stageDeco.map(s => `${s.name},${s.amount}`).join('\n')}\n\n`;
            csvContent += `Guest Pastor:\n${reportData.guestPastor.map(g => `${g.name},${g.amount}`).join('\n')}\n\n`;
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `September_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            const report = { name: `September Report ${new Date().toLocaleDateString()}`, date: new Date().toISOString(), content: csvContent };
            addData('reports', report);
            addToHistory(report);
            showNotification('September report generated!');
        }

        function exportSeptemberBudget() {
            const headers = ['section', 'item', 'amount'];
            let data = [];
            // Transport
            Object.entries(septemberTransportBudget).forEach(([branch, amount]) => data.push({ section: 'Transport', item: branch, amount: amount.toFixed(2) }));
            // Conference Essentials
            Object.entries(septemberConferenceEssentials).forEach(([item, amount]) => data.push({ section: 'Conference Essentials', item, amount: amount.toFixed(2) }));
            // Sunday School
            Object.entries(septemberSundaySchoolEssentials).forEach(([item, amount]) => data.push({ section: 'Sunday School', item, amount: amount.toFixed(2) }));
            // Grocery
            septemberGrocery.forEach(g => data.push({ section: 'Grocery', item: g.name, amount: g.amount.toFixed(2) }));
            // Sound Media
            septemberSoundMedia.forEach(s => data.push({ section: 'Sound and Media', item: s.name, amount: s.amount.toFixed(2) }));
            // Stage Deco
            septemberStageDeco.forEach(s => data.push({ section: 'Stage and Deco', item: s.name, amount: s.amount.toFixed(2) }));
            // Guest Pastor
            septemberGuestPastor.forEach(g => data.push({ section: 'Guest Pastor', item: g.name, amount: g.amount.toFixed(2) }));
            downloadCSV(data, 'september_budget.csv', headers);
        }

        function emailSeptemberBudget() {
            const summary = `September Budget Summary\nGrand Total: ${document.getElementById('septemberGrandTotal').textContent}\nTransport: ${document.getElementById('septemberTransportTotal').textContent}\n... (full details in attachment)`;
            emailData('September Budget', summary);
        }

        // Easter Conference Functions (Symmetric to September)
        function renderEasterContributions() {
            const list = document.getElementById('easterList');
            if (!list) return;
            const fragment = document.createDocumentFragment();
            easterContributions.forEach(contrib => {
                const li = document.createElement('li');
                li.classList.add('tithe-item');
                li.innerHTML = `<strong>${contrib.member}</strong> - ${contrib.currency} ${contrib.amount} on ${contrib.date} - ${contrib.notes || ''}`;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
            const total = calculateTotal(easterContributions);
            document.getElementById('easterTotal').textContent = `Total: ${total.toFixed(2)}`;
        }

        document.getElementById('easterForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const contrib = {
                member: document.getElementById('easterMember').value,
                currency: document.getElementById('easterCurrency').value,
                amount: parseFloat(document.getElementById('easterAmount').value),
                date: document.getElementById('easterDate').value || today,
                notes: document.getElementById('easterNotes').value
            };
            addData('easterContributions', contrib);
            e.target.reset();
            document.getElementById('easterDate').value = today;
            renderEasterContributions();
            showNotification('Easter contribution added!');
        });

        document.getElementById('bulkEasterContribForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkEasterContribCsv').files[0];
            if (!file) return alert('Please select a CSV file.');
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvData = parseCSV(event.target.result);
                    const today = new Date().toISOString().split('T')[0];
                    const newContribs = csvData.filter(row => row.member && row.amount).map(row => ({
                        member: row.member.trim(),
                        currency: row.currency || 'ZAR',
                        amount: parseFloat(row.amount),
                        date: row.date || today,
                        notes: row.notes || ''
                    }));
                    await batchAdd('easterContributions', newContribs);
                    showNotification(`${newContribs.length} Easter contributions added.`);
                    e.target.reset();
                    renderEasterContributions();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function saveEasterTransportAmount(branch, amount) {
            if (!easterTransportBudget[branch]) easterTransportBudget[branch] = 0;
            easterTransportBudget[branch] = parseFloat(amount) || 0;
            updateData('easterTransportBudget', 'easterTransportBudget', easterTransportBudget);
            updateEasterAllTotals();
        }

        function saveEasterConferenceEssentialsAmount(item, amount) {
            if (!easterConferenceEssentials[item]) easterConferenceEssentials[item] = 0;
            easterConferenceEssentials[item] = parseFloat(amount) || 0;
            updateData('easterConferenceEssentials', 'easterConferenceEssentials', easterConferenceEssentials);
            updateEasterAllTotals();
        }

        function saveEasterSundaySchoolAmount(item, amount) {
            if (!easterSundaySchoolEssentials[item]) easterSundaySchoolEssentials[item] = 0;
            easterSundaySchoolEssentials[item] = parseFloat(amount) || 0;
            updateData('easterSundaySchoolEssentials', 'easterSundaySchoolEssentials', easterSundaySchoolEssentials);
            updateEasterAllTotals();
        }

        function saveEasterDate(date) {
            easterDate = date;
            updateData('easterDate', 'easterDate', { date });
        }

        function updateEasterAllTotals() {
            const transportTotal = Object.values(easterTransportBudget).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('easterTransportTotal').textContent = `Total Transport Budget: ${transportTotal.toFixed(2)}`;
            const confEssTotal = Object.values(easterConferenceEssentials).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('easterConferenceEssentialsTotal').textContent = `Total Conference Essentials: ${confEssTotal.toFixed(2)}`;
            const sundaySchoolTotal = Object.values(easterSundaySchoolEssentials).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('easterSundaySchoolTotal').textContent = `Total Sunday School Essentials: ${sundaySchoolTotal.toFixed(2)}`;
            const groceryTotal = calculateTotal(easterGrocery);
            document.getElementById('easterGroceryTotal').textContent = `Total Grocery: ${groceryTotal.toFixed(2)}`;
            const soundMediaTotal = calculateTotal(easterSoundMedia);
            document.getElementById('easterSoundMediaTotal').textContent = `Total Sound and Media: ${soundMediaTotal.toFixed(2)}`;
            const stageDecoTotal = calculateTotal(easterStageDeco);
            document.getElementById('easterStageDecoTotal').textContent = `Total Stage and Deco: ${stageDecoTotal.toFixed(2)}`;
            const guestPastorTotal = calculateTotal(easterGuestPastor);
            document.getElementById('easterGuestPastorTotal').textContent = `Total Guest Pastor: ${guestPastorTotal.toFixed(2)}`;
            const contribTotal = calculateTotal(easterContributions);
            document.getElementById('easterTotal').textContent = `Total Contributions: ${contribTotal.toFixed(2)}`;
            const grandTotal = transportTotal + confEssTotal + sundaySchoolTotal + groceryTotal + soundMediaTotal + stageDecoTotal + guestPastorTotal + contribTotal;
            document.getElementById('easterGrandTotal').textContent = `Grand Total: ${grandTotal.toFixed(2)}`;
        }

        // Render Easter Grocery (similar to September)
        function renderEasterGrocery() {
            const tbody = document.getElementById('easterGroceryTable').querySelector('tbody');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            easterGrocery.forEach((item) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.amount}</td>
                    <td><button class="delete-btn" onclick="deleteEasterGrocery(${item.id})">Delete</button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function deleteEasterGrocery(id) {
            deleteData('easterGrocery', id);
        }

        document.getElementById('addEasterGroceryForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const item = {
                name: document.getElementById('easterGroceryItemName').value,
                amount: parseFloat(document.getElementById('easterGroceryItemAmount').value)
            };
            addData('easterGrocery', item);
            e.target.reset();
            renderEasterGrocery();
            updateEasterAllTotals();
        });

        document.getElementById('bulkEasterGroceryForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkEasterGroceryCsv').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = parseCSV(event.target.result);
                const newItems = csvData.map(row => ({
                    name: row.item,
                    amount: parseFloat(row.amount)
                }));
                await batchAdd('easterGrocery', newItems);
                renderEasterGrocery();
                updateEasterAllTotals();
            };
            reader.readAsText(file);
        });

        // Generate Easter report (similar to September)
        document.getElementById('easterGenerateReportBtn')?.addEventListener('click', generateEasterReport);

        function generateEasterReport() {
            const transportTotal = Object.values(easterTransportBudget).reduce((sum, val) => sum + val, 0);
            const reportData = {
                date: easterDate,
                transport: easterTransportBudget,
                essentials: easterConferenceEssentials,
                sundaySchool: easterSundaySchoolEssentials,
                grocery: easterGrocery,
                soundMedia: easterSoundMedia,
                stageDeco: easterStageDeco,
                guestPastor: easterGuestPastor,
                contributions: easterContributions,
                total: calculateTotal(easterContributions) + transportTotal + Object.values(easterConferenceEssentials).reduce((sum, val) => sum + val, 0) + Object.values(easterSundaySchoolEssentials).reduce((sum, val) => sum + val, 0) + calculateTotal(easterGrocery) + calculateTotal(easterSoundMedia) + calculateTotal(easterStageDeco) + calculateTotal(easterGuestPastor)
            };
            let csvContent = `Easter Conference Report\nDate: ${reportData.date}\nGrand Total: ${reportData.total.toFixed(2)}\n\nContributions:\n`;
            csvContent += reportData.contributions.map(c => `${c.member},${c.currency},${c.amount},${c.date},${c.notes || ''}`).join('\n') + '\n\n';
            csvContent += `Transport:\n${Object.entries(reportData.transport).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Conference Essentials:\n${Object.entries(reportData.essentials).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Sunday School:\n${Object.entries(reportData.sundaySchool).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Grocery:\n${reportData.grocery.map(g => `${g.name},${g.amount}`).join('\n')}\n\n`;
            csvContent += `Sound and Media:\n${reportData.soundMedia.map(s => `${s.name},${s.amount}`).join('\n')}\n\n`;
            csvContent += `Stage and Deco:\n${reportData.stageDeco.map(s => `${s.name},${s.amount}`).join('\n')}\n\n`;
            csvContent += `Guest Pastor:\n${reportData.guestPastor.map(g => `${g.name},${g.amount}`).join('\n')}\n\n`;
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Easter_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            const report = { name: `Easter Report ${new Date().toLocaleDateString()}`, date: new Date().toISOString(), content: csvContent };
            addData('reports', report);
            addToHistory(report);
            showNotification('Easter report generated!');
        }

        function exportEasterBudget() {
            const headers = ['section', 'item', 'amount'];
            let data = [];
            Object.entries(easterTransportBudget).forEach(([branch, amount]) => data.push({ section: 'Transport', item: branch, amount: amount.toFixed(2) }));
            Object.entries(easterConferenceEssentials).forEach(([item, amount]) => data.push({ section: 'Conference Essentials', item, amount: amount.toFixed(2) }));
            Object.entries(easterSundaySchoolEssentials).forEach(([item, amount]) => data.push({ section: 'Sunday School', item, amount: amount.toFixed(2) }));
            easterGrocery.forEach(g => data.push({ section: 'Grocery', item: g.name, amount: g.amount.toFixed(2) }));
            easterSoundMedia.forEach(s => data.push({ section: 'Sound and Media', item: s.name, amount: s.amount.toFixed(2) }));
            easterStageDeco.forEach(s => data.push({ section: 'Stage and Deco', item: s.name, amount: s.amount.toFixed(2) }));
            easterGuestPastor.forEach(g => data.push({ section: 'Guest Pastor', item: g.name, amount: g.amount.toFixed(2) }));
            downloadCSV(data, 'easter_budget.csv', headers);
        }

        function emailEasterBudget() {
            const summary = `Easter Budget Grand Total: ${document.getElementById('easterGrandTotal').textContent}`;
            emailData('Easter Budget Export', summary);
        }

        // Combined Service Functions (Symmetric)
        function renderCombinedContributions() {
            const list = document.getElementById('combinedList');
            if (!list) return;
            const fragment = document.createDocumentFragment();
            combinedContributions.forEach(contrib => {
                const li = document.createElement('li');
                li.classList.add('tithe-item');
                li.innerHTML = `<strong>${contrib.member}</strong> - ${contrib.currency} ${contrib.amount} on ${contrib.date} - ${contrib.notes || ''}`;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
            const total = calculateTotal(combinedContributions);
            document.getElementById('combinedTotal').textContent = `Total: ${total.toFixed(2)}`;
        }

        document.getElementById('combinedForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const contrib = {
                member: document.getElementById('combinedMember').value,
                currency: document.getElementById('combinedCurrency').value,
                amount: parseFloat(document.getElementById('combinedAmount').value),
                date: document.getElementById('combinedDate').value || today,
                notes: document.getElementById('combinedNotes').value
            };
            addData('combinedContributions', contrib);
            e.target.reset();
            document.getElementById('combinedDate').value = today;
            renderCombinedContributions();
            showNotification('Combined contribution added!');
        });

        document.getElementById('bulkCombinedContribForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkCombinedContribCsv').files[0];
            if (!file) return alert('Please select a CSV file.');
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvData = parseCSV(event.target.result);
                    const today = new Date().toISOString().split('T')[0];
                    const newContribs = csvData.filter(row => row.member && row.amount).map(row => ({
                        member: row.member.trim(),
                        currency: row.currency || 'ZAR',
                        amount: parseFloat(row.amount),
                        date: row.date || today,
                        notes: row.notes || ''
                    }));
                    await batchAdd('combinedContributions', newContribs);
                    showNotification(`${newContribs.length} Combined contributions added.`);
                    e.target.reset();
                    renderCombinedContributions();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function saveCombinedTransportAmount(branch, amount) {
            if (!combinedTransportBudget[branch]) combinedTransportBudget[branch] = 0;
            combinedTransportBudget[branch] = parseFloat(amount) || 0;
            updateData('combinedTransportBudget', 'combinedTransportBudget', combinedTransportBudget);
            updateCombinedAllTotals();
        }

        function saveCombinedConferenceEssentialsAmount(item, amount) {
            if (!combinedConferenceEssentials[item]) combinedConferenceEssentials[item] = 0;
            combinedConferenceEssentials[item] = parseFloat(amount) || 0;
            updateData('combinedConferenceEssentials', 'combinedConferenceEssentials', combinedConferenceEssentials);
            updateCombinedAllTotals();
        }

        function saveCombinedSundaySchoolAmount(item, amount) {
            if (!combinedSundaySchoolEssentials[item]) combinedSundaySchoolEssentials[item] = 0;
            combinedSundaySchoolEssentials[item] = parseFloat(amount) || 0;
            updateData('combinedSundaySchoolEssentials', 'combinedSundaySchoolEssentials', combinedSundaySchoolEssentials);
            updateCombinedAllTotals();
        }

        function saveCombinedDate(date) {
            combinedDate = date;
            updateData('combinedDate', 'combinedDate', { date });
        }

        function updateCombinedAllTotals() {
            const transportTotal = Object.values(combinedTransportBudget).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('combinedTransportTotal').textContent = `Total Transport Budget: ${transportTotal.toFixed(2)}`;
            const confEssTotal = Object.values(combinedConferenceEssentials).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('combinedConferenceEssentialsTotal').textContent = `Total Conference Essentials: ${confEssTotal.toFixed(2)}`;
            const sundaySchoolTotal = Object.values(combinedSundaySchoolEssentials).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('combinedSundaySchoolTotal').textContent = `Total Sunday School Essentials: ${sundaySchoolTotal.toFixed(2)}`;
            const groceryTotal = calculateTotal(combinedGrocery);
            document.getElementById('combinedGroceryTotal').textContent = `Total Grocery: ${groceryTotal.toFixed(2)}`;
            const soundMediaTotal = calculateTotal(combinedSoundMedia);
            document.getElementById('combinedSoundMediaTotal').textContent = `Total Sound and Media: ${soundMediaTotal.toFixed(2)}`;
            const stageDecoTotal = calculateTotal(combinedStageDeco);
            document.getElementById('combinedStageDecoTotal').textContent = `Total Stage and Deco: ${stageDecoTotal.toFixed(2)}`;
            const guestPastorTotal = calculateTotal(combinedGuestPastor);
            document.getElementById('combinedGuestPastorTotal').textContent = `Total Guest Pastor: ${guestPastorTotal.toFixed(2)}`;
            const contribTotal = calculateTotal(combinedContributions);
            document.getElementById('combinedTotal').textContent = `Total Contributions: ${contribTotal.toFixed(2)}`;
            const grandTotal = transportTotal + confEssTotal + sundaySchoolTotal + groceryTotal + soundMediaTotal + stageDecoTotal + guestPastorTotal + contribTotal;
            document.getElementById('combinedGrandTotal').textContent = `Grand Total: ${grandTotal.toFixed(2)}`;
        }

        // Render Combined Grocery (similar)
        function renderCombinedGrocery() {
            const tbody = document.getElementById('combinedGroceryTable').querySelector('tbody');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            combinedGrocery.forEach((item) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.amount}</td>
                    <td><button class="delete-btn" onclick="deleteCombinedGrocery(${item.id})">Delete</button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function deleteCombinedGrocery(id) {
            deleteData('combinedGrocery', id);
        }

        document.getElementById('addCombinedGroceryForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const item = {
                name: document.getElementById('combinedGroceryItemName').value,
                amount: parseFloat(document.getElementById('combinedGroceryItemAmount').value)
            };
            addData('combinedGrocery', item);
            e.target.reset();
            renderCombinedGrocery();
            updateCombinedAllTotals();
        });

        document.getElementById('bulkCombinedGroceryForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkCombinedGroceryCsv').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = parseCSV(event.target.result);
                const newItems = csvData.map(row => ({
                    name: row.item,
                    amount: parseFloat(row.amount)
                }));
                await batchAdd('combinedGrocery', newItems);
                renderCombinedGrocery();
                updateCombinedAllTotals();
            };
            reader.readAsText(file);
        });

        // Generate Combined report
        document.getElementById('combinedGenerateReportBtn')?.addEventListener('click', generateCombinedReport);

        function generateCombinedReport() {
            const transportTotal = Object.values(combinedTransportBudget).reduce((sum, val) => sum + val, 0);
            const reportData = {
                date: combinedDate,
                transport: combinedTransportBudget,
                essentials: combinedConferenceEssentials,
                sundaySchool: combinedSundaySchoolEssentials,
                grocery: combinedGrocery,
                soundMedia: combinedSoundMedia,
                stageDeco: combinedStageDeco,
                guestPastor: combinedGuestPastor,
                contributions: combinedContributions,
                total: calculateTotal(combinedContributions) + transportTotal + Object.values(combinedConferenceEssentials).reduce((sum, val) => sum + val, 0) + Object.values(combinedSundaySchoolEssentials).reduce((sum, val) => sum + val, 0) + calculateTotal(combinedGrocery) + calculateTotal(combinedSoundMedia) + calculateTotal(combinedStageDeco) + calculateTotal(combinedGuestPastor)
            };
            let csvContent = `Combined Service Report\nDate: ${reportData.date}\nGrand Total: ${reportData.total.toFixed(2)}\n\nContributions:\n`;
            csvContent += reportData.contributions.map(c => `${c.member},${c.currency},${c.amount},${c.date},${c.notes || ''}`).join('\n') + '\n\n';
            csvContent += `Transport:\n${Object.entries(reportData.transport).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Conference Essentials:\n${Object.entries(reportData.essentials).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Sunday School:\n${Object.entries(reportData.sundaySchool).map(([k,v]) => `${k},${v}`).join('\n')}\n\n`;
            csvContent += `Grocery:\n${reportData.grocery.map(g => `${g.name},${g.amount}`).join('\n')}\n\n`;
            csvContent += `Sound and Media:\n${reportData.soundMedia.map(s => `${s.name},${s.amount}`).join('\n')}\n\n`;
            csvContent += `Stage and Deco:\n${reportData.stageDeco.map(s => `${s.name},${s.amount}`).join('\n')}\n\n`;
            csvContent += `Guest Pastor:\n${reportData.guestPastor.map(g => `${g.name},${g.amount}`).join('\n')}\n\n`;
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Combined_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            const report = { name: `Combined Report ${new Date().toLocaleDateString()}`, date: new Date().toISOString(), content: csvContent };
            addData('reports', report);
            addToHistory(report);
            showNotification('Combined report generated!');
        }

        function exportCombinedBudget() {
            const headers = ['section', 'item', 'amount'];
            let data = [];
            Object.entries(combinedTransportBudget).forEach(([branch, amount]) => data.push({ section: 'Transport', item: branch, amount: amount.toFixed(2) }));
            Object.entries(combinedConferenceEssentials).forEach(([item, amount]) => data.push({ section: 'Conference Essentials', item, amount: amount.toFixed(2) }));
            Object.entries(combinedSundaySchoolEssentials).forEach(([item, amount]) => data.push({ section: 'Sunday School', item, amount: amount.toFixed(2) }));
            combinedGrocery.forEach(g => data.push({ section: 'Grocery', item: g.name, amount: g.amount.toFixed(2) }));
            combinedSoundMedia.forEach(s => data.push({ section: 'Sound and Media', item: s.name, amount: s.amount.toFixed(2) }));
            combinedStageDeco.forEach(s => data.push({ section: 'Stage and Deco', item: s.name, amount: s.amount.toFixed(2) }));
            combinedGuestPastor.forEach(g => data.push({ section: 'Guest Pastor', item: g.name, amount: g.amount.toFixed(2) }));
            downloadCSV(data, 'combined_budget.csv', headers);
        }

        function emailCombinedBudget() {
            const summary = `Combined Budget Grand Total: ${document.getElementById('combinedGrandTotal').textContent}`;
            emailData('Combined Budget Export', summary);
        }

        // Events Section
        function renderEvents() {
            const list = document.getElementById('eventList');
            if (!list) return;
            const fragment = document.createDocumentFragment();
            events.sort((a, b) => new Date(a.date) - new Date(b.date));
            events.forEach(event => {
                const li = document.createElement('li');
                li.classList.add('event-item');
                li.innerHTML = `
                    <strong>${event.title}</strong> on ${event.date} at ${event.time}<br>
                    ${event.desc || ''}
                    <button class="delete-btn" onclick="deleteEvent(${event.id})">Delete</button>
                `;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
        }

        document.getElementById('eventForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const eventData = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value || today,
                time: document.getElementById('eventTime').value,
                desc: document.getElementById('eventDesc').value
            };
            addData('events', eventData);
            e.target.reset();
            document.getElementById('eventDate').value = today;
            renderEvents();
            showNotification('Event added!');
        });

        function deleteEvent(id) {
            deleteData('events', id);
        }

        function exportEvents() {
            downloadCSV(events, 'events.csv', ['title', 'date', 'time', 'desc']);
        }

        function emailEvents() {
            const summary = events.map(e => `${e.title} - ${e.date} ${e.time}`).join('\n');
            emailData('Church Events', summary);
        }

        // Members Section
        function renderMembers() {
            const tbody = document.getElementById('memberTable').querySelector('tbody');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            members.forEach(member => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.branch}</td>
                    <td>${member.email}</td>
                    <td>${member.cell}</td>
                    <td>${member.address}</td>
                    <td>${member.joinDate}</td>
                    <td>${member.role}</td>
                    <td><button class="delete-btn" onclick="deleteMember(${member.id})">Delete</button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
            populateWhatsAppSelect();
            populateBroadcastSelect();
        }

        document.getElementById('memberForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const member = {
                name: document.getElementById('name').value,
                branch: document.getElementById('branch').value,
                email: document.getElementById('email').value,
                cell: document.getElementById('cell').value,
                address: document.getElementById('address').value,
                joinDate: document.getElementById('joinDate').value || today,
                role: document.getElementById('role').value
            };
            addData('members', member);
            e.target.reset();
            document.getElementById('joinDate').value = today;
            renderMembers();
            showNotification('Member added!');
        });

        document.getElementById('bulkMemberForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkCsv').files[0];
            if (!file) return alert('Please select a CSV file.');
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvData = parseCSV(event.target.result);
                    const today = new Date().toISOString().split('T')[0];
                    const newMembers = csvData.filter(row => row.name && row.email).map(row => ({
                        name: row.name.trim(),
                        branch: row.branch || '',
                        email: row.email.trim(),
                        cell: row.cell || '',
                        address: row.address || '',
                        joinDate: row.joinDate || today,
                        role: row.role || 'Member'
                    }));
                    await batchAdd('members', newMembers);
                    showNotification(`${newMembers.length} members added.`);
                    e.target.reset();
                    renderMembers();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function deleteMember(id) {
            deleteData('members', id);
        }

        function exportMembers() {
            downloadCSV(members, 'members.csv', ['name', 'branch', 'email', 'cell', 'address', 'joinDate', 'role']);
        }

        function emailMembers() {
            const summary = members.map(m => `${m.name} - ${m.email} - ${m.cell}`).join('\n');
            emailData('Member Directory', summary);
        }

        // Search for members
        document.getElementById('memberSearch')?.addEventListener('input', debounce((e) => {
            const term = e.target.value.toLowerCase();
            const tbody = document.getElementById('memberTable').querySelector('tbody');
            members.forEach(member => {
                const row = tbody.querySelector(`[data-id="${member.id}"]`);
                if (row) {
                    const matches = [member.name, member.email, member.cell, member.address, member.role].some(field => field.toLowerCase().includes(term));
                    row.style.display = matches ? '' : 'none';
                }
            });
        }));

        // Visitors Section
        function renderVisitors() {
            const tbody = document.getElementById('visitorTable').querySelector('tbody');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            visitors.forEach(visitor => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${visitor.name}</td>
                    <td>${visitor.branch}</td>
                    <td>${visitor.email}</td>
                    <td>${visitor.cell}</td>
                    <td>${visitor.address}</td>
                    <td>${visitor.visitDate}</td>
                    <td>${visitor.notes}</td>
                    <td>${visitor.status || 'New'}</td>
                    <td><button class="convert-btn" onclick="convertVisitor(${visitor.id})">Convert</button> <button class="delete-btn" onclick="deleteVisitor(${visitor.id})">Delete</button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
            populateVisitorWhatsAppSelect();
            updateAnalytics();
        }

        document.getElementById('visitorForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const visitor = {
                name: document.getElementById('visitorName').value,
                branch: document.getElementById('visitorBranch').value,
                email: document.getElementById('visitorEmail').value,
                cell: document.getElementById('visitorCell').value,
                address: document.getElementById('visitorAddress').value,
                visitDate: document.getElementById('visitorVisitDate').value || today,
                notes: document.getElementById('visitorNotes').value,
                status: 'New'
            };
            addData('visitors', visitor);
            e.target.reset();
            document.getElementById('visitorVisitDate').value = today;
            renderVisitors();
            showNotification('Visitor added!');
        });

        document.getElementById('bulkVisitorForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkVisitorCsv').files[0];
            if (!file) return alert('Please select a CSV file.');
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvData = parseCSV(event.target.result);
                    const today = new Date().toISOString().split('T')[0];
                    const newVisitors = csvData.filter(row => row.name && row.cell).map(row => ({
                        name: row.name.trim(),
                        branch: row.branch || '',
                        email: row.email || '',
                        cell: row.cell.trim(),
                        address: row.address || '',
                        visitDate: row.visitDate || today,
                        notes: row.notes || '',
                        status: 'New'
                    }));
                    await batchAdd('visitors', newVisitors);
                    showNotification(`${newVisitors.length} visitors added.`);
                    e.target.reset();
                    renderVisitors();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function deleteVisitor(id) {
            deleteData('visitors', id);
        }

        function convertVisitor(id) {
            const visitor = visitors.find(v => v.id === id);
            if (visitor) {
                const member = { ...visitor, role: 'Member', joinDate: visitor.visitDate };
                addData('members', member);
                visitor.status = 'Converted';
                updateData('visitors', id, visitor);
                showNotification('Visitor converted to member!');
            }
        }

        function exportVisitors() {
            downloadCSV(visitors, 'visitors.csv', ['name', 'branch', 'email', 'cell', 'address', 'visitDate', 'notes', 'status']);
        }

        function emailVisitors() {
            const summary = visitors.map(v => `${v.name} - ${v.cell} - ${v.visitDate}`).join('\n');
            emailData('Visitor Directory', summary);
        }

        // Search for visitors
        document.getElementById('visitorSearch')?.addEventListener('input', debounce((e) => {
            const term = e.target.value.toLowerCase();
            const tbody = document.getElementById('visitorTable').querySelector('tbody');
            visitors.forEach(visitor => {
                const row = tbody.querySelector(`[data-id="${visitor.id}"]`);
                if (row) {
                    const matches = [visitor.name, visitor.email, visitor.cell, visitor.address, visitor.branch].some(field => field.toLowerCase().includes(term));
                    row.style.display = matches ? '' : 'none';
                }
            });
        }));

        // Follow-ups
        function renderVisitorFollowUps() {
            const list = document.getElementById('followUpList');
            if (!list) return;
            const fragment = document.createDocumentFragment();
            visitorFollowUps.forEach(fu => {
                const li = document.createElement('li');
                li.classList.add('follow-up-item');
                li.innerHTML = `
                    <strong>${fu.visitorName}</strong> - Status: ${fu.status} on ${fu.date}<br>
                    Notes: ${fu.notes}<br>
                    <a href="https://wa.me/${formatPhone(fu.cell)}" class="whatsapp-link" target="_blank">WhatsApp</a>
                    <button class="delete-btn" onclick="deleteFollowUp(${fu.id})">Delete</button>
                `;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
        }

        document.getElementById('followUpForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const visitor = visitors.find(v => v.name === document.getElementById('followUpVisitorSelect').value);
            if (!visitor) return alert('Select a visitor.');
            const today = new Date().toISOString().split('T')[0];
            const fu = {
                visitorName: visitor.name,
                status: document.getElementById('followUpStatus').value,
                date: document.getElementById('followUpDate').value || today,
                reminderDate: document.getElementById('followUpReminderDate').value,
                notes: document.getElementById('followUpNotes').value,
                cell: visitor.cell
            };
            addData('visitorFollowUps', fu);
            // Update visitor status
            visitor.status = fu.status;
            updateData('visitors', visitor.id, visitor);
            e.target.reset();
            document.getElementById('followUpDate').value = today;
            renderVisitorFollowUps();
            renderVisitors();
            showNotification('Follow-up logged!');
        });

        function populateFollowUpVisitorSelect() {
            const select = document.getElementById('followUpVisitorSelect');
            if (!select) return;
            select.innerHTML = visitors.map(v => `<option value="${v.name}">${v.name} (${v.cell})</option>`).join('');
        }

        function deleteFollowUp(id) {
            deleteData('visitorFollowUps', id);
        }

        function exportFollowUps() {
            downloadCSV(visitorFollowUps, 'follow_ups.csv', ['visitorName', 'status', 'date', 'reminderDate', 'notes', 'cell']);
        }

        function emailFollowUps() {
            const summary = visitorFollowUps.map(fu => `${fu.visitorName} - ${fu.status} - ${fu.date}`).join('\n');
            emailData('Visitor Follow-ups', summary);
        }

        // Reminders
        function renderVisitorReminders() {
            const list = document.getElementById('reminderList');
            if (!list) return;
            const today = new Date().toISOString().split('T')[0];
            const fragment = document.createDocumentFragment();
            visitorReminders.forEach(rem => {
                const li = document.createElement('li');
                li.classList.add('reminder-item');
                const reminderDate = new Date(rem.reminderDate);
                const isDue = reminderDate.toISOString().split('T')[0] === today;
                const isOverdue = reminderDate < new Date(today);
                if (isDue) li.classList.add('due');
                if (isOverdue) li.classList.add('overdue');
                li.innerHTML = `
                    <strong>${rem.visitorName}</strong> - Reminder: ${rem.reminderDate}<br>
                    Notes: ${rem.notes}<br>
                    <a href="https://wa.me/${formatPhone(rem.cell)}" class="whatsapp-link" target="_blank">Send WhatsApp</a>
                    <button class="delete-btn" onclick="deleteReminder(${rem.id})">Delete</button>
                `;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
        }

        function checkReminders() {
            const today = new Date().toISOString().split('T')[0];
            visitorReminders.forEach(rem => {
                if (new Date(rem.reminderDate).toISOString().split('T')[0] === today && !rem.sent) {
                    // Mark as sent or notify
                    rem.sent = true;
                    updateData('visitorReminders', rem.id, rem);
                    showNotification(`Reminder due for ${rem.visitorName}`);
                }
            });
            renderVisitorReminders();
        }

        function bulkSendDueReminders() {
            const today = new Date().toISOString().split('T')[0];
            const dueReminders = visitorReminders.filter(rem => new Date(rem.reminderDate).toISOString().split('T')[0] === today && !rem.sent);
            dueReminders.forEach(rem => {
                // Simulate send
                window.open(`https://wa.me/${formatPhone(rem.cell)}?text=Reminder: ${rem.notes}`);
                rem.sent = true;
                updateData('visitorReminders', rem.id, rem);
            });
            showNotification(`${dueReminders.length} reminders sent!`);
            renderVisitorReminders();
        }

        function deleteReminder(id) {
            deleteData('visitorReminders', id);
        }

        function exportReminders() {
            downloadCSV(visitorReminders, 'reminders.csv', ['visitorName', 'reminderDate', 'notes', 'cell', 'sent']);
        }

        function emailReminders() {
            const summary = visitorReminders.map(r => `${r.visitorName} - ${r.reminderDate}`).join('\n');
            emailData('Visitor Reminders', summary);
        }

        // Visitor WhatsApp
        function populateVisitorWhatsAppSelect() {
            const select = document.getElementById('visitorWhatsAppSelect');
            if (!select) return;
            select.innerHTML = visitors.map(v => `<option value="${v.name}">${v.name} (${v.cell})</option>`).join('');
        }

        function fillVisitorTemplate(template) {
            const selectValue = document.getElementById('visitorWhatsAppSelect').value;
            const visitor = visitors.find(v => v.name === selectValue);
            let message = template.replace('[Name]', visitor ? visitor.name : '[Name]');
            message = message.replace('[Date]', new Date().toLocaleDateString());
            message = message.replace('[Link]', 'https://church-link.com');
            document.getElementById('visitorWhatsAppMessage').value = message;
        }

        document.getElementById('visitorWhatsAppForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectValue = document.getElementById('visitorWhatsAppSelect').value;
            const visitor = visitors.find(v => v.name === selectValue);
            if (!visitor) return alert('Select a visitor.');
            const message = document.getElementById('visitorWhatsAppMessage').value;
            const whatsappUrl = `https://wa.me/${formatPhone(visitor.cell)}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            // Log interaction
            const interaction = {
                type: 'visitor',
                recipient: visitor.name,
                cell: visitor.cell,
                message: message,
                date: new Date().toISOString()
            };
            addData('whatsappInteractions', interaction);
            renderWhatsAppInteractions();
            e.target.reset();
            showNotification('Message sent to WhatsApp!');
        });

        // Generate Visitor Report
        document.getElementById('generateVisitorReportBtn')?.addEventListener('click', generateVisitorReport);

        function generateVisitorReport() {
            const totalVisitors = visitors.length;
            const converted = visitors.filter(v => v.status === 'Converted').length;
            const pending = visitors.filter(v => v.status !== 'Converted').length;
            let csvContent = `Visitors Report\nTotal Visitors: ${totalVisitors}\nConverted: ${converted}\nPending: ${pending}\nConversion Rate: ${((converted / totalVisitors) * 100).toFixed(2)}%\n\nVisitors:\n`;
            csvContent += visitors.map(v => `${v.name},${v.branch},${v.email},${v.cell},${v.visitDate},${v.status || 'New'}`).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Visitors_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            const report = { name: `Visitors Report ${new Date().toLocaleDateString()}`, date: new Date().toISOString(), content: csvContent };
            addData('visitorReports', report);
            addToHistory(report);
            showNotification('Visitors report generated!');
        }

        // Analytics
        function updateAnalytics() {
            const totalVisitorsEl = document.getElementById('totalVisitors');
            const totalConvertedEl = document.getElementById('totalConverted');
            const conversionRateEl = document.getElementById('conversionRate');
            const pendingFollowUpsEl = document.getElementById('pendingFollowUps');

            const totalVisitors = visitors.length;
            const converted = visitors.filter(v => v.status === 'Converted').length;
            const conversionRate = totalVisitors > 0 ? ((converted / totalVisitors) * 100).toFixed(1) : 0;
            const pending = visitorFollowUps.filter(fu => fu.status === 'Contacted' || fu.status === 'Interested').length;

            totalVisitorsEl.textContent = totalVisitors;
            totalConvertedEl.textContent = converted;
            conversionRateEl.textContent = `${conversionRate}%`;
            pendingFollowUpsEl.textContent = pending;

            // Charts
            updateVisitorsChart();
            updateConversionChart();
        }

        function updateVisitorsChart() {
            const ctx = document.getElementById('visitorsChart')?.getContext('2d');
            if (!ctx) return;
            const monthlyData = {};
            visitors.forEach(v => {
                const month = new Date(v.visitDate).toLocaleDateString('en-CA', { month: 'short', year: 'numeric' });
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(monthlyData),
                    datasets: [{ label: 'Visitors', data: Object.values(monthlyData), borderColor: '#3498db' }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function updateConversionChart() {
            const ctx = document.getElementById('conversionChart')?.getContext('2d');
            if (!ctx) return;
            const statusCounts = visitors.reduce((acc, v) => {
                acc[v.status || 'New'] = (acc[v.status || 'New'] || 0) + 1;
                return acc;
            }, {});
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#3498db', '#27ae60', '#e74c3c', '#f39c12'] }]
                }
            });
        }

        // Tithe Section
        function renderTithes() {
            const list = document.getElementById('titheList');
            if (!list) return;
            const fragment = document.createDocumentFragment();
            tithes.forEach(tithe => {
                const li = document.createElement('li');
                li.classList.add('tithe-item');
                li.innerHTML = `
                    <strong>${tithe.member}</strong> - ${tithe.currency} ${tithe.amount} (${tithe.type}) on ${tithe.date}
                    <button class="delete-btn" onclick="deleteTithe(${tithe.id})">Delete</button>
                `;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
            const total = calculateTotal(tithes);
            document.getElementById('titheTotal').textContent = `Total: ${total.toFixed(2)}`;
            populateTitheMemberSelect();
        }

        document.getElementById('titheForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const tithe = {
                member: document.getElementById('memberName').value,
                currency: document.getElementById('titheCurrency').value,
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('titheDate').value || today,
                type: document.getElementById('titheType').value
            };
            addData('tithes', tithe);
            e.target.reset();
            document.getElementById('titheDate').value = today;
            renderTithes();
            showNotification('Tithe added!');
        });

        document.getElementById('bulkTitheForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('bulkTitheCsv').files[0];
            if (!file) return alert('Please select a CSV file.');
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvData = parseCSV(event.target.result);
                    const today = new Date().toISOString().split('T')[0];
                    const newTithes = csvData.filter(row => row.member && row.amount).map(row => ({
                        member: row.member.trim(),
                        currency: row.currency || 'ZAR',
                        amount: parseFloat(row.amount),
                        date: row.date || today,
                        type: row.type || 'Tithe'
                    }));
                    await batchAdd('tithes', newTithes);
                    showNotification(`${newTithes.length} tithes added.`);
                    e.target.reset();
                    renderTithes();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function deleteTithe(id) {
            deleteData('tithes', id);
        }

        function populateTitheMemberSelect() {
            const select = document.getElementById('titheMemberSelect');
            if (!select) return;
            select.innerHTML = tithes.map(t => `<option value="${t.member}">${t.member} (Recent: ${t.currency} ${t.amount})</option>`).join('');
        }

        function fillTitheTemplate(template) {
            const selectValue = document.getElementById('titheMemberSelect').value;
            const tithe = tithes.find(t => t.member === selectValue);
            let message = template.replace('[Name]', selectValue);
            message = message.replace('[Amount]', tithe ? `${tithe.currency} ${tithe.amount}` : '[Amount]');
            document.getElementById('titheWhatsAppMessage').value = message;
        }

        document.getElementById('titheWhatsAppForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectValue = document.getElementById('titheMemberSelect').value;
            const member = members.find(m => m.name === selectValue) || { cell: '' }; // Assume member has cell
            if (!member.cell) return alert('Member cell not found.');
            const message = document.getElementById('titheWhatsAppMessage').value;
            const whatsappUrl = `https://wa.me/${formatPhone(member.cell)}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            const interaction = {
                type: 'tithe',
                recipient: selectValue,
                cell: member.cell,
                message: message,
                date: new Date().toISOString()
            };
            addData('whatsappInteractions', interaction);
            renderWhatsAppInteractions();
            e.target.reset();
            showNotification('Message sent!');
        });

        document.getElementById('generateTitheReportBtn')?.addEventListener('click', generateTitheReport);

        function generateTitheReport() {
            const total = calculateTotal(tithes);
            let csvContent = `Tithe Report\nTotal: ${total.toFixed(2)}\n\nTithes:\n`;
            csvContent += tithes.map(t => `${t.member},${t.currency},${t.amount},${t.date},${t.type}`).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Tithe_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            const report = { name: `Tithe Report ${new Date().toLocaleDateString()}`, date: new Date().toISOString(), content: csvContent };
            addData('titheReports', report);
            addToHistory(report);
            showNotification('Tithe report generated!');
        }

        // WhatsApp Interactions
        function renderWhatsAppInteractions() {
            const list = document.getElementById('whatsappList');
            if (!list) return;
            const fragment = document.createDocumentFragment();
            whatsappInteractions.forEach(inter => {
                const li = document.createElement('li');
                li.classList.add('whatsapp-item');
                li.innerHTML = `
                    <div class="whatsapp-item-details">
                        <strong>${inter.recipient}</strong> - ${inter.date}<br>
                        ${inter.message.substring(0, 50)}...
                    </div>
                    <a href="https://wa.me/${formatPhone(inter.cell)}" class="whatsapp-btn" target="_blank">View</a>
                `;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
        }

        function populateWhatsAppSelect() {
            const select = document.getElementById('whatsappMemberSelect');
            if (!select) return;
            select.innerHTML = members.map(m => `<option value="${m.name}">${m.name} (${m.cell})</option>`).join('');
        }

        function fillTemplate(template) {
            const selectValue = document.getElementById('whatsappMemberSelect').value;
            const member = members.find(m => m.name === selectValue);
            let message = template.replace('[Name]', selectValue);
            document.getElementById('whatsappMessage').value = message;
        }

        document.getElementById('whatsappForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectValue = document.getElementById('whatsappMemberSelect').value;
            const member = members.find(m => m.name === selectValue);
            if (!member) return alert('Select a member.');
            const message = document.getElementById('whatsappMessage').value;
            const whatsappUrl = `https://wa.me/${formatPhone(member.cell)}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            const interaction = {
                type: 'individual',
                recipient: selectValue,
                cell: member.cell,
                message: message,
                date: new Date().toISOString()
            };
            addData('whatsappInteractions', interaction);
            e.target.reset();
            renderWhatsAppInteractions();
            showNotification('Message sent!');
        });

        function populateBroadcastSelect() {
            const select = document.getElementById('broadcastMembers');
            if (!select) return;
            select.innerHTML = members.map(m => `<option value="${m.name}">${m.name} (${m.cell})</option>`).join('');
        }

        function selectAllMembers() {
            const select = document.getElementById('broadcastMembers');
            for (let option of select.options) {
                option.selected = true;
            }
        }

        function fillBroadcastTemplate(template) {
            document.getElementById('broadcastMessage').value = template.replace('[Name]', '[All Members]');
        }

        document.getElementById('broadcastForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const selected = Array.from(document.getElementById('broadcastMembers').selectedOptions).map(opt => opt.value);
            const message = document.getElementById('broadcastMessage').value;
            selected.forEach(name => {
                const member = members.find(m => m.name === name);
                if (member) {
                    const whatsappUrl = `https://wa.me/${formatPhone(member.cell)}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    const interaction = {
                        type: 'broadcast',
                        recipient: name,
                        cell: member.cell,
                        message: message,
                        date: new Date().toISOString()
                    };
                    addData('whatsappInteractions', interaction);
                }
            });
            showNotification(`Broadcast sent to ${selected.length} members!`);
            e.target.reset();
            renderWhatsAppInteractions();
        });

        // Contributor Messages
        function populateContributorSelect() {
            const conference = document.getElementById('conferenceSelect').value;
            let contributions = [];
            if (conference === 'easter') contributions = easterContributions;
            else if (conference === 'september') contributions = septemberContributions;
            else if (conference === 'combined') contributions = combinedContributions;
            const select = document.getElementById('contributorSelect');
            if (!select) return;
            select.innerHTML = contributions.map(c => `<option value="${c.member}">${c.member} (${c.currency} ${c.amount})</option>`).join('');
        }

        function fillContributorTemplate(template) {
            const conference = document.getElementById('conferenceSelect').value;
            const selectValue = document.getElementById('contributorSelect').value;
            let contrib = {};
            if (conference === 'easter') contrib = easterContributions.find(c => c.member === selectValue);
            else if (conference === 'september') contrib = septemberContributions.find(c => c.member === selectValue);
            else if (conference === 'combined') contrib = combinedContributions.find(c => c.member === selectValue);
            let message = template.replace('[Name]', selectValue);
            message = message.replace('[Amount]', contrib ? `${contrib.currency} ${contrib.amount}` : '[Amount]');
            message = message.replace('[Conference]', conference.charAt(0).toUpperCase() + conference.slice(1));
            document.getElementById('contributorWhatsAppMessage').value = message;
        }

        document.getElementById('contributorWhatsAppForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const conference = document.getElementById('conferenceSelect').value;
            const selectValue = document.getElementById('contributorSelect').value;
            let contrib = {};
            if (conference === 'easter') contrib = easterContributions.find(c => c.member === selectValue);
            else if (conference === 'september') contrib = septemberContributions.find(c => c.member === selectValue);
            else if (conference === 'combined') contrib = combinedContributions.find(c => c.member === selectValue);
            if (!contrib) return alert('Contributor not found.');
            // Assume member cell from members
            const member = members.find(m => m.name === selectValue);
            if (!member?.cell) return alert('Cell not found.');
            const message = document.getElementById('contributorWhatsAppMessage').value;
            const whatsappUrl = `https://wa.me/${formatPhone(member.cell)}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            const interaction = {
                type: 'contributor',
                recipient: selectValue,
                cell: member.cell,
                message: message,
                conference: conference,
                date: new Date().toISOString()
            };
            addData('whatsappInteractions', interaction);
            e.target.reset();
            renderWhatsAppInteractions();
            showNotification('Contributor message sent!');
        });

        function exportWhatsAppInteractions() {
            downloadCSV(whatsappInteractions, 'whatsapp_interactions.csv', ['type', 'recipient', 'cell', 'message', 'date']);
        }

        function emailWhatsAppInteractions() {
            const summary = whatsappInteractions.slice(-10).map(i => `${i.type}: ${i.recipient} - ${i.date}`).join('\n');
            emailData('WhatsApp Interactions', summary);
        }

        // Vault / History
        function renderHistory() {
            const list = document.getElementById('historyList');
            if (!list) return;
            const fragment = document.createDocumentFragment();
            historyReports.sort((a, b) => new Date(b.date) - new Date(a.date));
            historyReports.forEach(report => {
                const li = document.createElement('li');
                li.classList.add('history-report-item');
                li.innerHTML = `
                    <strong>${report.name}</strong> - ${new Date(report.date).toLocaleDateString()}<br>
                    <button class="report-download-btn" onclick="downloadReport('${report.content}')">Download</button>
                    <button class="report-delete-btn" onclick="deleteHistoryReport(${report.id})">Delete</button>
                `;
                fragment.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(fragment);
        }

        function addToHistory(report) {
            addData('historyReports', report);
        }

        function downloadReport(content) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function deleteHistoryReport(id) {
            deleteData('historyReports', id);
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            section.classList.toggle('active');
        }

        // Church Admin (basic implementation for leaders, etc.)
        function renderLeaders() {
            // Placeholder - implement similar to members
            const content = document.querySelector('#leaders-folder .folder-content');
            if (!content) return;
            content.innerHTML = '<p>Leaders management placeholder. Implement form and table similar to members.</p>';
        }

        // Similar for elders, pastors, etc. - omitted for brevity

        // Folder actions (print, minimize)
        function printFolder(folderId) {
            const folder = document.getElementById(folderId + '-folder');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(folder.outerHTML);
            printWindow.document.close();
            printWindow.print();
        }

        function toggleFolder(folderId) {
            const details = document.getElementById(folderId + '-folder');
            details.open = !details.open;
        }

        // Initialize on load
        if (db) {
            loadAllData();
        }

        // Event listeners for folders (minimize, etc.) are already in HTML onclicks
    </script>
</body>
</html>
